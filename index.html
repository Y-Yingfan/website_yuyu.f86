<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>旅游人生選物代購｜Select Shop</title>
<style>
  /* ===== 色系（大地色） ===== */
  :root{
    --bg:#f7f3ef;            /* 背景奶油米色 */
    --paper:#fffdf9;         /* 面板紙色 */
    --card:#ffffff;          /* 卡片白 */
    --ink:#2b2b2b;           /* 文字深灰 */
    --muted:#7a7267;         /* 次要字 */
    --brand:#8B5E34;         /* 主色：棕咖 */
    --brand-2:#C2A27A;       /* 輔色：燕麥金 */
    --accent:#7F8C5B;        /* 點綴：鼠尾草綠 */
    --border:#eadfcd;        /* 邊框淡卡其 */
    --shadow: 0 12px 30px rgba(139,94,52,.08);
    --radius:16px;
    --maxw:1100px;
    --gap:16px;
    --thumb-h:180px;         /* 縮圖高度 */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#f8f5f1 0%, var(--bg) 100%);color:var(--ink);
       font-family: ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial;}
  a{color:var(--brand)}
  img{display:block}

  /* ===== 頂部 ===== */
  .topbar{position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(6px);
          background:rgba(247,243,239,.75); border-bottom:1px solid var(--border);}
  .wrap{max-width:var(--maxw); margin:0 auto; padding:14px 18px;}
  .row{display:flex; align-items:center; justify-content:space-between; gap:12px;}
  .brand{display:flex; align-items:center; gap:12px;}
  .brand img{width:42px; height:42px; object-fit:contain}
  .title{font-weight:800; letter-spacing:.3px}
  .subtitle{font-weight:700; color:var(--brand)}
  @media (max-width:640px){ .title{font-size:20px} .subtitle{display:none} }

  /* ===== 工具列 ===== */
  #toolbar{display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:8px}
  #toolbar input, #toolbar select{
    padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#fffdfa; color:var(--ink);
    box-shadow: 0 2px 0 rgba(0,0,0,.02);
  }

  /* ===== 內容 ===== */
  .container{max-width:var(--maxw); margin:18px auto; padding:0 18px}
  #productList{
    display:grid; grid-template-columns: repeat(auto-fill, minmax(210px,1fr)); gap:var(--gap);
  }
  .card{
    border:1px solid var(--border); border-radius:var(--radius); background:var(--card);
    overflow:hidden; box-shadow:var(--shadow); transition: transform .08s ease, box-shadow .2s ease; cursor:pointer;
  }
  .card:hover{transform: translateY(-2px); box-shadow: 0 18px 40px rgba(139,94,52,.12)}
  .thumb{height:var(--thumb-h); background:#f2eee7; display:flex; align-items:center; justify-content:center}
  .thumb img{width:100%; height:100%; object-fit:cover}
  .pad{padding:12px 14px}
  .name{font-size:14px; line-height:1.35; margin:0 0 6px; color:#1d1c1a}
  .price{color:#b03c2f; font-weight:800}
  .orig{margin-left:6px; color:#a9a094; text-decoration:line-through; font-weight:500}
  .cat{margin-top:4px; font-size:12px; color:var(--muted)}

  /* ===== Loading / Empty ===== */
  #loading{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; color:var(--muted)}
  #emptyTip{color:var(--muted); text-align:center}

  /* ===== 詳情 Modal ===== */
  .modal{display:none; position:fixed; inset:0; z-index:1000}
  .overlay{position:absolute; inset:0; background:rgba(0,0,0,.45)}
  .panel{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:min(980px,92vw); max-height:88vh; overflow:auto;
    background:var(--paper); border:1px solid var(--border); border-radius:22px; box-shadow:var(--shadow);
    display:grid; grid-template-columns:1fr 1fr; gap:22px; padding:20px;
  }
  @media (max-width:820px){ .panel{grid-template-columns:1fr} }
  .bigimg{width:100%; aspect-ratio:4/3; background:#f2eee7; border-radius:14px; overflow:hidden}
  .bigimg img{width:100%; height:100%; object-fit:cover}
  .detail h2{margin:0 0 8px}
  .muted{color:var(--muted)}
  .tag{display:inline-block; padding:3px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; margin-right:6px}
  .btnrow{display:flex; gap:10px; margin-top:14px}
  .btn{border:none; border-radius:12px; padding:12px 16px; font-size:14px; cursor:pointer; box-shadow:var(--shadow)}
  .btn.copy{background:#f4efe7}
  .btn.ask{background:var(--brand); color:#fff}

  /* ===== 連結選單 Modal（詢問/下單） ===== */
  .modal-sm .panel{width:min(520px,92vw); grid-template-columns:1fr}
  .linkBox{display:flex; gap:12px; flex-direction:column}
  .linkBtn{
    display:flex; justify-content:space-between; align-items:center; text-decoration:none; padding:14px 16px; border-radius:14px;
    border:1px solid var(--border); background:#fff; color:var(--ink); box-shadow:var(--shadow)
  }
  .linkBtn .l{display:flex; align-items:center; gap:10px}
  .dot{width:10px; height:10px; border-radius:999px}
  .dot.green{background:#00B900}
  .dot.blue{background:#4f7dbf}
  .linkBtn:hover{background:#fffaf2}

  /* ===== 加好友頁 ===== */
  #addFriendPage{display:none; text-align:center}
  #addFriendPage a{display:inline-block; margin:12px 0; padding:10px 16px; background:var(--brand); color:#fff; border-radius:12px; text-decoration:none}
  #addFriendPage button{padding:10px 16px; border:1px solid var(--border); background:#fff; border-radius:10px; cursor:pointer}
</style>
</head>
<body>
  <!-- Sticky topbar -->
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <!-- 將 LOGO.png 放在同一資料夾 -->
          <img src="LOGO.png" alt="logo" />
          <div>
            <div class="title" style="font-size:22px;">旅游人生選物代購</div>
            <div class="subtitle">Select Shop</div>
          </div>
        </div>
        <div id="toolbar">
          <input type="text" id="searchInput" placeholder="搜尋商品…" />
          <select id="categoryFilter"><option value="">全部分類</option></select>
          <select id="sortSelect">
            <option value="newest">上架時間：新到舊</option>
            <option value="oldest">上架時間：舊到新</option>
            <option value="priceAsc">價格：低到高</option>
            <option value="priceDesc">價格：高到低</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading">載入中…</div>

  <!-- Add-friend Page -->
  <div id="addFriendPage" class="container">
    <h2>加入官方帳號</h2>
    <p class="muted">尚未加入官方帳號，請點下方按鈕加入；加入後再點「我已加入」。</p>
    <a href="https://line.me/R/ti/p/@958xfkot" target="_blank">➡️ 點此加入官方 LINE</a><br/>
    <button id="btnCheckFriend">我已加入</button>
  </div>

  <!-- Shop -->
  <div id="shopPage" class="container" style="display:none">
    <div id="productList"></div>
    <p id="emptyTip" class="muted" style="display:none;margin-top:12px">目前沒有商品</p>
  </div>

  <!-- 詳情 Modal -->
  <div id="detailModal" class="modal">
    <div class="overlay"></div>
    <div class="panel">
      <div class="bigimg"><img id="dImg" alt=""></div>
      <div class="detail">
        <h2 id="dName"></h2>
        <div class="muted" id="dId"></div>
        <div style="margin:10px 0 4px">
          <span class="price" id="dPrice"></span>
          <span class="orig" id="dOrig"></span>
        </div>
        <div id="dMeta" class="muted"></div>
        <div id="dEta" class="muted" style="margin-top:6px"></div>
        <div id="dTags" style="margin:10px 0"></div>
        <div class="btnrow">
          <button class="btn copy" id="btnCopy">複製下單格式</button>
          <button class="btn ask" id="btnAsk">詢問／下單</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 連結選單 Modal（官方/社群） -->
  <div id="linksModal" class="modal modal-sm">
    <div class="overlay"></div>
    <div class="panel">
      <div>
        <h3 style="margin:0 0 12px">選擇聯絡方式</h3>
        <p class="muted" style="margin:0 0 12px">下單系統尚在建置，請先用以下任一方式與我聯繫：</p>
        <div class="linkBox">
          <a class="linkBtn" target="_blank" href="https://line.me/R/ti/p/@958xfkot">
            <div class="l"><span class="dot green"></span><strong>官方 LINE</strong></div>
            <span class="muted">點擊加入</span>
          </a>
          <a class="linkBtn" target="_blank" href="https://line.me/ti/g2/fRmTHOkmCy8ite62TzDencHTqlruXj6um0DT7g">
            <div class="l"><span class="dot blue"></span><strong>LINE 社群</strong></div>
            <span class="muted">密碼：0628</span>
          </a>
        </div>
        <div style="text-align:right; margin-top:14px">
          <button id="linksClose" class="btn" style="background:#fffaf2">關閉</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SDKs -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ===== Supabase ===== */
    const supabaseUrl = 'https://llbpmqyjigovxixeohzr.supabase.co';
    const supabaseKey = 'sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
    const BUCKET = 'yuyu.f86';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    /* ===== State ===== */
    let productsData = [];
    let OPTIONS = { categories: [] };

    /* ===== Helpers ===== */
    function publicUrlFromPath(path){
      if(!path) return '';
      const { data } = supabaseClient.storage.from(BUCKET).getPublicUrl(path);
      return data?.publicUrl || '';
    }
    function fmt(n){ if(n==null) return ''; return 'NT$' + Number(n||0).toLocaleString('zh-TW'); }
    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    function byNew(a,b){ if(a.created_at && b.created_at) return new Date(b.created_at)-new Date(a.created_at); if(a.id&&b.id) return b.id-a.id; return 0; }

    /* ===== Build UI ===== */
    function cardHTML(p){
      const img = p.img_url || (Array.isArray(p.images)&&p.images[0] ? publicUrlFromPath(p.images[0]) : '');
      const price = `<span class="price">${fmt(p.price)}</span>`;
      return `
      <div class="card" data-id="${p.id}">
        <div class="thumb">${img ? `<img src="${img}" alt="${escapeHtml(p.name||'')}" loading="lazy">` : ''}</div>
        <div class="pad">
          <p class="name">${escapeHtml(p.name||'未命名')}</p>
          <div>${price}</div>
          ${p.category? `<div class="cat">${escapeHtml(p.category)}</div>`:''}
        </div>
      </div>`;
    }
    function renderList(list){
      const box=document.getElementById('productList'), empty=document.getElementById('emptyTip');
      if(!list||list.length===0){ box.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none'; box.innerHTML=list.map(cardHTML).join('');
    }

    /* ===== Filters ===== */
    function applyFilters(){
      const kw=(document.getElementById('searchInput').value||'').toLowerCase();
      const cat=document.getElementById('categoryFilter').value;
      const sort=document.getElementById('sortSelect').value;

      let list=productsData.filter(p=>{
        const text=`${p.name||''} ${(p.eta_text||'')} ${(Array.isArray(p.tags)?p.tags.join(','):(p.tags||''))}`.toLowerCase();
        const hitKw=!kw||text.includes(kw);
        const hitCat=!cat||p.category===cat;
        return hitKw&&hitCat;
      });
      if(sort==='priceAsc') list.sort((a,b)=>(+a.price||0)-(+b.price||0));
      else if(sort==='priceDesc') list.sort((a,b)=>(+b.price||0)-(+a.price||0));
      else if(sort==='newest') list.sort(byNew);
      else if(sort==='oldest') list.sort((a,b)=>-byNew(a,b));

      renderList(list);
    }

    /* ===== Detail modal ===== */
    const detailModal=document.getElementById('detailModal');
    detailModal.querySelector('.overlay').addEventListener('click',()=> detailModal.style.display='none');
    function openDetail(id){
      const p=productsData.find(x=>String(x.id)===String(id)); if(!p) return;
      const img=p.img_url || (Array.isArray(p.images)&&p.images[0]? publicUrlFromPath(p.images[0]):'');
      document.getElementById('dImg').src=img||'';
      document.getElementById('dName').textContent=p.name||'';
      document.getElementById('dId').textContent=p.product_id?`商品編號：${p.product_id}`:'';
      document.getElementById('dPrice').textContent=fmt(p.price);
      document.getElementById('dOrig').textContent='';
      const meta=[p.category?`分類：${p.category}`:'', p.status?`狀態：${p.status}`:'', p.arrival_time?`到貨：${p.arrival_time}`:''].filter(Boolean).join('　');
      document.getElementById('dMeta').textContent=meta;
      document.getElementById('dEta').textContent=p.eta_text||'';
      const tagsBox=document.getElementById('dTags'); tagsBox.innerHTML='';
      (Array.isArray(p.tags)?p.tags:[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tagsBox.appendChild(s); });
      document.getElementById('btnCopy').onclick=()=>navigator.clipboard.writeText(`我要下單：${p.name||''} 1件`).then(()=>alert('已複製下單格式'));
      // 啟動連結選單
      document.getElementById('btnAsk').onclick=()=> openLinks();
      detailModal.style.display='block';
    }
    document.getElementById('productList').addEventListener('click', e=>{
      let el=e.target; while(el && !el.classList.contains('card')) el=el.parentElement;
      if(el) openDetail(el.getAttribute('data-id'));
    });

    /* ===== Links modal ===== */
    const linksModal=document.getElementById('linksModal');
    linksModal.querySelector('.overlay').addEventListener('click',()=> linksModal.style.display='none');
    document.getElementById('linksClose').addEventListener('click',()=> linksModal.style.display='none');
    function openLinks(){ linksModal.style.display='block'; }

    /* ===== Options & Products ===== */
    async function loadOptions(){
      try{
        const { data, error } = await supabaseClient.storage.from(BUCKET).download('admin/options.json');
        if(!error && data){
          const json=JSON.parse(await data.text());
          if(Array.isArray(json.categories)) OPTIONS.categories=json.categories;
        }
      }catch(_){}
    }
    function fillCategories(){
      const sel=document.getElementById('categoryFilter');
      sel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
      const fromOptions=OPTIONS.categories||[];
      const fromProducts=[...new Set(productsData.filter(p=>p.category).map(p=>p.category))];
      const all=[...new Set([...fromOptions,...fromProducts])].filter(Boolean).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
      all.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
    }
    async function fetchProducts(){
      const { data, error } = await supabaseClient
        .from('products')
        .select('id, product_id, name, price, category, status, arrival_time, eta_text, tags, images, img_url, created_at');
      if(error){
        console.error('讀取 products 失敗：', error);
        const tip=document.getElementById('emptyTip'); tip.style.display='block'; tip.textContent='商品資料載入失敗：'+(error.message||'');
        return [];
      }
      return data||[];
    }

    async function enterShop(){
      document.getElementById('loading').style.display='none';
      document.getElementById('addFriendPage').style.display='none';
      document.getElementById('shopPage').style.display='block';
      await loadOptions();
      productsData = await fetchProducts();
      fillCategories();
      applyFilters();
    }
    function showAddFriendPage(){
      document.getElementById('loading').style.display='none';
      document.getElementById('shopPage').style.display='none';
      document.getElementById('addFriendPage').style.display='block';
    }

    /* ===== Toolbar events ===== */
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('sortSelect').addEventListener('change', applyFilters);

    /* ===== LIFF ===== */
    liff.init({ liffId: "2008022206-rqDnER1B", withLoginOnExternalBrowser: true })
      .then(() => {
        if (!liff.isLoggedIn()) { liff.login(); }
        else {
          liff.getFriendship().then(({ friendFlag }) => { friendFlag ? enterShop() : showAddFriendPage(); })
          .catch(()=>showAddFriendPage());
        }
      }).catch(err=>{
        console.error('LIFF 初始化失敗', err);
        // 若要跳過 LIFF 測資料，解除下一行註解
        // enterShop();
        document.getElementById('loading').textContent='LIFF 初始化失敗';
      });
  </script>
</body>
</html>
