<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ—…æ¸¸äººç”Ÿé¸ç‰©ä»£è³¼ï½œSelect Shop</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    /* Loading screen */
    #loading { position:fixed; top:50%; width:100%; text-align:center; transform:translateY(-50%); font-size:1.2em; color:#555; }
    /* Container styling */
    #addFriendPage, #shopPage { display:none; max-width:600px; margin:0 auto; padding:20px; text-align:center; }
    /* Add Friend Page */
    #addFriendPage h2 { margin-bottom:10px; }
    #addFriendPage p { margin:5px 0; color:#333; }
    #addFriendPage a { display:inline-block; margin:15px 0 10px; padding:10px 20px; background-color:#00B900; color:#fff; text-decoration:none; border-radius:5px; font-size:16px; }
    #addFriendPage a:hover { background-color:#00a300; }
    #addFriendPage button { padding:10px 20px; font-size:16px; cursor:pointer; }
    /* Shop Page */
    #shopPage h1 { font-size:1.5em; margin:0 0 15px; text-align:center; }
    #searchBar { display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:10px; margin-bottom:20px; }
    #searchBar input { flex:1 1 150px; padding:5px; font-size:16px; }
    #searchBar select { padding:5px; font-size:16px; }
    /* Product List */
    #productList { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
    .product-card { flex:1 1 calc(50% - 10px); box-sizing:border-box; border:1px solid #ddd; border-radius:5px; padding:10px; text-align:left; background:#fff; }
    .product-card img { max-width:100%; height:auto; display:block; margin:0 auto 10px; }
    .product-card h3 { font-size:1em; margin:0 0 5px; }
    .product-card p.price { margin:0 0 8px; font-weight:bold; color:#e91e63; }
    .product-card p.price .orig-price { margin-left:5px; text-decoration:line-through; color:#999; font-weight:normal; }
    .product-card .actions { display:flex; gap:5px; }
    .product-card .actions button { flex:1; padding:6px; font-size:14px; cursor:pointer; border:none; border-radius:4px; }
    .product-card .actions button.copy-btn { background:#f0f0f0; color:#000; }
    .product-card .actions button.inquire-btn { background:#00B900; color:#fff; }
    .product-card .actions button.inquire-btn:hover { background:#00a300; }
    /* Modal (Contact Options) */
    #contactModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:1000; }
    #modalOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
    .modal-content { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:20px; border-radius:8px; max-width:90%; width:320px; text-align:center; }
    .modal-content h2 { margin-top:0; }
    .modal-content p { color:#333; line-height:1.5; }
    .contact-options { display:flex; gap:10px; margin:20px 0; }
    .contact-options .option { flex:1; border:1px solid #aaa; border-radius:5px; padding:10px; text-decoration:none; color:#000; background:#f9f9f9; }
    .contact-options .option h3 { margin:0 0 5px; font-size:16px; }
    .contact-options .option p { margin:0; font-size:14px; }
    .contact-options .option:hover { background:#f0f0f0; }
    .modal-content button { margin-top:10px; padding:8px 16px; font-size:14px; cursor:pointer; }
  </style>
</head>
<body>
  <!-- Loading screen -->
  <div id="loading">è¼‰å…¥ä¸­...</div>

  <!-- Add Friend Page -->
  <div id="addFriendPage">
    <h2>åŠ å…¥å®˜æ–¹å¸³è™Ÿ</h2>
    <p>å°šæœªåŠ å…¥å®˜æ–¹å¸³è™Ÿï¼Œè«‹é»ä¸‹æ–¹æŒ‰éˆ•åŠ å…¥ã€‚</p>
    <p>åŠ å…¥å®Œæˆå¾Œï¼Œè«‹å†é»ã€Œæˆ‘å·²åŠ å…¥ã€æŒ‰éˆ•ã€‚</p>
    <a href="https://line.me/R/ti/p/@958xfkot" target="_blank">â¡ï¸ é»æ­¤åŠ å…¥å®˜æ–¹å¸³è™Ÿ</a><br/>
    <button id="btnCheckFriend">æˆ‘å·²åŠ å…¥</button>
  </div>

  <!-- Shop Page -->
  <div id="shopPage">
    <h1>æ—…æ¸¸äººç”Ÿé¸ç‰©ä»£è³¼ï½œSelect Shop</h1>
    <div id="searchBar">
      <input type="text" id="searchInput" placeholder="æœå°‹å•†å“..." />
      <select id="categoryFilter">
        <option value="">å…¨éƒ¨åˆ†é¡</option>
        <!-- categories will be populated here -->
      </select>
      <select id="sortSelect">
        <option value="newest">ä¸Šæ¶æ™‚é–“ï¼šæ–°åˆ°èˆŠ</option>
        <option value="oldest">ä¸Šæ¶æ™‚é–“ï¼šèˆŠåˆ°æ–°</option>
        <option value="priceAsc">åƒ¹æ ¼ï¼šä½åˆ°é«˜</option>
        <option value="priceDesc">åƒ¹æ ¼ï¼šé«˜åˆ°ä½</option>
      </select>
    </div>
    <div id="productList">è¼‰å…¥ä¸­...</div>
  </div>

  <!-- Contact Modal for Inquiry/Order -->
  <div id="contactModal">
    <div id="modalOverlay"></div>
    <div class="modal-content">
      <h2>é¸æ“‡è¯çµ¡æ–¹å¼</h2>
      <p>ä¸‹å–®ç³»çµ±é‚„åœ¨é–‹ç™¼ä¸­ï¼Œè¦éº»ç…©å…ˆç”¨ç¤¾ç¾¤æˆ–æ˜¯å®˜æ–¹ LINE ç§è¨Šæˆ‘ ğŸ§¡</p>
      <div class="contact-options">
        <a href="https://line.me/ti/g2/fRmTHOkmCy8ite62TzDencHTqlruXj6um0DT7g" target="_blank" class="option community">
          <h3>ç¤¾ç¾¤</h3>
          <p>å¯†ç¢¼ï¼š0628</p>
        </a>
        <a href="https://line.me/R/ti/p/@958xfkot" target="_blank" class="option official">
          <h3>å®˜æ–¹ LINE</h3>
          <p>é»æ“Šå‰å¾€</p>
        </a>
      </div>
      <button id="closeModal">é—œé–‰</button>
    </div>
  </div>

  <!-- LIFF SDK and Supabase scripts -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== Supabase æ­£ç¢ºé€£ç·šè¨­å®šï¼ˆå·²ä¿®æ­£ï¼‰ =====
    const supabaseUrl = 'https://llbpmqyjigovxixeohzr.supabase.co'; // âœ… æ­£ç¢º
    const supabaseKey = 'sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
    const BUCKET = 'yuyu.f86'; // âœ… ç”¨æ–¼ images[0] â†’ public URL
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // Global data store
    let productsData = [];

    // ç”± Storage è·¯å¾‘å– Public URL
    function publicUrlFromPath(path) {
      if (!path) return '';
      const { data } = supabaseClient.storage.from(BUCKET).getPublicUrl(path);
      return data?.publicUrl || '';
    }

    // é¡¯ç¤ºå•†å“å¡ç‰‡
    function displayProducts(list) {
      const productListElem = document.getElementById('productList');
      if (!list || list.length === 0) {
        productListElem.innerHTML = '<p>ç›®å‰æ²’æœ‰å•†å“</p>';
        return;
      }
      let html = '';
      list.forEach(prod => {
        // åœ–ç‰‡ï¼šå„ªå…ˆç”¨ img_urlï¼ˆå¾Œå°å¯«å…¥ï¼‰ï¼Œå¦å‰‡ç”¨ images[0] è·¯å¾‘çµ„ public URL
        const img =
          (prod.img_url && String(prod.img_url)) ||
          (Array.isArray(prod.images) && prod.images[0] ? publicUrlFromPath(prod.images[0]) : '');

        // åƒ¹æ ¼
        const price = prod.price ?? '';
        const original = prod.original_price ?? null; // è‹¥æœ‰åŸåƒ¹å°±ç•«åˆªé™¤ç·š
        let priceHTML = `NT$${price}`;
        if (original && original !== price) {
          priceHTML += ` <span class="orig-price">NT$${original}</span>`;
        }

        html += `<div class="product-card">`;
        if (img) html += `<img src="${img}" alt="${prod.name || ''}" />`;
        html += `<h3>${prod.name || ''}</h3>`;
        html += `<p class="price">${priceHTML}</p>`;
        html += `<div class="actions">
                  <button class="copy-btn" data-product="${prod.name || ''}">è¤‡è£½ä¸‹å–®æ ¼å¼</button>
                  <button class="inquire-btn">è©¢å• / ä¸‹å–®</button>
                </div>`;
        html += `</div>`;
      });
      productListElem.innerHTML = html;
    }

    // æœå°‹ / ç¯©é¸ / æ’åº
    function applyFilters() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const categoryValue = document.getElementById('categoryFilter').value;
      const sortValue = document.getElementById('sortSelect').value;

      let filtered = productsData.filter(prod => {
        const nameHit = (prod.name || '').toLowerCase().includes(searchText);
        const descHit = (prod.eta_text || '').toLowerCase().includes(searchText); // ä½ æ²’æœ‰ description æ¬„ï¼Œå…ˆç”¨ eta_text ç•¶å¯æœå°‹å­—ä¸²
        const inCategory = !categoryValue || prod.category === categoryValue;
        return (nameHit || descHit) && inCategory;
      });

      if (sortValue === 'priceAsc') {
        filtered.sort((a, b) => (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0));
      } else if (sortValue === 'priceDesc') {
        filtered.sort((a, b) => (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0));
      } else if (sortValue === 'newest') {
        filtered.sort((a, b) => {
          if (a.created_at && b.created_at) {
            return new Date(b.created_at) - new Date(a.created_at);
          } else if (a.id && b.id) {
            return b.id - a.id;
          } else { return 0; }
        });
      } else if (sortValue === 'oldest') {
        filtered.sort((a, b) => {
          if (a.created_at && b.created_at) {
            return new Date(a.created_at) - new Date(b.created_at);
          } else if (a.id && b.id) {
            return a.id - b.id;
          } else { return 0; }
        });
      }

      displayProducts(filtered);
    }

    // é€²å…¥å•†åº—ï¼ŒæŠ“ Supabase è³‡æ–™
    function enterShop() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('addFriendPage').style.display = 'none';
      document.getElementById('shopPage').style.display = 'block';

      supabaseClient
        .from('products')
        .select('id, product_id, name, price, category, status, arrival_time, eta_text, tags, images, img_url, created_at')
        .then(({ data, error }) => {
          if (error) {
            console.error('Supabase è³‡æ–™è®€å–éŒ¯èª¤:', error);
            document.getElementById('productList').innerHTML = '<p>å•†å“è³‡æ–™è¼‰å…¥å¤±æ•—ã€‚</p>';
            return;
          }
          productsData = data || [];

          // å¡«å…¥åˆ†é¡ä¸‹æ‹‰
          const categorySelect = document.getElementById('categoryFilter');
          categorySelect.querySelectorAll('option:not([value=""])').forEach(opt => opt.remove());
          const categories = [...new Set(productsData.filter(p => p.category).map(p => p.category))].sort();
          categories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            categorySelect.appendChild(opt);
          });

          // åˆå§‹é¡¯ç¤º
          applyFilters();
        });
    }

    // é¡¯ç¤ºåŠ å¥½å‹é 
    function showAddFriendPage() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('shopPage').style.display = 'none';
      document.getElementById('addFriendPage').style.display = 'block';
    }

    // äº‹ä»¶ç¶å®š
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('sortSelect').addEventListener('change', applyFilters);
    document.getElementById('productList').addEventListener('click', function(e) {
      const target = e.target;
      if (target.classList.contains('copy-btn')) {
        const productName = target.getAttribute('data-product') || '';
        const orderText = `æˆ‘è¦ä¸‹å–®ï¼š${productName} 1ä»¶`;
        navigator.clipboard.writeText(orderText).then(() => {
          alert('å·²è¤‡è£½ä¸‹å–®æ ¼å¼');
        });
      } else if (target.classList.contains('inquire-btn')) {
        document.getElementById('contactModal').style.display = 'block';
      }
    });
    document.getElementById('closeModal').onclick = () => { document.getElementById('contactModal').style.display = 'none'; };
    document.getElementById('modalOverlay').onclick = () => { document.getElementById('contactModal').style.display = 'none'; };
    document.getElementById('btnCheckFriend').addEventListener('click', () => {
      liff.getFriendship().then(({ friendFlag }) => {
        if (friendFlag) enterShop();
        else alert("å°šæœªåŠ å…¥å®˜æ–¹å¸³è™Ÿå–”ï¼è«‹ç¢ºèªå·²æˆåŠŸåŠ å…¥ã€‚");
      });
    });

    // LIFF init
    liff.init({ liffId: "2008022206-rqDnER1B", withLoginOnExternalBrowser: true })
      .then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          liff.getFriendship().then(({ friendFlag }) => {
            if (friendFlag) enterShop();
            else showAddFriendPage();
          }).catch(err => {
            console.error('getFriendship ç™¼ç”ŸéŒ¯èª¤:', err);
            showAddFriendPage();
          });
        }
      })
      .catch(err => {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', err);
        document.getElementById('loading').innerText = 'LIFF åˆå§‹åŒ–å¤±æ•—';
      });
  </script>
</body>
</html>
