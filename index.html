<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ—…æ¸¸äººç”Ÿé¸ç‰©ä»£è³¼ï½œSelect Shop</title>
<style>
  :root{
    --bg:#f7f3ef;--paper:#fffdf9;--card:#fff;--ink:#2b2b2b;--muted:#7a7267;
    --brand:#8B5E34;--brand-2:#C2A27A;--accent:#7F8C5B;--border:#eadfcd;
    --shadow:0 12px 30px rgba(139,94,52,.08);--radius:16px;--maxw:1100px;
    --gap:16px;--thumb-h:170px
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#f8f5f1 0%, var(--bg) 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial}
  a{color:var(--brand)} img{display:block;max-width:100%}
  .topbar{position:sticky;top:0;z-index:50;background:rgba(247,243,239,.75);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:14px 18px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{width:42px;height:42px;object-fit:contain}
  .title{font-weight:800}.subtitle{font-weight:700;color:var(--brand)}
  #toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:8px}
  #toolbar input,#toolbar select{padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fffdfa}
  #wishBtn{border:1px solid var(--brand);color:#fff;background:var(--brand);border-radius:12px;padding:12px 16px;cursor:pointer}
  .container{max-width:var(--maxw);margin:18px auto;padding:0 18px}
  .notice{background:#fffdfa;border:1px dashed var(--border);border-radius:14px;padding:10px 12px}
  .runs{display:flex;gap:12px;overflow:auto;padding-bottom:4px;margin-top:12px}
  .runCard{min-width:230px;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px;cursor:pointer}
  .runCard .muted{color:var(--muted);font-size:12px}
  #productList{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:var(--gap);margin-top:12px}
  .card{border:1px solid var(--border);border-radius:var(--radius);background:var(--card);overflow:hidden;box-shadow:var(--shadow);cursor:pointer;transition:.08s}
  .card:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(139,94,52,.12)}
  .thumb{height:var(--thumb-h);background:#f2eee7;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:contain}
  .pad{padding:12px 14px}
  .name{font-size:14px;line-height:1.35;margin:0 0 6px}
  .price{color:#b03c2f;font-weight:800}
  .cat{margin-top:4px;font-size:12px;color:var(--muted)}
  #loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  #emptyTip{color:var(--muted);text-align:center}

  /* Modal å…±ç”¨ */
  .modal{display:none;position:fixed;inset:0;z-index:1000}
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(980px,92vw);max-height:88vh;overflow:auto;background:var(--paper);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);padding:20px}
  .panel.grid2{display:grid;grid-template-columns:1fr 1fr;gap:22px}
  @media (max-width:820px){.panel.grid2{grid-template-columns:1fr}}

  /* å•†å“è©³æƒ… */
  .viewer{display:grid;gap:8px}
  .bigimg{width:100%;aspect-ratio:4/3;background:#f2eee7;border-radius:14px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  .bigimg img{width:100%;height:100%;object-fit:contain}
  .thumbs{display:grid;grid-auto-flow:column;gap:8px;overflow:auto}
  .thumbs img{height:64px;width:auto;border-radius:8px;border:2px solid transparent;cursor:pointer}
  .thumbs img.active{border-color:var(--brand)}
  .navBtns{display:flex;justify-content:space-between;margin-top:6px}
  .navBtns button{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
  .btnrow{display:flex;gap:10px;margin-top:12px}
  .btn{border:none;border-radius:12px;padding:12px 16px;font-size:14px;cursor:pointer;box-shadow:var(--shadow)}
  .btn.copy{background:#f4efe7}.btn.ask{background:var(--brand);color:#fff}

  /* è¨±é¡˜è¡¨å–® */
  .wishRow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:860px){.wishRow{grid-template-columns:1fr}}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fffdfa}
  textarea{min-height:80px}
  .uploader{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fff}
  .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <img src="LOGO.png" alt="logo" />
          <div><div class="title" style="font-size:22px;">æ—…æ¸¸äººç”Ÿé¸ç‰©ä»£è³¼</div><div class="subtitle">Select Shop</div></div>
        </div>
        <div id="toolbar">
          <input type="text" id="searchInput" placeholder="æœå°‹å•†å“â€¦" />
          <select id="runFilter"><option value="">å…¨éƒ¨é€£ç·š</option></select>
          <select id="categoryFilter"><option value="">å…¨éƒ¨åˆ†é¡</option></select>
          <select id="sortSelect">
            <option value="newest">ä¸Šæ¶æ™‚é–“ï¼šæ–°åˆ°èˆŠ</option>
            <option value="oldest">ä¸Šæ¶æ™‚é–“ï¼šèˆŠåˆ°æ–°</option>
            <option value="priceAsc">åƒ¹æ ¼ï¼šä½åˆ°é«˜</option>
            <option value="priceDesc">åƒ¹æ ¼ï¼šé«˜åˆ°ä½</option>
          </select>
          <button id="wishBtn">æˆ‘è¦è¨±é¡˜</button>
        </div>
      </div>
    </div>
  </div>

  <div id="loading">è¼‰å…¥ä¸­â€¦</div>

  <div id="home" class="container" style="display:none">
    <div id="homeNotice" class="notice"></div>
    <h3 style="margin:12px 0 6px">æœ€è¿‘é€£ç·š</h3>
    <div id="homeRuns" class="runs"></div>
  </div>

  <div id="shopPage" class="container" style="display:none">
    <div id="productList"></div>
    <p id="emptyTip" class="muted" style="display:none;margin-top:12px">ç›®å‰æ²’æœ‰å•†å“</p>
  </div>

  <!-- å•†å“è©³æƒ… -->
  <div id="detailModal" class="modal">
    <div class="overlay"></div>
    <div class="panel grid2">
      <div class="viewer">
        <div class="bigimg"><img id="dImg" alt=""></div>
        <div class="navBtns">
          <button id="btnPrev">â† ä¸Šä¸€å¼µ</button>
          <button id="btnNext">ä¸‹ä¸€å¼µ â†’</button>
        </div>
        <div class="thumbs" id="thumbs"></div>
      </div>
      <div class="detail">
        <h2 id="dName" style="margin:0 0 6px"></h2>
        <div class="muted" id="dId"></div>
        <div style="margin:10px 0 4px"><span class="price" id="dPrice"></span></div>
        <div id="dMeta" class="muted"></div>
        <div id="dEta" class="muted" style="margin-top:6px"></div>
        <div id="dDesc" style="margin-top:6px"></div>
        <div id="dNote" style="margin-top:6px"></div>
        <div id="dTags" style="margin:10px 0"></div>
        <div class="btnrow">
          <button class="btn copy" id="btnCopy">è¤‡è£½ä¸‹å–®æ ¼å¼</button>
          <button class="btn ask" id="btnAsk">è©¢å•ï¼ä¸‹å–®</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è¨±é¡˜è¡¨å–® -->
  <div id="wishModal" class="modal">
    <div class="overlay"></div>
    <div class="panel">
      <h3 style="margin:0 0 10px">æˆ‘è¦è¨±é¡˜</h3>
      <div class="wishRow">
        <div><label>é¸æ“‡é€£ç·š</label><select id="wRun"><option value="">â€” é¸æ“‡ â€”</option></select></div>
        <div><label>é¸æ“‡åˆ†é¡</label><input id="wCategory" list="wCatList" placeholder="å¯ç›´æ¥è¼¸å…¥æ–°å¢"><datalist id="wCatList"></datalist></div>
        <div><label>å•†å“åç¨±</label><input id="wName" placeholder="å¿…å¡«"></div>
        <div><label>å•†å“ç¶²å€</label><input id="wUrl" placeholder="é¸å¡«"></div>
        <div style="grid-column:1 / -1">
          <label>è¨±é¡˜å…§å®¹ï¼ˆå°ºå¯¸/é¡è‰²/å…¶ä»–éœ€æ±‚ï¼‰</label>
          <textarea id="wContent" placeholder="é¸å¡«"></textarea>
        </div>
        <div style="grid-column:1 / -1">
          <label>å•†å“åœ–ç‰‡ï¼ˆjpg/png/webpï¼Œâ‰¤ 2MBï¼‰</label>
          <div class="uploader"><input type="file" id="wFile" accept="image/jpeg,image/png,image/webp"></div>
          <div class="muted small">è‹¥ä¹‹å¾Œä¸Šæ¶ï¼Œåœ–ç‰‡å¯ç”±å¾Œå°åˆªé™¤ã€‚</div>
        </div>
      </div>
      <div class="btnrow" style="margin-top:10px">
        <button class="btn" id="wSubmit">é€å‡ºè¨±é¡˜</button>
        <button class="btn" style="background:#fff;color:#2b2b2b;border:1px solid var(--border)" id="wClose">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- é€£çµé¸å–® -->
  <div id="linksModal" class="modal">
    <div class="overlay"></div>
    <div class="panel">
      <div>
        <h3 style="margin:0 0 12px">é¸æ“‡è¯çµ¡æ–¹å¼</h3>
        <p class="muted" style="margin:0 0 12px">ä¸‹å–®ç³»çµ±å°šåœ¨å»ºç½®ï¼Œè«‹å…ˆç”¨ä»¥ä¸‹ä»»ä¸€æ–¹å¼èˆ‡æˆ‘è¯ç¹«ï¼š</p>
        <div style="display:flex;gap:12px;flex-direction:column">
          <a class="linkBtn" target="_blank" href="https://line.me/R/ti/p/@958xfkot" style="display:flex;justify-content:space-between;align-items:center;text-decoration:none;padding:14px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;color:var(--ink);box-shadow:var(--shadow)"><div class="l" style="display:flex;align-items:center;gap:10px"><span class="dot green" style="width:10px;height:10px;border-radius:999px;background:#00B900"></span><strong>å®˜æ–¹ LINE</strong></div><span class="muted">é»æ“ŠåŠ å…¥</span></a>
          <a class="linkBtn" target="_blank" href="https://line.me/ti/g2/fRmTHOkmCy8ite62TzDencHTqlruXj6um0DT7g" style="display:flex;justify-content:space-between;align-items:center;text-decoration:none;padding:14px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;color:var(--ink);box-shadow:var(--shadow)"><div class="l" style="display:flex;align-items:center;gap:10px"><span class="dot blue" style="width:10px;height:10px;border-radius:999px;background:#4f7dbf"></span><strong>LINE ç¤¾ç¾¤</strong></div><span class="muted">å¯†ç¢¼ï¼š0628</span></a>
        </div>
        <div style="text-align:right;margin-top:14px"><button id="linksClose" class="btn" style="background:#fffaf2">é—œé–‰</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl='https://llbpmqyjigovxixeohzr.supabase.co';
    const supabaseKey='sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
    const BUCKET='yuyu.f86';
    const supabaseClient=supabase.createClient(supabaseUrl,supabaseKey);

    let productsData=[], runs=[], productRuns=[], OPTIONS={categories:[]};

    // å·¥å…·
    function publicUrlFromPath(path){
      if(!path) return '';
      const { data }=supabaseClient.storage.from(BUCKET).getPublicUrl(path);
      return data?.publicUrl||'';
    }
    function urlFor(p){ if(!p) return ''; return /^https?:\/\//i.test(p)? p : publicUrlFromPath(p); }
    function fmt(n){ if(n==null) return ''; return 'NT$'+Number(n||0).toLocaleString('zh-TW'); }
    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    function byNew(a,b){ if(a.created_at&&b.created_at) return new Date(b.created_at)-new Date(a.created_at); if(a.id&&b.id) return b.id-a.id; return 0; }
    function ensureArrayImages(p){
      if(Array.isArray(p.images)) return p.images;
      if(typeof p.images==='string' && p.images.trim()){
        return p.images.split(/[\n;]+/).map(s=>s.trim()).filter(Boolean);
      }
      return [];
    }

    // å¡ç‰‡èˆ‡åˆ—è¡¨ï¼ˆåªé¡¯ç¤ºæœ‰è¢«æŒ‡æ´¾åˆ°ã€Œé Poolã€é€£ç·šçš„å•†å“ï¼‰
    function cardHTML(p){
      const imgs=ensureArrayImages(p);
      const first = urlFor(p.img_url) || (imgs[0]? urlFor(imgs[0]) : '');
      return `<div class="card" data-id="${p.id}">
        <div class="thumb">${first?`<img src="${first}" alt="${escapeHtml(p.name||'')}" loading="lazy">`:''}</div>
        <div class="pad">
          <p class="name">${escapeHtml(p.name||'æœªå‘½å')}</p>
          <div class="price">${fmt(p.price)}</div>
          ${p.category?`<div class="cat">${escapeHtml(p.category)}</div>`:''}
        </div>
      </div>`;
    }
    function renderList(list){
      const box=document.getElementById('productList'), empty=document.getElementById('emptyTip');
      if(!list||list.length===0){box.innerHTML='';empty.style.display='block';return;}
      empty.style.display='none'; box.innerHTML=list.map(cardHTML).join('');
    }

    // é¦–é  featured é€£ç·šå¡ç‰‡ï¼ˆåªé¡¯ç¤ºé Poolï¼‰
    function renderHomeRuns(){
      const wrap=document.getElementById('homeRuns'); wrap.innerHTML='';
      runs.filter(r=>r.is_featured && !r.is_pool).forEach(r=>{
        const el=document.createElement('div'); el.className='runCard';
        el.innerHTML=`<div><strong>${escapeHtml(r.title||r.code||r.region)}</strong></div>
          <div class="muted">${r.start_date||''} ~ ${r.end_date||''}</div>
          ${r.ship_start_date?`<div class="muted">å¯„é€ï¼š${r.ship_start_date}</div>`:''}
          ${r.note?`<div style="margin-top:6px">${escapeHtml(r.note)}</div>`:''}`;
        el.onclick=()=>{
          document.getElementById('runFilter').value=r.id;
          applyFilters();
          window.scrollTo({top:document.getElementById('shopPage').offsetTop-10,behavior:'smooth'});
        };
        wrap.appendChild(el);
      });
    }

    // ç¯©é¸
    function applyFilters(){
      const kw=(document.getElementById('searchInput').value||'').toLowerCase();
      const cat=document.getElementById('categoryFilter').value;
      const sort=document.getElementById('sortSelect').value;
      const runId=document.getElementById('runFilter').value;

      let allowed=null;
      if(runId){ allowed=new Set(productRuns.filter(x=>x.run_id===runId).map(x=>x.product_id)); }

      let list=productsData.filter(p=>{
        if(allowed && !allowed.has(p.id)) return false;
        const text=`${p.name||''} ${(p.eta_text||'')} ${(Array.isArray(p.tags)?p.tags.join(','):(p.tags||''))}`.toLowerCase();
        const hitKw=!kw||text.includes(kw);
        const hitCat=!cat||p.category===cat;
        return hitKw&&hitCat;
      });

      if(sort==='priceAsc') list.sort((a,b)=>(+a.price||0)-(+b.price||0));
      else if(sort==='priceDesc') list.sort((a,b)=>(+b.price||0)-(+a.price||0));
      else if(sort==='newest') list.sort(byNew);
      else if(sort==='oldest') list.sort((a,b)=>-byNew(a,b));
      renderList(list);
    }

    // Modal é–‹å•Ÿ/å¡«å……ï¼ˆå¤šåœ–ï¼‰
    const detailModal=document.getElementById('detailModal');
    detailModal.querySelector('.overlay').addEventListener('click',()=> detailModal.style.display='none');

    let curImgs=[], curIdx=0;
    function setBig(i){
      if(!curImgs.length) return;
      curIdx=(i+curImgs.length)%curImgs.length;
      const url = curImgs[curIdx];
      document.getElementById('dImg').src=url;
      document.querySelectorAll('#thumbs img').forEach((im,idx)=> im.classList.toggle('active', idx===curIdx));
    }
    function openDetail(id){
      const p=productsData.find(x=>String(x.id)===String(id));
      if(!p) return;
      const imgs=ensureArrayImages(p).map(urlFor);
      const first = urlFor(p.img_url) || (imgs[0]||'');
      curImgs = [first, ...imgs.filter(u=>u && u!==first)];
      curImgs = curImgs.filter(Boolean);
      curIdx=0;

      document.getElementById('dImg').src=curImgs[0]||'';
      document.getElementById('dName').textContent=p.name||'';
      document.getElementById('dId').textContent=p.product_id?`å•†å“ç·¨è™Ÿï¼š${p.product_id}`:'';
      document.getElementById('dPrice').textContent=fmt(p.price);

      const meta=[
        p.category?`åˆ†é¡ï¼š${p.category}`:'',
        p.status?`ç‹€æ…‹ï¼š${p.status}`:'',
        p.arrival_time?`é–‹å§‹å¯„é€æ—¥æœŸï¼ˆé è¨ˆä¸‰å¤©å…§å‡ºè²¨ï¼‰ï¼š${p.arrival_time}`:''
      ].filter(Boolean).join('ã€€');
      document.getElementById('dMeta').textContent=meta;
      document.getElementById('dEta').textContent=p.eta_text||'';
      document.getElementById('dDesc').textContent=p.description?`æè¿°ï¼š${p.description}`:'';
      document.getElementById('dNote').textContent=p.note||'';

      const tagsBox=document.getElementById('dTags'); tagsBox.innerHTML='';
      (Array.isArray(p.tags)?p.tags:[]).forEach(t=>{
        const s=document.createElement('span');
        s.style.cssText='display:inline-block;padding:3px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-right:6px';
        s.textContent=t; tagsBox.appendChild(s);
      });

      const th=document.getElementById('thumbs'); th.innerHTML='';
      curImgs.forEach((u,idx)=>{
        const im=document.createElement('img'); im.src=u; if(idx===0) im.classList.add('active');
        im.onclick=()=> setBig(idx);
        th.appendChild(im);
      });
      document.getElementById('btnPrev').onclick=()=> setBig(curIdx-1);
      document.getElementById('btnNext').onclick=()=> setBig(curIdx+1);

      document.getElementById('btnCopy').onclick=()=>navigator.clipboard.writeText(`æˆ‘è¦ä¸‹å–®ï¼š${p.name||''} 1ä»¶`).then(()=>alert('å·²è¤‡è£½ä¸‹å–®æ ¼å¼'));
      document.getElementById('btnAsk').onclick=()=> openLinks();
      detailModal.style.display='block';
    }
    document.getElementById('productList').addEventListener('click', e=>{
      let el=e.target; while(el && !el.classList.contains('card')) el=el.parentElement;
      if(el) openDetail(el.getAttribute('data-id'));
    });

    // é€£çµ modal
    const linksModal=document.getElementById('linksModal');
    linksModal.querySelector('.overlay').addEventListener('click',()=> linksModal.style.display='none');
    document.getElementById('linksClose').addEventListener('click',()=> linksModal.style.display='none');
    function openLinks(){ linksModal.style.display='block'; }

    // è¨±é¡˜ modal
    const wishModal=document.getElementById('wishModal');
    const wishOpenBtn=document.getElementById('wishBtn');
    wishOpenBtn.onclick=()=>{ wishModal.style.display='block'; };
    wishModal.querySelector('.overlay').onclick=()=> wishModal.style.display='none';
    document.getElementById('wClose').onclick=()=> wishModal.style.display='none';

    // Supabase è³‡æ–™è®€å–
    async function fetchRuns(){
      // åªå–å•Ÿç”¨çš„å…¨éƒ¨ runï¼ˆå‰å° UI æœƒè‡ªè¡Œæ’é™¤ Pool çš„é¡¯ç¤ºï¼‰
      const { data }=await supabaseClient
        .from('runs')
        .select('id,code,title,region,start_date,end_date,note,ship_start_date,is_active,is_featured,is_pool')
        .eq('is_active',true)
        .order('start_date',{ascending:false});
      return data||[];
    }
    async function fetchProductRuns(runIds){
      let q=supabaseClient.from('product_runs').select('product_id,run_id');
      if(runIds?.length) q=q.in('run_id',runIds);
      const { data }=await q;
      return data||[];
    }
    async function fetchProducts(){
      const { data }=await supabaseClient
        .from('products')
        .select('id,product_id,name,price,category,status,arrival_time,eta_text,tags,images,img_url,created_at,note,description');
      return data||[];
    }
    async function loadOptions(){
      try{
        const { data, error }=await supabaseClient.storage.from(BUCKET).download('admin/options.json');
        if(!error&&data){ const json=JSON.parse(await data.text()); if(Array.isArray(json.categories)) OPTIONS.categories=json.categories; }
      }catch(_){}
    }
    function fillCategories(){
      const sel=document.getElementById('categoryFilter');
      sel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
      const fromOptions=OPTIONS.categories||[];
      const fromProducts=[...new Set(productsData.filter(p=>p.category).map(p=>p.category))];
      const all=[...new Set([...fromOptions,...fromProducts])].filter(Boolean).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
      all.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o); });
      // è¨±é¡˜åˆ†é¡ datalist
      const dl=document.getElementById('wCatList'); dl.innerHTML='';
      all.forEach(c=> dl.appendChild(new Option('',c)));
    }
    function fillRuns(){
      const sel=document.getElementById('runFilter');
      sel.innerHTML='<option value="">å…¨éƒ¨é€£ç·š</option>';
      runs.filter(r=>!r.is_pool).forEach(r=>{ // å‰å°éæ¿¾æ‰ pool
        const opt=document.createElement('option');
        opt.value=r.id; opt.textContent=r.title||r.code||r.region;
        sel.appendChild(opt);
      });
      // è¨±é¡˜ç”¨ï¼šrun ä¸‹æ‹‰ï¼ˆåŒ…å«é pool çš„å¯¦éš›é€£ç·šï¼›å¦‚æœä½ ä¹Ÿæƒ³å…è¨±é¸ poolï¼Œå¯ç§»é™¤ filterï¼‰
      const wSel=document.getElementById('wRun'); wSel.innerHTML='<option value="">â€” é¸æ“‡ â€”</option>';
      runs.filter(r=>!r.is_pool).forEach(r=>{
        wSel.appendChild(new Option(r.title||r.code||r.region, r.id));
      });
    }
    async function loadHomeNotice(){
      const { data }=await supabaseClient.from('site_meta').select('value').eq('key','home_notice').maybeSingle();
      document.getElementById('homeNotice').textContent=data?.value||'';
      document.getElementById('home').style.display='block';
    }

    async function enterShop(){
      await loadOptions();
      runs=await fetchRuns();
      await loadHomeNotice();
      productsData=await fetchProducts();

      // åªå–ã€Œé Poolã€é€£ç·šçš„å°æ‡‰ï¼Œå‰å°åªé¡¯ç¤ºé€™äº›å•†å“
      const nonPoolRunIds=runs.filter(r=>!r.is_pool).map(r=>r.id);
      productRuns=await fetchProductRuns(nonPoolRunIds);

      fillCategories();
      fillRuns();
      renderHomeRuns();
      applyFilters();
      document.getElementById('loading').style.display='none';
      document.getElementById('shopPage').style.display='block';
    }

    // è¨±é¡˜ï¼šé€å‡º
    async function uploadWishImage(file){
      if(!file) return null;
      const okTypes=['image/jpeg','image/png','image/webp'];
      if(!okTypes.includes(file.type)){ alert('åœ–ç‰‡æ ¼å¼åƒ…æ”¯æ´ JPG/PNG/WebP'); return null; }
      if(file.size > 2*1024*1024){ alert('åœ–ç‰‡å¤§å°ä¸Šé™ 2MB'); return null; }
      const d=new Date(), ym=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
      const name=`wish_${Date.now()}_${Math.random().toString(36).slice(2,8)}.${file.name.split('.').pop()||'jpg'}`;
      const path=`wishes/${ym}/${name}`;
      const { error }=await supabaseClient.storage.from(BUCKET).upload(path, file, { cacheControl:'3600', upsert:false });
      if(error){ alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼š'+error.message); return null; }
      return path;
    }
    document.getElementById('wSubmit').onclick=async()=>{
      const run_id=document.getElementById('wRun').value||null;
      const category=(document.getElementById('wCategory').value||'').trim()||null;
      const product_name=(document.getElementById('wName').value||'').trim();
      const product_url=(document.getElementById('wUrl').value||'').trim()||null;
      const content=(document.getElementById('wContent').value||'').trim()||null;
      const file=document.getElementById('wFile').files[0]||null;
      if(!product_name){ alert('è«‹å¡«å¯«å•†å“åç¨±'); return; }
      let image_path=null;
      if(file){ image_path=await uploadWishImage(file); if(image_path===null) return; }
      const payload={ run_id, category, product_name, product_url, image_path, content, status:'pending' };
      const { error }=await supabaseClient.from('wishes').insert(payload);
      if(error){ alert('é€å‡ºå¤±æ•—ï¼š'+error.message); return; }
      alert('å·²æ”¶åˆ°ä½ çš„è¨±é¡˜ ğŸ™Œã€€æˆ‘å€‘æœƒç›¡å¿«è©•ä¼°ã€‚');
      ['wRun','wCategory','wName','wUrl','wContent','wFile'].forEach(id=>{ const el=document.getElementById(id); if(el.type==='file') el.value=null; else el.value=''; });
      wishModal.style.display='none';
    };

    // äº‹ä»¶
    document.getElementById('searchInput').addEventListener('input',applyFilters);
    document.getElementById('categoryFilter').addEventListener('change',applyFilters);
    document.getElementById('sortSelect').addEventListener('change',applyFilters);
    document.getElementById('runFilter').addEventListener('change',applyFilters);

    // å•Ÿå‹•
    enterShop();
  </script>
</body>
</html>
