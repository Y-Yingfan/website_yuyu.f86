<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>代購清單</title>

  <!-- Tailwind (純前端、好調整樣式) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.3/dist/umd/supabase.min.js"></script>

  <style>
    /* 卡片圖片容器：固定比例避免排版跳動 */
    .img-wrap {
      position: relative;
      width: 100%;
      padding-top: 75%; /* 4:3 */
      overflow: hidden;
      border-radius: 0.75rem;
      background: #f3f4f6;
    }
    .img-wrap img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Modal 圖片區：高度自適應、含上一張下一張 */
    .modal-image-box {
      position: relative;
      width: 100%;
      height: min(70vh, 720px);
      background: #0b0b0b;
      border-radius: 0.75rem;
      overflow: hidden;
    }
    .modal-image-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: #0b0b0b;
    }
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.85);
      border-radius: 9999px;
      padding: 0.5rem 0.6rem;
      user-select: none;
    }
    .nav-btn:hover { background: white; }
    .nav-prev { left: 0.5rem; }
    .nav-next { right: 0.5rem; }

    /* 縮圖列：水平卷軸、選中高亮 */
    .thumb-strip {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding-bottom: 0.25rem;
      scrollbar-width: thin;
    }
    .thumb {
      flex: 0 0 auto;
      width: 72px;
      height: 72px;
      border-radius: 0.5rem;
      background: #f3f4f6;
      overflow: hidden;
      border: 2px solid transparent;
      cursor: pointer;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumb.active {
      border-color: #111827;
    }

    /* 避免圖片超出版面：卡片、modal 都使用 object-fit: contain 搭配固定容器 */
  </style>
</head>
<body class="bg-white text-gray-900">
  <!-- 頂部：公告＋篩選列 -->
  <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
    <!-- 公告條 -->
    <div id="announcement" class="hidden mb-4 rounded-xl bg-amber-50 text-amber-900 px-4 py-3 text-sm"></div>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <h1 class="text-2xl font-bold">代購清單</h1>

      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
        <!-- 連線下拉 -->
        <label class="text-sm font-medium">連線：</label>
        <select id="runSelect"
                class="min-w-[220px] rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-800">
          <option value="all">全部連線</option>
          <!-- 下面會注入「最近連線」以及各 run -->
        </select>
      </div>
    </div>
  </header>

  <!-- 商品清單 -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div id="grid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      <!-- JS 注入卡片 -->
    </div>

    <!-- 空狀態 -->
    <div id="emptyState" class="hidden text-center text-gray-500 py-16">
      沒有符合條件的商品。
    </div>
  </main>

  <!-- Modal -->
  <div id="modal"
       class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4"
       aria-modal="true" role="dialog">
    <div class="w-full max-w-5xl bg-white rounded-2xl p-4 sm:p-6 shadow-2xl relative">
      <button id="modalClose"
              class="absolute right-3 top-3 rounded-full p-2 bg-gray-100 hover:bg-gray-200"
              aria-label="關閉">
        ✕
      </button>

      <div class="grid gap-4 lg:grid-cols-2">
        <!-- 大圖區 -->
        <div>
          <div class="modal-image-box">
            <img id="modalMainImg" src="" alt="商品圖片" />
            <button class="nav-btn nav-prev" id="btnPrev" aria-label="上一張">‹</button>
            <button class="nav-btn nav-next" id="btnNext" aria-label="下一張">›</button>
          </div>
          <div id="thumbStrip" class="thumb-strip mt-3"></div>
        </div>

        <!-- 詳細資訊 -->
        <div class="space-y-3">
          <h2 id="modalTitle" class="text-xl font-semibold"></h2>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="space-y-1">
              <div class="text-gray-500">商品編號</div>
              <div id="f_id" class="font-medium"></div>
            </div>
            <div class="space-y-1">
              <div class="text-gray-500">分類</div>
              <div id="f_category" class="font-medium"></div>
            </div>
            <div class="space-y-1">
              <div class="text-gray-500">狀態</div>
              <div id="f_status" class="font-medium"></div>
            </div>
            <div class="space-y-1">
              <div class="text-gray-500">到貨日</div>
              <div id="f_arrival" class="font-medium"></div>
            </div>
          </div>

          <div class="space-y-1 text-sm">
            <div class="text-gray-500">備註</div>
            <div id="f_note" class="whitespace-pre-wrap"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ================== 🔧 這裡換成你的專案設定 ================== */
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const STORAGE_BUCKET = 'YOUR_STORAGE_BUCKET'; // 例如 'images'
    /* ============================================================ */

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM 元素
    const els = {
      announcement: document.getElementById('announcement'),
      runSelect: document.getElementById('runSelect'),
      grid: document.getElementById('grid'),
      emptyState: document.getElementById('emptyState'),
      modal: document.getElementById('modal'),
      modalClose: document.getElementById('modalClose'),
      modalTitle: document.getElementById('modalTitle'),
      f_id: document.getElementById('f_id'),
      f_category: document.getElementById('f_category'),
      f_status: document.getElementById('f_status'),
      f_arrival: document.getElementById('f_arrival'),
      f_note: document.getElementById('f_note'),
      modalMainImg: document.getElementById('modalMainImg'),
      thumbStrip: document.getElementById('thumbStrip'),
      btnPrev: document.getElementById('btnPrev'),
      btnNext: document.getElementById('btnNext'),
    };

    // 目前資料
    let runs = [];
    let products = [];      // 目前列表（依篩選載入）
    let allProducts = [];   // 全部商品（加速切換）
    let recentRunId = null;

    // Modal 狀態
    let currentImages = [];
    let currentImgIndex = 0;

    /** 取得公告：site_meta 表中鍵名優先順序 */
    async function loadAnnouncement() {
      const keys = ['announcement', 'notice', 'headline'];
      const { data, error } = await sb
        .from('site_meta')
        .select('key,value')
        .in('key', keys);

      if (error) {
        console.warn('loadAnnouncement error', error);
        return;
      }
      if (!data || data.length === 0) return;

      // 找到第一個有值的 key
      for (const k of keys) {
        const row = data.find(x => x.key === k && x.value && String(x.value).trim() !== '');
        if (row) {
          els.announcement.textContent = String(row.value);
          els.announcement.classList.remove('hidden');
          break;
        }
      }
    }

    /** 取得所有連線（runs），排序新到舊，設定「最近連線」 */
    async function loadRuns() {
      const { data, error } = await sb
        .from('runs')
        .select('id,name,created_at,start_date')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('loadRuns error', error);
        return;
      }

      runs = data || [];
      // 「最近連線」定義：以 created_at 最新；若沒有 created_at 就取第一筆
      recentRunId = runs.length ? runs[0].id : null;

      // 填入下拉（保留「全部連線」）
      // 先注入「最近連線」
      if (recentRunId) {
        const optRecent = document.createElement('option');
        optRecent.value = 'recent';
        optRecent.textContent = '最近連線';
        els.runSelect.appendChild(optRecent);
      }

      // 再注入各 run
      for (const r of runs) {
        const opt = document.createElement('option');
        opt.value = String(r.id);
        opt.textContent = r.name || `連線 #${r.id}`;
        els.runSelect.appendChild(opt);
      }
    }

    /** 取得全部商品（用於「全部連線」） */
    async function loadAllProducts() {
      const { data, error } = await sb
        .from('products')
        .select('*')
        .order('id', { ascending: false });

      if (error) {
        console.error('loadAllProducts error', error);
        return [];
      }
      return data || [];
    }

    /** 依 run 取得商品：透過 product_runs 對應 */
    async function loadProductsByRun(runId) {
      // 兩段式：先找 product_ids，再撈 products（避免不同 Supabase join 欄位名稱差異）
      const { data: links, error: e1 } = await sb
        .from('product_runs')
        .select('product_id')
        .eq('run_id', runId);

      if (e1) {
        console.error('loadProductsByRun link error', e1);
        return [];
      }
      const ids = (links || []).map(x => x.product_id);
      if (ids.length === 0) return [];

      const { data: items, error: e2 } = await sb
        .from('products')
        .select('*')
        .in('id', ids)
        .order('id', { ascending: false });

      if (e2) {
        console.error('loadProductsByRun items error', e2);
        return [];
      }
      return items || [];
    }

    /** 解析產品圖片欄位：支援 array / 逗號 / 分號 / 換行 */
    function parseImages(product) {
      const bucket = STORAGE_BUCKET;
      const candidates = [
        product.images,
        product.image_paths,
        product.image_path,
        product.image,
        product.pictures,
        product.photo_paths,
      ].filter(Boolean);

      let raw = [];
      if (candidates.length) {
        const v = candidates[0];
        if (Array.isArray(v)) {
          raw = v;
        } else if (typeof v === 'string') {
          raw = v.split(/[\n;,]+/);
        }
      }
      // 去空白
      raw = raw.map(s => String(s).trim()).filter(Boolean);

      // 轉成公開 URL（使用 storage public URL）
      // 若你的圖片已經是完整 https URL，則直接使用
      return raw.map(p => {
        if (/^https?:\/\//i.test(p)) return p;
        // Supabase Storage publicUrl
        const { data } = sb.storage.from(bucket).getPublicUrl(p);
        return data?.publicUrl || p; // 若未設定公開，仍回傳原字串以利偵錯
      });
    }

    /** 單張代表圖：取第一張 */
    function coverImage(product) {
      const imgs = parseImages(product);
      if (imgs.length) return imgs[0];
      // 無圖備用
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="450">
          <rect width="100%" height="100%" fill="#f3f4f6"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-family="sans-serif" font-size="20">
            No Image
          </text>
        </svg>
      `);
    }

    /** 卡片 HTML */
    function renderCard(item) {
      const title = item.title || item.name || `商品 #${item.id}`;
      const img = coverImage(item);
      const cat = item.category || item.type || '-';
      const badge = item.status || item.state || '';
      const arrival = item.arrival_date || item.arrival || '';

      const badgeHtml = badge
        ? `<span class="inline-block text-xs px-2 py-0.5 rounded-full bg-gray-900 text-white">${escapeHtml(badge)}</span>`
        : '';

      return `
        <article class="rounded-2xl border border-gray-200 p-3 hover:shadow transition">
          <div class="img-wrap cursor-pointer" data-open="${item.id}">
            <img loading="lazy" src="${img}" alt="${escapeHtml(title)}" />
          </div>
          <div class="mt-3 space-y-1">
            <div class="flex items-start justify-between gap-2">
              <h3 class="font-medium line-clamp-2">${escapeHtml(title)}</h3>
              ${badgeHtml}
            </div>
            <div class="text-xs text-gray-500">分類：${escapeHtml(cat)}</div>
            ${arrival ? `<div class="text-xs text-gray-500">到貨日：${escapeHtml(arrival)}</div>` : ''}
            ${item.note || item.remark ? `<div class="text-xs text-gray-500 line-clamp-2">${escapeHtml(item.note || item.remark)}</div>` : ''}
          </div>
        </article>
      `;
    }

    /** 渲染商品清單 */
    function renderGrid(list) {
      if (!list || list.length === 0) {
        els.grid.innerHTML = '';
        els.emptyState.classList.remove('hidden');
        return;
      }
      els.emptyState.classList.add('hidden');
      els.grid.innerHTML = list.map(renderCard).join('');

      // 綁定開啟 Modal
      els.grid.querySelectorAll('[data-open]').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.getAttribute('data-open');
          const item = list.find(x => String(x.id) === String(id));
          if (item) openModal(item);
        });
      });
    }

    /** 開啟 Modal */
    function openModal(item) {
      const title = item.title || item.name || `商品 #${item.id}`;
      els.modalTitle.textContent = title;
      els.f_id.textContent = item.code || item.sku || item.id || '-';
      els.f_category.textContent = item.category || item.type || '-';
      els.f_status.textContent = item.status || item.state || '-';
      els.f_arrival.textContent = item.arrival_date || item.arrival || '-';
      els.f_note.textContent = item.note || item.remark || '';

      currentImages = parseImages(item);
      if (currentImages.length === 0) {
        // 放一張空圖
        currentImages = [coverImage(item)];
      }
      currentImgIndex = 0;
      updateModalImage();
      renderThumbs();

      els.modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    /** 關閉 Modal */
    function closeModal() {
      els.modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    /** 更新主圖 */
    function updateModalImage() {
      els.modalMainImg.src = currentImages[currentImgIndex];
      // 更新縮圖 active 狀態
      Array.from(els.thumbStrip.children).forEach((t, idx) => {
        if (idx === currentImgIndex) t.classList.add('active');
        else t.classList.remove('active');
      });
    }

    /** 縮圖列 */
    function renderThumbs() {
      els.thumbStrip.innerHTML = currentImages.map((src, idx) => `
        <div class="thumb ${idx === 0 ? 'active':''}" data-idx="${idx}">
          <img loading="lazy" src="${src}" alt="thumb ${idx+1}" />
        </div>
      `).join('');

      els.thumbStrip.querySelectorAll('.thumb').forEach(div => {
        div.addEventListener('click', () => {
          const idx = Number(div.getAttribute('data-idx'));
          currentImgIndex = idx;
          updateModalImage();
        });
      });
    }

    // Modal 導覽
    els.btnPrev.addEventListener('click', () => {
      if (currentImages.length === 0) return;
      currentImgIndex = (currentImgIndex - 1 + currentImages.length) % currentImages.length;
      updateModalImage();
    });
    els.btnNext.addEventListener('click', () => {
      if (currentImages.length === 0) return;
      currentImgIndex = (currentImgIndex + 1) % currentImages.length;
      updateModalImage();
    });
    els.modalClose.addEventListener('click', closeModal);
    els.modal.addEventListener('click', (e) => {
      // 點背景關閉
      if (e.target === els.modal) closeModal();
    });
    window.addEventListener('keydown', (e) => {
      if (els.modal.classList.contains('hidden')) return;
      if (e.key === 'Escape') closeModal();
      if (e.key === 'ArrowLeft') els.btnPrev.click();
      if (e.key === 'ArrowRight') els.btnNext.click();
    });

    /** 依選取的 run 載入清單 */
    async function reloadByRunSelection() {
      const val = els.runSelect.value;
      if (val === 'all') {
        products = allProducts.slice();
        renderGrid(products);
        return;
      }
      if (val === 'recent') {
        if (!recentRunId) {
          products = [];
          renderGrid(products);
          return;
        }
        const list = await loadProductsByRun(recentRunId);
        products = list;
        renderGrid(products);
        return;
      }
      // 指定 run id
      const runId = Number(val);
      const list = await loadProductsByRun(runId);
      products = list;
      renderGrid(products);
    }

    /** 輔助：HTML escape */
    function escapeHtml(str) {
      return String(str ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /** 初始化 */
    async function init() {
      // 1) 公告
      loadAnnouncement().catch(()=>{});

      // 2) 載入 runs（含最近連線）
      await loadRuns();

      // 3) 預先撈全部商品（加速切換）
      allProducts = await loadAllProducts();
      products = allProducts.slice();
      renderGrid(products);

      // 4) 綁定下拉事件
      els.runSelect.addEventListener('change', reloadByRunSelection);
    }

    init();
  </script>
</body>
</html>
