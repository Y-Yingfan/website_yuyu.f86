<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Yuyu ä»£è³¼ï½œSelect Shop</title>
  <!-- LINE LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      /* earthy + wabi-sabi */
      --bg:#f5f3ef;          /* warm sand */
      --panel:#ffffff;       /* paper */
      --ink:#2f2f2f;         /* sumi ink */
      --muted:#6b6a62;       /* taupe */
      --line:#e6e2da;        /* light stroke */
      --accent:#c2a35d;      /* warm gold */
      --good:#2c7a47;        /* in stock */
      --warn:#a05b00;        /* preorder */
      --shadow:0 10px 28px rgba(0,0,0,.08)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif}
    .wrap{max-width:1060px;margin:0 auto;padding:18px}

    /* header */
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:4px 0 14px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(180deg,#fff,#f0ede6);border:1px solid var(--line);display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo span{filter:grayscale(.2)}
    h1{font-size:clamp(20px,4vw,28px);margin:0;letter-spacing:.5px}
    .actions{display:flex;gap:8px}
    .btn{padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:var(--panel);cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border:none}

    /* announcement */
    .ann{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:10px 12px;color:var(--muted);box-shadow:var(--shadow)}

    /* controls */
    .controls{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:10px;margin:12px 0}
    .control{background:var(--panel);border:1px solid var(--line);border-radius:12px;display:flex;align-items:center;padding:10px 12px;gap:10px}
    .control input,.control select{flex:1;border:none;background:transparent;outline:none;font-size:14px;color:var(--ink)}

    /* grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px;margin:12px 0 80px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;box-shadow:var(--shadow);transition:transform .15s}
    .card:hover{transform:translateY(-2px)}
    .pic{position:relative;aspect-ratio:4/3;background:linear-gradient(180deg,#fff,#f0ede6)}
    .pic img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .badge{position:absolute;left:10px;top:10px;padding:4px 8px;border-radius:999px;font-size:12px;color:#fff}
    .badge.stock{background:var(--good)}
    .badge.pre{background:var(--warn)}
    .meta{padding:12px 12px 8px}
    .meta h3{margin:0 0 6px;font-size:16px}
    .price{font-weight:800;color:#1f1f1f}
    .eta{color:var(--muted);font-size:12px;margin-left:6px}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .tag{border:1px solid var(--line);border-radius:999px;padding:3px 8px;font-size:12px;color:var(--muted)}
    .ops{display:flex;gap:8px;padding:10px 12px 14px}
    .op{flex:1;border:1px solid var(--line);border-radius:999px;background:#faf9f6;padding:9px 10px;font-size:14px;cursor:pointer}
    .op.primary{background:var(--accent);color:#fff;border:none}

    /* footer */
    footer{margin:50px 0 110px;color:var(--muted);font-size:13px}

    /* sticky cta */
    .cta{position:fixed;left:0;right:0;bottom:0;background:#fffaf0;border-top:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:center}
    .cta a{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#2f2f2f;text-decoration:none}
    .cta a.primary{background:var(--accent);color:#fff;border:none}

    /* toast */
    .toast{position:fixed;left:50%;bottom:84px;transform:translateX(-50%);background:#111;color:#fff;padding:8px 12px;border-radius:10px;font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s}
    .toast.show{opacity:1}

    /* Gate screens */
    .gate{max-width:720px;margin:24px auto 0;padding:14px;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);text-align:center}
    .gate h2{margin:6px 0 8px}
    .gate p{color:var(--muted);margin:6px 0}
    .gate .btns{display:flex;gap:10px;justify-content:center;margin-top:10px}
    .hide{display:none}
  </style>
</head>
<body>
  <!-- ===== CONFIG â€”â€”â€” æ”¹é€™è£¡ï¼ˆå››å€‹å€¼ï¼‰ ===== -->
  <script>
    const LIFF_ID = '2008022206-rqDnER1B';                        // LINE Developers çš„ LIFF ID
    const OA_LINK = 'https://lin.ee/zNusnCv';  // ä½ çš„å®˜æ–¹å¸³è™ŸåŠ å¥½å‹é€£çµï¼ˆå« @ï¼‰

    const SUPABASE_URL = 'https://yuyu.f86.supabase.co';  // Supabase Project URL
    const SUPABASE_ANON_KEY = 'sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';                // Supabase Publishable / anon key
    const DEV_MODE = false; // â† å¦‚éœ€æš«æ™‚ç•¥é LINE Gate ä»¥é è¦½å•†å“ï¼Œæ”¹æˆ true
  </script>

  <!-- Gate: 1) LINE ç™»å…¥ 2) åŠ å¥½å‹ 3) é¡¯ç¤ºå•†åº— -->
  <div id="gateLogin" class="gate">
    <h2>ç™»å…¥ LINE å¾Œé–‹å§‹é€›</h2>
    <p>ç‚ºäº†æä¾›å®¢æœèˆ‡å‡ºè²¨é€šçŸ¥ï¼Œè«‹å…ˆä»¥ LINE ç™»å…¥ã€‚</p>
    <div class="btns">
      <button class="btn primary" id="btnLineLogin">ä»¥ LINE ç™»å…¥</button>
    </div>
  </div>
  <div id="gateFriend" class="gate hide">
    <h2>åŠ å…¥å®˜æ–¹å¸³è™Ÿå¾Œç¹¼çºŒ</h2>
    <p>åŠ å…¥å¥½å‹å³å¯æ¥æ”¶è¨‚å–®é€²åº¦ã€è£œè²¨é€šçŸ¥èˆ‡å„ªæƒ ã€‚</p>
    <div class="btns">
      <a class="btn primary" id="btnAddFriend" target="_blank">åŠ å…¥ LINE å¥½å‹</a>
      <button class="btn" id="btnCheckFriend">æˆ‘å·²åŠ å…¥ï¼Œé‡æ–°ç¢ºèª</button>
    </div>
  </div>

  <div class="wrap hide" id="shopWrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><span>ğŸ›ï¸</span></div>
        <h1>Yuyu ä»£è³¼ï½œSelect Shop</h1>
      </div>
      <div class="actions">
        <button class="btn" id="btnPolicy">è³¼è²·é ˆçŸ¥</button>
        <a class="btn primary" href="https://www.threads.com/@yuyu.f86?hl=zh-tw" target="_blank">ç§è¨Šæˆ‘ä¸‹å–®</a>
      </div>
    </div>

    <div class="ann" id="announce">ğŸ“£ æœ¬é€±ä¸Šæ–°ï¼šé¦™æ°›æ“´é¦™ã€è—¥å¦è£œè²¨ã€MUJI ç†±éŠ·è£œå–®</div>

    <div class="controls">
      <label class="control" title="æœå°‹å•†å“é—œéµå­—">
        ğŸ”<input id="q" placeholder="æœå°‹ï¼šå“ç‰Œ / é—œéµå­— / ç·¨è™Ÿ" />
      </label>
      <label class="control" title="åˆ†é¡">
        ğŸ“‚
        <select id="cat">
          <option value="">å…¨éƒ¨åˆ†é¡</option>
          <option>é¦™æ°›</option>
          <option>è—¥å¦</option>
          <option>MUJI</option>
          <option>å¾¡å®ˆ & æ·¨åŒ–å™´éœ§</option>
          <option>è¶…å•†</option>
        </select>
      </label>
      <label class="control" title="æ’åº">
        â†•ï¸
        <select id="sort">
          <option value="new">æœ€æ–°ä¸Šæ¶</option>
          <option value="low">åƒ¹æ ¼ï¼šä½åˆ°é«˜</option>
          <option value="high">åƒ¹æ ¼ï¼šé«˜åˆ°ä½</option>
        </select>
      </label>
    </div>

    <div id="grid" class="grid" aria-live="polite" aria-atomic="true"></div>

    <footer>
      <details>
        <summary>è³¼è²·é ˆçŸ¥ / é€€æ›è²¨æ”¿ç­–</summary>
        <ol>
          <li>é è³¼å•†å“ç‚ºæµ·å¤–ä»£è³¼ï¼Œæ™‚ç¨‹ä¾ä¾›æ‡‰å•†èˆ‡èˆªé‹ç‚ºæº–ï¼Œé€šå¸¸ 7â€“21 å¤©ã€‚</li>
          <li>è‰²å·®ã€è¢å¹•é¡¯ç¤ºå·®ç•°å±¬æ­£å¸¸ï¼›å°ºå¯¸ä»¥å®˜æ–¹å°ºç¢¼ç‚ºæº–ã€‚</li>
          <li>å€‹äººè¡›ç”Ÿå“èˆ‡å®¢è£½åŒ–å•†å“ä¸å— 7 å¤©é‘‘è³ï¼Œè‹¥æœ‰ç‘•ç–µè«‹ 24h å…§ç§è¨Šã€‚</li>
          <li>ä¸‹å–®å‰è«‹å†æ¬¡ç¢ºèªé¡è‰²/å°ºå¯¸/æ•¸é‡ï¼›ä¸‹å–®å³åŒæ„ä¸Šè¿°è¦ç¯„ã€‚</li>
        </ol>
      </details>
    </footer>
  </div> <!-- /wrap -->

  <div class="cta hide" id="shopCta">
    <a class="primary" id="ctaOrder" href="https://www.threads.com/@yuyu.f86?hl=zh-tw" target="_blank">ç«‹å³ç§è¨Šä¸‹å–®</a>
    <a id="ctaCopy">è¤‡è£½ä¸‹å–®æ ¼å¼</a>
  </div>
  <div class="toast" id="toast">å·²è¤‡è£½ï¼Œä¸‹å–®è¨Šæ¯è²¼ä¸Šå³å¯ âœ¨</div>

  <script>
    // ===== Supabase Init =====
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Gate Elements =====
    const gateLogin = document.getElementById('gateLogin');
    const gateFriend = document.getElementById('gateFriend');
    const shopWrap = document.getElementById('shopWrap');
    const shopCta = document.getElementById('shopCta');

    async function initLiff(){
      try{
        await liff.init({ liffId: LIFF_ID });
        if(!liff.isLoggedIn()){
          gateLogin.classList.remove('hide');
          return;
        }
        gateLogin.classList.add('hide');
        await checkFriendship();
      }catch(e){
        console.error('LIFF init error', e);
        if(DEV_MODE){
          console.warn('DEV_MODE=TRUE â†’ ç•¥é Gate åƒ…ä¾›é è¦½');
          await bootShop();
          return;
        }
        gateLogin.classList.remove('hide');
      }
    }

    async function checkFriendship(){
      try{
        const res = await liff.getFriendship();
        if(res.friendFlag){
          gateFriend.classList.add('hide');
          await bootShop();
        }else{
          gateFriend.classList.remove('hide');
        }
      }catch(e){
        console.warn('getFriendship éœ€è¦ LIFF èˆ‡ OA åœ¨åŒä¸€å€‹ Messaging API Channelã€‚', e);
        gateFriend.classList.remove('hide');
      }
    }

    document.getElementById('btnLineLogin').addEventListener('click',()=>{
      if(!liff.isLoggedIn()) liff.login();
    });
    document.getElementById('btnAddFriend').setAttribute('href', OA_LINK);
    document.getElementById('btnCheckFriend').addEventListener('click', checkFriendship);

    // ===== è®€å–å•†å“ï¼ˆSupabase table: productsï¼‰ =====
    let PRODUCTS = [];

    async function fetchProductsFromSupabase(){
      const { data:rows, error } = await sb.from('products')
        .select('*')
        .order('created_at', { ascending:false });
      if(error) throw error;
      return (rows||[]).map(r=>({
        id:r.id,
        name:r.name,
        price:Number(r.price||0),
        category:r.category||'',
        status:r.status||'ç¾è²¨',
        eta:r.eta||'',
        img:r.img_url||'',
        tags:(r.tags||'').split('|').filter(Boolean)
      }));
    }

    async function bootShop(){
      try{
        PRODUCTS = await fetchProductsFromSupabase();
      }catch(err){
        console.error('Load products error:', err);
        PRODUCTS = [];
      }
      filterSort();
      shopWrap.classList.remove('hide');
      shopCta.classList.remove('hide');
    }

    // ===== Render =====
    const elGrid = document.getElementById('grid');
    const elQ = document.getElementById('q');
    const elCat = document.getElementById('cat');
    const elSort = document.getElementById('sort');
    const toast = document.getElementById('toast');

    function fmt(n){ return Number(n||0).toLocaleString('zh-TW'); }

    function placeholderEmoji(name){
      const m=[['åŒ…','ğŸ‘œ'],['è¡£','ğŸ‘•'],['å¦','ğŸ’„'],['æ¯','â˜•'],['éœœ','ğŸ§´'],['é¦™','ğŸ•¯ï¸']];
      for(const [k,e] of m){ if((name||'').includes(k)) return e; }
      return 'ğŸ›’'
    }

    function cardTpl(p){
      const badgeClass = p.status==='ç¾è²¨' ? 'stock' : 'pre';
      const badgeText = p.status==='ç¾è²¨' ? 'ç¾è²¨' : 'é è³¼';
      const tags = (p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('');
      const img = `<img alt="${p.name||''}" src="${p.img||''}">`;
      return `<article class="card" data-id="${p.id}">
        <div class="pic">
          ${img}
          <div class="badge ${badgeClass}">${badgeText}</div>
        </div>
        <div class="meta">
          <h3>${p.name||''}</h3>
          <div><span class="price">$${fmt(p.price)}</span><span class="eta">${p.status==='é è³¼' ? 'ãƒ»åˆ°è²¨ï¼š'+(p.eta||'ä¾å…¬å‘Š') : ''}</span></div>
          <div class="tags">${tags}</div>
        </div>
        <div class="ops">
          <button class="op" data-op="copy">è¤‡è£½ä¸‹å–®</button>
          <a class="op primary" data-op="dm" href="https://www.threads.com/@yuyu.f86?hl=zh-tw" target="_blank">è©¢å• / ä¸‹å–®</a>
        </div>
      </article>`
    }

    function render(list){
      elGrid.innerHTML = list.map(cardTpl).join('');
      // image fallback
      elGrid.querySelectorAll('.pic img').forEach(img=>{
        const name = img.getAttribute('alt')||'';
        img.onerror = ()=>{
          const ph = document.createElement('div');
          ph.style.cssText = 'position:absolute;inset:0;display:grid;place-items:center;color:#9a968b;font-size:34px;';
          ph.innerHTML = `<div style="text-align:center">${placeholderEmoji(name)}<div style="font-size:12px;margin-top:6px;opacity:.7">(é è¦½åœ–å¾…è£œ)</div></div>`;
          img.replaceWith(ph);
        }
      });
    }

    function filterSort(){
      const q = (elQ.value||'').trim().toLowerCase();
      const cat = elCat.value;
      const s = elSort.value;
      let list = PRODUCTS.filter(p=>{
        const hitQ = !q || `${p.id} ${p.name} ${p.category}`.toLowerCase().includes(q);
        const hitC = !cat || p.category===cat;
        return hitQ && hitC;
      });
      if(s==='low') list.sort((a,b)=>a.price-b.price);
      else if(s==='high') list.sort((a,b)=>b.price-a.price);
      render(list);
    }

    elQ.addEventListener('input', filterSort);
    elCat.addEventListener('change', filterSort);
    elSort.addEventListener('change', filterSort);

    // äº‹ä»¶ï¼šè¤‡è£½ä¸‹å–®æ ¼å¼
    elGrid.addEventListener('click', e=>{
      const btn = e.target.closest('[data-op]');
      if(!btn) return;
      const op = btn.getAttribute('data-op');
      const card = btn.closest('.card');
      const id = card?.getAttribute('data-id');
      const p = PRODUCTS.find(x=>x.id===id);
      if(!p) return;
      if(op==='copy'){
        const text = `ã€ä¸‹å–®ã€‘\nå•†å“ï¼š${p.name} (${p.id})\nåƒ¹æ ¼ï¼š$${fmt(p.price)}\næ•¸é‡ï¼š1\nè¦æ ¼ï¼š\næ”¶ä»¶äººï¼š\né›»è©±ï¼š\nåœ°å€ï¼š\nå‚™è¨»ï¼š`;
        navigator.clipboard.writeText(text).then(()=>showToast());
      }
    });

    // Sticky CTA copy
    document.getElementById('ctaCopy').addEventListener('click',()=>{
      const text = `ã€ä¸‹å–®ã€‘\nå•†å“ï¼šè«‹å¡«å¯«å•†å“åç¨±/ç·¨è™Ÿ\næ•¸é‡ï¼š1\nè¦æ ¼ï¼š\næ”¶ä»¶äººï¼š\né›»è©±ï¼š\nåœ°å€ï¼š\nå‚™è¨»ï¼š`;
      navigator.clipboard.writeText(text).then(()=>showToast());
    });

    function showToast(msg){
      const toast = document.getElementById('toast');
      toast.textContent = msg || 'å·²è¤‡è£½ï¼Œä¸‹å–®è¨Šæ¯è²¼ä¸Šå³å¯ âœ¨';
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),1400);
    }

    // å¿«æ·ï¼šé¡¯ç¤ºè³¼è²·é ˆçŸ¥
    document.getElementById('btnPolicy').addEventListener('click',()=>{
      const det = document.querySelector('footer details');
      det.open = true;
      window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
    });

    // å•Ÿå‹•
    if(DEV_MODE){
      // ç•¥é Gate é è¦½å•†å“ï¼ˆé–‹ç™¼ç”¨ï¼‰
      bootShop();
    }else{
      initLiff();
    }
  </script>
</body>

</html>
