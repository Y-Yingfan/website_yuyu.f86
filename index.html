<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä»£è³¼æ¸…å–®</title>

  <!-- Tailwind (ç´”å‰ç«¯ã€å¥½èª¿æ•´æ¨£å¼) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.3/dist/umd/supabase.min.js"></script>

  <style>
    /* å¡ç‰‡åœ–ç‰‡å®¹å™¨ï¼šå›ºå®šæ¯”ä¾‹é¿å…æ’ç‰ˆè·³å‹• */
    .img-wrap {
      position: relative;
      width: 100%;
      padding-top: 75%; /* 4:3 */
      overflow: hidden;
      border-radius: 0.75rem;
      background: #f3f4f6;
    }
    .img-wrap img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Modal åœ–ç‰‡å€ï¼šé«˜åº¦è‡ªé©æ‡‰ã€å«ä¸Šä¸€å¼µä¸‹ä¸€å¼µ */
    .modal-image-box {
      position: relative;
      width: 100%;
      height: min(70vh, 720px);
      background: #0b0b0b;
      border-radius: 0.75rem;
      overflow: hidden;
    }
    .modal-image-box img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: #0b0b0b;
    }
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.85);
      border-radius: 9999px;
      padding: 0.5rem 0.6rem;
      user-select: none;
    }
    .nav-btn:hover { background: white; }
    .nav-prev { left: 0.5rem; }
    .nav-next { right: 0.5rem; }

    /* ç¸®åœ–åˆ—ï¼šæ°´å¹³å·è»¸ã€é¸ä¸­é«˜äº® */
    .thumb-strip {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding-bottom: 0.25rem;
      scrollbar-width: thin;
    }
    .thumb {
      flex: 0 0 auto;
      width: 72px;
      height: 72px;
      border-radius: 0.5rem;
      background: #f3f4f6;
      overflow: hidden;
      border: 2px solid transparent;
      cursor: pointer;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .thumb.active {
      border-color: #111827;
    }

    /* é¿å…åœ–ç‰‡è¶…å‡ºç‰ˆé¢ï¼šå¡ç‰‡ã€modal éƒ½ä½¿ç”¨ object-fit: contain æ­é…å›ºå®šå®¹å™¨ */
  </style>
</head>
<body class="bg-white text-gray-900">
  <!-- é ‚éƒ¨ï¼šå…¬å‘Šï¼‹ç¯©é¸åˆ— -->
  <header class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">
    <!-- å…¬å‘Šæ¢ -->
    <div id="announcement" class="hidden mb-4 rounded-xl bg-amber-50 text-amber-900 px-4 py-3 text-sm"></div>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <h1 class="text-2xl font-bold">ä»£è³¼æ¸…å–®</h1>

      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
        <!-- é€£ç·šä¸‹æ‹‰ -->
        <label class="text-sm font-medium">é€£ç·šï¼š</label>
        <select id="runSelect"
                class="min-w-[220px] rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-800">
          <option value="all">å…¨éƒ¨é€£ç·š</option>
          <!-- ä¸‹é¢æœƒæ³¨å…¥ã€Œæœ€è¿‘é€£ç·šã€ä»¥åŠå„ run -->
        </select>
      </div>
    </div>
  </header>

  <!-- å•†å“æ¸…å–® -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div id="grid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
      <!-- JS æ³¨å…¥å¡ç‰‡ -->
    </div>

    <!-- ç©ºç‹€æ…‹ -->
    <div id="emptyState" class="hidden text-center text-gray-500 py-16">
      æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•†å“ã€‚
    </div>
  </main>

  <!-- Modal -->
  <div id="modal"
       class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4"
       aria-modal="true" role="dialog">
    <div class="w-full max-w-5xl bg-white rounded-2xl p-4 sm:p-6 shadow-2xl relative">
      <button id="modalClose"
              class="absolute right-3 top-3 rounded-full p-2 bg-gray-100 hover:bg-gray-200"
              aria-label="é—œé–‰">
        âœ•
      </button>

      <div class="grid gap-4 lg:grid-cols-2">
        <!-- å¤§åœ–å€ -->
        <div>
          <div class="modal-image-box">
            <img id="modalMainImg" src="" alt="å•†å“åœ–ç‰‡" />
            <button class="nav-btn nav-prev" id="btnPrev" aria-label="ä¸Šä¸€å¼µ">â€¹</button>
            <button class="nav-btn nav-next" id="btnNext" aria-label="ä¸‹ä¸€å¼µ">â€º</button>
          </div>
          <div id="thumbStrip" class="thumb-strip mt-3"></div>
        </div>

        <!-- è©³ç´°è³‡è¨Š -->
        <div class="space-y-3">
          <h2 id="modalTitle" class="text-xl font-semibold"></h2>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div class="space-y-1">
              <div class="text-gray-500">å•†å“ç·¨è™Ÿ</div>
              <div id="f_id" class="font-medium"></div>
            </div>
            <div class="space-y-1">
              <div class="text-gray-500">åˆ†é¡</div>
              <div id="f_category" class="font-medium"></div>
            </div>
            <div class="space-y-1">
              <div class="text-gray-500">ç‹€æ…‹</div>
              <div id="f_status" class="font-medium"></div>
            </div>
            <div class="space-y-1">
              <div class="text-gray-500">åˆ°è²¨æ—¥</div>
              <div id="f_arrival" class="font-medium"></div>
            </div>
          </div>

          <div class="space-y-1 text-sm">
            <div class="text-gray-500">å‚™è¨»</div>
            <div id="f_note" class="whitespace-pre-wrap"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ================== ğŸ”§ é€™è£¡æ›æˆä½ çš„å°ˆæ¡ˆè¨­å®š ================== */
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const STORAGE_BUCKET = 'YOUR_STORAGE_BUCKET'; // ä¾‹å¦‚ 'images'
    /* ============================================================ */

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM å…ƒç´ 
    const els = {
      announcement: document.getElementById('announcement'),
      runSelect: document.getElementById('runSelect'),
      grid: document.getElementById('grid'),
      emptyState: document.getElementById('emptyState'),
      modal: document.getElementById('modal'),
      modalClose: document.getElementById('modalClose'),
      modalTitle: document.getElementById('modalTitle'),
      f_id: document.getElementById('f_id'),
      f_category: document.getElementById('f_category'),
      f_status: document.getElementById('f_status'),
      f_arrival: document.getElementById('f_arrival'),
      f_note: document.getElementById('f_note'),
      modalMainImg: document.getElementById('modalMainImg'),
      thumbStrip: document.getElementById('thumbStrip'),
      btnPrev: document.getElementById('btnPrev'),
      btnNext: document.getElementById('btnNext'),
    };

    // ç›®å‰è³‡æ–™
    let runs = [];
    let products = [];      // ç›®å‰åˆ—è¡¨ï¼ˆä¾ç¯©é¸è¼‰å…¥ï¼‰
    let allProducts = [];   // å…¨éƒ¨å•†å“ï¼ˆåŠ é€Ÿåˆ‡æ›ï¼‰
    let recentRunId = null;

    // Modal ç‹€æ…‹
    let currentImages = [];
    let currentImgIndex = 0;

    /** å–å¾—å…¬å‘Šï¼šsite_meta è¡¨ä¸­éµåå„ªå…ˆé †åº */
    async function loadAnnouncement() {
      const keys = ['announcement', 'notice', 'headline'];
      const { data, error } = await sb
        .from('site_meta')
        .select('key,value')
        .in('key', keys);

      if (error) {
        console.warn('loadAnnouncement error', error);
        return;
      }
      if (!data || data.length === 0) return;

      // æ‰¾åˆ°ç¬¬ä¸€å€‹æœ‰å€¼çš„ key
      for (const k of keys) {
        const row = data.find(x => x.key === k && x.value && String(x.value).trim() !== '');
        if (row) {
          els.announcement.textContent = String(row.value);
          els.announcement.classList.remove('hidden');
          break;
        }
      }
    }

    /** å–å¾—æ‰€æœ‰é€£ç·šï¼ˆrunsï¼‰ï¼Œæ’åºæ–°åˆ°èˆŠï¼Œè¨­å®šã€Œæœ€è¿‘é€£ç·šã€ */
    async function loadRuns() {
      const { data, error } = await sb
        .from('runs')
        .select('id,name,created_at,start_date')
        .order('created_at', { ascending: false });

      if (error) {
        console.error('loadRuns error', error);
        return;
      }

      runs = data || [];
      // ã€Œæœ€è¿‘é€£ç·šã€å®šç¾©ï¼šä»¥ created_at æœ€æ–°ï¼›è‹¥æ²’æœ‰ created_at å°±å–ç¬¬ä¸€ç­†
      recentRunId = runs.length ? runs[0].id : null;

      // å¡«å…¥ä¸‹æ‹‰ï¼ˆä¿ç•™ã€Œå…¨éƒ¨é€£ç·šã€ï¼‰
      // å…ˆæ³¨å…¥ã€Œæœ€è¿‘é€£ç·šã€
      if (recentRunId) {
        const optRecent = document.createElement('option');
        optRecent.value = 'recent';
        optRecent.textContent = 'æœ€è¿‘é€£ç·š';
        els.runSelect.appendChild(optRecent);
      }

      // å†æ³¨å…¥å„ run
      for (const r of runs) {
        const opt = document.createElement('option');
        opt.value = String(r.id);
        opt.textContent = r.name || `é€£ç·š #${r.id}`;
        els.runSelect.appendChild(opt);
      }
    }

    /** å–å¾—å…¨éƒ¨å•†å“ï¼ˆç”¨æ–¼ã€Œå…¨éƒ¨é€£ç·šã€ï¼‰ */
    async function loadAllProducts() {
      const { data, error } = await sb
        .from('products')
        .select('*')
        .order('id', { ascending: false });

      if (error) {
        console.error('loadAllProducts error', error);
        return [];
      }
      return data || [];
    }

    /** ä¾ run å–å¾—å•†å“ï¼šé€é product_runs å°æ‡‰ */
    async function loadProductsByRun(runId) {
      // å…©æ®µå¼ï¼šå…ˆæ‰¾ product_idsï¼Œå†æ’ˆ productsï¼ˆé¿å…ä¸åŒ Supabase join æ¬„ä½åç¨±å·®ç•°ï¼‰
      const { data: links, error: e1 } = await sb
        .from('product_runs')
        .select('product_id')
        .eq('run_id', runId);

      if (e1) {
        console.error('loadProductsByRun link error', e1);
        return [];
      }
      const ids = (links || []).map(x => x.product_id);
      if (ids.length === 0) return [];

      const { data: items, error: e2 } = await sb
        .from('products')
        .select('*')
        .in('id', ids)
        .order('id', { ascending: false });

      if (e2) {
        console.error('loadProductsByRun items error', e2);
        return [];
      }
      return items || [];
    }

    /** è§£æç”¢å“åœ–ç‰‡æ¬„ä½ï¼šæ”¯æ´ array / é€—è™Ÿ / åˆ†è™Ÿ / æ›è¡Œ */
    function parseImages(product) {
      const bucket = STORAGE_BUCKET;
      const candidates = [
        product.images,
        product.image_paths,
        product.image_path,
        product.image,
        product.pictures,
        product.photo_paths,
      ].filter(Boolean);

      let raw = [];
      if (candidates.length) {
        const v = candidates[0];
        if (Array.isArray(v)) {
          raw = v;
        } else if (typeof v === 'string') {
          raw = v.split(/[\n;,]+/);
        }
      }
      // å»ç©ºç™½
      raw = raw.map(s => String(s).trim()).filter(Boolean);

      // è½‰æˆå…¬é–‹ URLï¼ˆä½¿ç”¨ storage public URLï¼‰
      // è‹¥ä½ çš„åœ–ç‰‡å·²ç¶“æ˜¯å®Œæ•´ https URLï¼Œå‰‡ç›´æ¥ä½¿ç”¨
      return raw.map(p => {
        if (/^https?:\/\//i.test(p)) return p;
        // Supabase Storage publicUrl
        const { data } = sb.storage.from(bucket).getPublicUrl(p);
        return data?.publicUrl || p; // è‹¥æœªè¨­å®šå…¬é–‹ï¼Œä»å›å‚³åŸå­—ä¸²ä»¥åˆ©åµéŒ¯
      });
    }

    /** å–®å¼µä»£è¡¨åœ–ï¼šå–ç¬¬ä¸€å¼µ */
    function coverImage(product) {
      const imgs = parseImages(product);
      if (imgs.length) return imgs[0];
      // ç„¡åœ–å‚™ç”¨
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="450">
          <rect width="100%" height="100%" fill="#f3f4f6"/>
          <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-family="sans-serif" font-size="20">
            No Image
          </text>
        </svg>
      `);
    }

    /** å¡ç‰‡ HTML */
    function renderCard(item) {
      const title = item.title || item.name || `å•†å“ #${item.id}`;
      const img = coverImage(item);
      const cat = item.category || item.type || '-';
      const badge = item.status || item.state || '';
      const arrival = item.arrival_date || item.arrival || '';

      const badgeHtml = badge
        ? `<span class="inline-block text-xs px-2 py-0.5 rounded-full bg-gray-900 text-white">${escapeHtml(badge)}</span>`
        : '';

      return `
        <article class="rounded-2xl border border-gray-200 p-3 hover:shadow transition">
          <div class="img-wrap cursor-pointer" data-open="${item.id}">
            <img loading="lazy" src="${img}" alt="${escapeHtml(title)}" />
          </div>
          <div class="mt-3 space-y-1">
            <div class="flex items-start justify-between gap-2">
              <h3 class="font-medium line-clamp-2">${escapeHtml(title)}</h3>
              ${badgeHtml}
            </div>
            <div class="text-xs text-gray-500">åˆ†é¡ï¼š${escapeHtml(cat)}</div>
            ${arrival ? `<div class="text-xs text-gray-500">åˆ°è²¨æ—¥ï¼š${escapeHtml(arrival)}</div>` : ''}
            ${item.note || item.remark ? `<div class="text-xs text-gray-500 line-clamp-2">${escapeHtml(item.note || item.remark)}</div>` : ''}
          </div>
        </article>
      `;
    }

    /** æ¸²æŸ“å•†å“æ¸…å–® */
    function renderGrid(list) {
      if (!list || list.length === 0) {
        els.grid.innerHTML = '';
        els.emptyState.classList.remove('hidden');
        return;
      }
      els.emptyState.classList.add('hidden');
      els.grid.innerHTML = list.map(renderCard).join('');

      // ç¶å®šé–‹å•Ÿ Modal
      els.grid.querySelectorAll('[data-open]').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.getAttribute('data-open');
          const item = list.find(x => String(x.id) === String(id));
          if (item) openModal(item);
        });
      });
    }

    /** é–‹å•Ÿ Modal */
    function openModal(item) {
      const title = item.title || item.name || `å•†å“ #${item.id}`;
      els.modalTitle.textContent = title;
      els.f_id.textContent = item.code || item.sku || item.id || '-';
      els.f_category.textContent = item.category || item.type || '-';
      els.f_status.textContent = item.status || item.state || '-';
      els.f_arrival.textContent = item.arrival_date || item.arrival || '-';
      els.f_note.textContent = item.note || item.remark || '';

      currentImages = parseImages(item);
      if (currentImages.length === 0) {
        // æ”¾ä¸€å¼µç©ºåœ–
        currentImages = [coverImage(item)];
      }
      currentImgIndex = 0;
      updateModalImage();
      renderThumbs();

      els.modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    /** é—œé–‰ Modal */
    function closeModal() {
      els.modal.classList.add('hidden');
      document.body.style.overflow = '';
    }

    /** æ›´æ–°ä¸»åœ– */
    function updateModalImage() {
      els.modalMainImg.src = currentImages[currentImgIndex];
      // æ›´æ–°ç¸®åœ– active ç‹€æ…‹
      Array.from(els.thumbStrip.children).forEach((t, idx) => {
        if (idx === currentImgIndex) t.classList.add('active');
        else t.classList.remove('active');
      });
    }

    /** ç¸®åœ–åˆ— */
    function renderThumbs() {
      els.thumbStrip.innerHTML = currentImages.map((src, idx) => `
        <div class="thumb ${idx === 0 ? 'active':''}" data-idx="${idx}">
          <img loading="lazy" src="${src}" alt="thumb ${idx+1}" />
        </div>
      `).join('');

      els.thumbStrip.querySelectorAll('.thumb').forEach(div => {
        div.addEventListener('click', () => {
          const idx = Number(div.getAttribute('data-idx'));
          currentImgIndex = idx;
          updateModalImage();
        });
      });
    }

    // Modal å°è¦½
    els.btnPrev.addEventListener('click', () => {
      if (currentImages.length === 0) return;
      currentImgIndex = (currentImgIndex - 1 + currentImages.length) % currentImages.length;
      updateModalImage();
    });
    els.btnNext.addEventListener('click', () => {
      if (currentImages.length === 0) return;
      currentImgIndex = (currentImgIndex + 1) % currentImages.length;
      updateModalImage();
    });
    els.modalClose.addEventListener('click', closeModal);
    els.modal.addEventListener('click', (e) => {
      // é»èƒŒæ™¯é—œé–‰
      if (e.target === els.modal) closeModal();
    });
    window.addEventListener('keydown', (e) => {
      if (els.modal.classList.contains('hidden')) return;
      if (e.key === 'Escape') closeModal();
      if (e.key === 'ArrowLeft') els.btnPrev.click();
      if (e.key === 'ArrowRight') els.btnNext.click();
    });

    /** ä¾é¸å–çš„ run è¼‰å…¥æ¸…å–® */
    async function reloadByRunSelection() {
      const val = els.runSelect.value;
      if (val === 'all') {
        products = allProducts.slice();
        renderGrid(products);
        return;
      }
      if (val === 'recent') {
        if (!recentRunId) {
          products = [];
          renderGrid(products);
          return;
        }
        const list = await loadProductsByRun(recentRunId);
        products = list;
        renderGrid(products);
        return;
      }
      // æŒ‡å®š run id
      const runId = Number(val);
      const list = await loadProductsByRun(runId);
      products = list;
      renderGrid(products);
    }

    /** è¼”åŠ©ï¼šHTML escape */
    function escapeHtml(str) {
      return String(str ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /** åˆå§‹åŒ– */
    async function init() {
      // 1) å…¬å‘Š
      loadAnnouncement().catch(()=>{});

      // 2) è¼‰å…¥ runsï¼ˆå«æœ€è¿‘é€£ç·šï¼‰
      await loadRuns();

      // 3) é å…ˆæ’ˆå…¨éƒ¨å•†å“ï¼ˆåŠ é€Ÿåˆ‡æ›ï¼‰
      allProducts = await loadAllProducts();
      products = allProducts.slice();
      renderGrid(products);

      // 4) ç¶å®šä¸‹æ‹‰äº‹ä»¶
      els.runSelect.addEventListener('change', reloadByRunSelection);
    }

    init();
  </script>
</body>
</html>
