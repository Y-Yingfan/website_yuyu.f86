<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>旅游人生選物代購｜Select Shop</title>
<style>
  :root{--bg:#f7f3ef;--paper:#fffdf9;--card:#fff;--ink:#2b2b2b;--muted:#7a7267;--brand:#8B5E34;--brand-2:#C2A27A;--accent:#7F8C5B;--border:#eadfcd;--shadow:0 12px 30px rgba(139,94,52,.08);--radius:16px;--maxw:1100px;--gap:16px;--thumb-h:170px}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#f8f5f1 0%, var(--bg) 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial}
  a{color:var(--brand)} img{display:block}
  .topbar{position:sticky;top:0;z-index:50;background:rgba(247,243,239,.75);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:14px 18px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{width:42px;height:42px;object-fit:contain}
  .title{font-weight:800}.subtitle{font-weight:700;color:var(--brand)}
  #toolbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:8px}
  #toolbar input,#toolbar select{padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fffdfa}
  .container{max-width:var(--maxw);margin:18px auto;padding:0 18px}
  .notice{background:#fffdfa;border:1px dashed var(--border);border-radius:14px;padding:10px 12px}
  .runs{display:flex;gap:12px;overflow:auto;padding-bottom:4px;margin-top:12px}
  .runCard{min-width:230px;background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:12px;cursor:pointer}
  .runCard .muted{color:var(--muted);font-size:12px}

  #productList{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:var(--gap);margin-top:12px}
  .card{border:1px solid var(--border);border-radius:var(--radius);background:var(--card);overflow:hidden;box-shadow:var(--shadow);cursor:pointer;transition:.08s}
  .card:hover{transform:translateY(-2px);box-shadow:0 18px 40px rgba(139,94,52,.12)}
  .thumb{height:var(--thumb-h);background:#f2eee7;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:contain}
  .pad{padding:12px 14px}
  .name{font-size:14px;line-height:1.35;margin:0 0 6px}
  .price{color:#b03c2f;font-weight:800}
  .cat{margin-top:4px;font-size:12px;color:var(--muted)}

  #loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  #emptyTip{color:var(--muted);text-align:center}

  .modal{display:none;position:fixed;inset:0;z-index:1000}
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .panel{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(980px,92vw);max-height:88vh;overflow:auto;background:var(--paper);border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);display:grid;grid-template-columns:1fr 1fr;gap:22px;padding:20px}
  @media (max-width:820px){.panel{grid-template-columns:1fr}}

  .bigimg{position:relative;width:100%;aspect-ratio:4/3;background:#0b0b0b;border-radius:14px;overflow:hidden}
  .bigimg img{width:100%;height:100%;object-fit:contain;background:#0b0b0b}
  .nav-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(255,255,255,.9);border:none;border-radius:999px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow)}
  .nav-btn:hover{background:#fff}
  .nav-prev{left:8px}.nav-next{right:8px}
  .thumbs{display:flex;gap:8px;overflow:auto;margin-top:10px;padding-bottom:4px}
  .t{flex:0 0 auto;width:66px;height:66px;border-radius:10px;overflow:hidden;border:2px solid transparent;background:#f2eee7;cursor:pointer}
  .t img{width:100%;height:100%;object-fit:cover}
  .t.active{border-color:#111}

  .btnrow{display:flex;gap:10px;margin-top:12px}
  .btn{border:none;border-radius:12px;padding:12px 16px;font-size:14px;cursor:pointer;box-shadow:var(--shadow)}
  .btn.copy{background:#f4efe7}.btn.ask{background:var(--brand);color:#fff}

  .modal-sm .panel{width:min(520px,92vw);grid-template-columns:1fr}
  .linkBox{display:flex;gap:12px;flex-direction:column}
  .linkBtn{display:flex;justify-content:space-between;align-items:center;text-decoration:none;padding:14px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;color:var(--ink);box-shadow:var(--shadow)}
  .linkBtn .l{display:flex;align-items:center;gap:10px}.dot{width:10px;height:10px;border-radius:999px}.dot.green{background:#00B900}.dot.blue{background:#4f7dbf}

  .kv{display:grid;grid-template-columns:92px 1fr;gap:6px 10px;font-size:14px;margin:10px 0}
  .kv .k{color:var(--muted)}
</style>
</head>
<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div class="brand">
          <img src="LOGO.png" alt="logo" />
          <div>
            <div class="title" style="font-size:22px;">旅游人生選物代購</div>
            <div class="subtitle">Select Shop</div>
          </div>
        </div>

        <div id="toolbar">
          <input type="text" id="searchInput" placeholder="搜尋商品…" />
          <select id="runFilter">
            <option value="">全部連線</option>
            <!-- 這裡會動態插入：最近連線 & 其他連線 -->
          </select>
          <select id="categoryFilter"><option value="">全部分類</option></select>
          <select id="sortSelect">
            <option value="newest">上架時間：新到舊</option>
            <option value="oldest">上架時間：舊到新</option>
            <option value="priceAsc">價格：低到高</option>
            <option value="priceDesc">價格：高到低</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div id="loading">載入中…</div>

  <div id="home" class="container" style="display:none">
    <div id="homeNotice" class="notice"></div>
    <h3 style="margin:12px 0 6px">最近連線</h3>
    <div id="homeRuns" class="runs"></div>
  </div>

  <div id="shopPage" class="container" style="display:none">
    <div id="productList"></div>
    <p id="emptyTip" class="muted" style="display:none;margin-top:12px">目前沒有商品</p>
  </div>

  <!-- 詳情 Modal -->
  <div id="detailModal" class="modal">
    <div class="overlay"></div>
    <div class="panel">
      <div>
        <div class="bigimg">
          <img id="dImg" alt="">
          <button class="nav-btn nav-prev" id="btnPrev" aria-label="上一張">‹</button>
          <button class="nav-btn nav-next" id="btnNext" aria-label="下一張">›</button>
        </div>
        <div class="thumbs" id="thumbs"></div>
      </div>

      <div class="detail">
        <h2 id="dName" style="margin:0 0 6px"></h2>
        <div class="kv">
          <div class="k">商品編號</div><div id="dId">-</div>
          <div class="k">分類</div><div id="dCat">-</div>
          <div class="k">狀態</div><div id="dStatus">-</div>
          <div class="k">到貨日</div><div id="dArrival">-</div>
          <div class="k">備註</div><div id="dNote">-</div>
        </div>
        <div style="margin:10px 0 4px"><span class="price" id="dPrice"></span></div>
        <div id="dTags" style="margin:10px 0"></div>
        <div class="btnrow"><button class="btn copy" id="btnCopy">複製下單格式</button><button class="btn ask" id="btnAsk">詢問／下單</button></div>
      </div>
    </div>
  </div>

  <!-- 連絡 Modal -->
  <div id="linksModal" class="modal modal-sm">
    <div class="overlay"></div>
    <div class="panel">
      <div>
        <h3 style="margin:0 0 12px">選擇聯絡方式</h3>
        <p class="muted" style="margin:0 0 12px">下單系統尚在建置，請先用以下任一方式與我聯繫：</p>
        <div class="linkBox">
          <a class="linkBtn" target="_blank" href="https://line.me/R/ti/p/@958xfkot"><div class="l"><span class="dot green"></span><strong>官方 LINE</strong></div><span class="muted">點擊加入</span></a>
          <a class="linkBtn" target="_blank" href="https://line.me/ti/g2/fRmTHOkmCy8ite62TzDencHTqlruXj6um0DT7g"><div class="l"><span class="dot blue"></span><strong>LINE 社群</strong></div><span class="muted">密碼：0628</span></a>
        </div>
        <div style="text-align:right;margin-top:14px"><button id="linksClose" class="btn" style="background:#fffaf2">關閉</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === Supabase 設定（你的值） ===
    const supabaseUrl='https://llbpmqyjigovxixeohzr.supabase.co';
    const supabaseKey='sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
    const BUCKET='yuyu.f86';
    const supabaseClient=supabase.createClient(supabaseUrl,supabaseKey);

    // === 狀態 ===
    let productsData=[], runs=[], productRuns=[], OPTIONS={categories:[]};
    let recentRunId=null;           // 真 run 的 id 或 pseudo id
    const RUN_PSEUDO_PREFIX='p:';   // 以產品萃取的「字串連線」id 前綴
    const runIdToLabel=new Map();   // 真 run -> 顯示名稱（title|code|region）

    // === Helpers ===
    const fmt=(n)=>n==null?'':'NT$'+Number(n||0).toLocaleString('zh-TW');
    function publicUrlFromPath(path){ if(!path) return ''; const { data }=supabaseClient.storage.from(BUCKET).getPublicUrl(path); return data?.publicUrl||''; }
    function byNew(a,b){ if(a.created_at&&b.created_at) return new Date(b.created_at)-new Date(a.created_at); if(a.id&&b.id) return (''+b.id).localeCompare(''+a.id); return 0; }
    function runLabelFromProduct(p){ return (p.eta_text||p.run_label||p.run||p.batch||'').trim(); }

    function parseImages(p){
      const candidate = p.images ?? p.image_paths ?? p.image ?? p.pictures ?? p.photo_paths ?? '';
      let arr=[];
      if(Array.isArray(candidate)) arr=candidate;
      else if(typeof candidate==='string') arr=candidate.split(/[\n;,]+/);
      if(p.img_url) arr.unshift(p.img_url);
      arr = arr.map(s=>String(s||'').trim()).filter(Boolean);
      return arr.map(s => /^https?:\/\//i.test(s) ? s : publicUrlFromPath(s));
    }

    // === 卡片 ===
    function cardHTML(p){
      const cover=(parseImages(p)[0]||'');
      return `<div class="card" data-id="${p.id}">
        <div class="thumb">${cover?`<img src="${cover}" alt="">`:''}</div>
        <div class="pad">
          <p class="name">${(p.name||'未命名')}</p>
          <div class="price">${fmt(p.price)}</div>
          ${p.category?`<div class="cat">${p.category}</div>`:''}
        </div>
      </div>`;
    }
    function renderList(list){
      const box=document.getElementById('productList'), empty=document.getElementById('emptyTip');
      if(!list||list.length===0){ box.innerHTML=''; empty.style.display='block'; return; }
      empty.style.display='none'; box.innerHTML=list.map(cardHTML).join('');
    }

    // === 以產品建立「字串連線」fallback ===
    function buildPseudoRunsFromProducts(prods){
      const groups = new Map(); // label -> latestCreatedAt
      prods.forEach(p=>{
        const label = runLabelFromProduct(p);
        if(!label) return;
        const ts = p.created_at ? new Date(p.created_at).getTime() : 0;
        groups.set(label, Math.max(groups.get(label)||0, ts));
      });
      return [...groups.entries()]
        .sort((a,b)=>b[1]-a[1])
        .map(([label])=>({ id: RUN_PSEUDO_PREFIX+encodeURIComponent(label), title: label, pseudo: true }));
    }

    // === 首頁的連線卡（仍然只顯示 runs.is_featured） ===
    function renderHomeRuns(){
      const wrap=document.getElementById('homeRuns'); wrap.innerHTML='';
      runs.filter(r=>!r.pseudo && r.is_featured).forEach(r=>{
        const name=r.title||r.code||r.region||('連線#'+r.id);
        const el=document.createElement('div'); el.className='runCard';
        el.innerHTML=`<div><strong>${name}</strong></div>
          <div class="muted">${r.start_date||''}${r.end_date?(' ~ '+r.end_date):''}</div>
          ${r.ship_start_date?`<div class="muted">寄送：${r.ship_start_date}</div>`:''}
          ${r.note?`<div style="margin-top:6px">${r.note}</div>`:''}`;
        el.onclick=()=>{ document.getElementById('runFilter').value=String(r.id); applyFilters(); window.scrollTo({top:document.getElementById('shopPage').offsetTop-10,behavior:'smooth'}); };
        wrap.appendChild(el);
      });
    }

    // === 篩選 ===
    function applyFilters(){
      const kw=(document.getElementById('searchInput').value||'').toLowerCase();
      const cat=document.getElementById('categoryFilter').value;
      const sort=document.getElementById('sortSelect').value;
      const sel=document.getElementById('runFilter').value;

      let matchFn = ()=>true; // 預設：全部連線
      if(sel==='__recent'){ // 最近
        if(String(recentRunId).startsWith(RUN_PSEUDO_PREFIX)){
          const label = decodeURIComponent(String(recentRunId).slice(RUN_PSEUDO_PREFIX.length));
          matchFn = p => runLabelFromProduct(p)===label;
        }else{
          const ids = new Set(productRuns.filter(x=>String(x.run_id)===String(recentRunId)).map(x=>String(x.product_id)));
          matchFn = p => ids.has(String(p.id));
        }
      }else if(sel){ // 指定某連線
        if(String(sel).startsWith(RUN_PSEUDO_PREFIX)){
          const label = decodeURIComponent(String(sel).slice(RUN_PSEUDO_PREFIX.length));
          matchFn = p => runLabelFromProduct(p)===label;
        }else{
          const ids = new Set(productRuns.filter(x=>String(x.run_id)===String(sel)).map(x=>String(x.product_id)));
          // 若沒有對應關係（可能沒建 product_runs），退回用產品的文字連線比
          if(ids.size>0){
            matchFn = p => ids.has(String(p.id));
          }else{
            const label = runIdToLabel.get(String(sel)) || '';
            matchFn = p => label && runLabelFromProduct(p)===label;
          }
        }
      }

      let list = productsData.filter(p=>{
        if(!matchFn(p)) return false;
        const text=`${p.name||''} ${p.eta_text||''} ${(Array.isArray(p.tags)?p.tags.join(','):(p.tags||''))}`.toLowerCase();
        const hitKw=!kw||text.includes(kw);
        const hitCat=!cat||p.category===cat;
        return hitKw&&hitCat;
      });

      if(sort==='priceAsc') list.sort((a,b)=>(+a.price||0)-(+b.price||0));
      else if(sort==='priceDesc') list.sort((a,b)=>(+b.price||0)-(+a.price||0));
      else if(sort==='newest') list.sort(byNew);
      else if(sort==='oldest') list.sort((a,b)=>-byNew(a,b));

      renderList(list);
    }

    // === 詳情（圖庫） ===
    const detailModal=document.getElementById('detailModal');
    detailModal.querySelector('.overlay').addEventListener('click',()=> detailModal.style.display='none');
    let galleryImages=[], galleryIndex=0;
    function buildThumbs(){ const bar=document.getElementById('thumbs'); bar.innerHTML=''; galleryImages.forEach((src,idx)=>{ const d=document.createElement('div'); d.className='t'+(idx===galleryIndex?' active':''); d.innerHTML=`<img src="${src}" loading="lazy">`; d.onclick=()=>{ galleryIndex=idx; updateBig(); }; bar.appendChild(d); }); }
    function updateBig(){ const img=document.getElementById('dImg'); img.src=galleryImages[galleryIndex]||''; Array.from(document.getElementById('thumbs').children).forEach((el,i)=>el.classList.toggle('active',i===galleryIndex)); }
    document.getElementById('btnPrev').addEventListener('click',()=>{ if(!galleryImages.length) return; galleryIndex=(galleryIndex-1+galleryImages.length)%galleryImages.length; updateBig(); });
    document.getElementById('btnNext').addEventListener('click',()=>{ if(!galleryImages.length) return; galleryIndex=(galleryIndex+1)%galleryImages.length; updateBig(); });
    window.addEventListener('keydown',e=>{ if(detailModal.style.display!=='block') return; if(e.key==='ArrowLeft') document.getElementById('btnPrev').click(); if(e.key==='ArrowRight') document.getElementById('btnNext').click(); if(e.key==='Escape') detailModal.style.display='none'; });
    function openDetail(id){
      const p=productsData.find(x=>String(x.id)===String(id)); if(!p) return;
      galleryImages=parseImages(p); if(!galleryImages.length) galleryImages=[''];
      galleryIndex=0; buildThumbs(); updateBig();
      dName.textContent=p.name||''; dId.textContent=p.product_id??p.id??'-'; dCat.textContent=p.category||'-';
      dStatus.textContent=p.status||'-'; dArrival.textContent=p.arrival_time||p.arrival_date||'-'; dNote.textContent=(p.note||p.remark||p.eta_text||'-');
      dPrice.textContent=fmt(p.price);
      const tagsBox=document.getElementById('dTags'); tagsBox.innerHTML=''; (Array.isArray(p.tags)?p.tags:[]).forEach(t=>{ const s=document.createElement('span'); s.style.cssText='display:inline-block;padding:3px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-right:6px'; s.textContent=t; tagsBox.appendChild(s); });
      btnCopy.onclick=()=>navigator.clipboard.writeText(`我要下單：${p.name||''} 1件（商品編號：${p.product_id??p.id}）`).then(()=>alert('已複製下單格式'));
      btnAsk.onclick=()=> linksModal.style.display='block';
      detailModal.style.display='block';
    }
    document.getElementById('productList').addEventListener('click', e=>{ let el=e.target; while(el && !el.classList.contains('card')) el=el.parentElement; if(el) openDetail(el.getAttribute('data-id')); });

    // === Supabase 讀取 ===
    async function fetchRuns(){
      // 嘗試 created_at 排序；失敗就不排序
      let res = await supabaseClient.from('runs').select('id,code,title,region,start_date,end_date,note,ship_start_date,is_featured,created_at').order('created_at',{ascending:false});
      if(res.error){ console.warn('runs created_at 排序失敗，走無排序',res.error); res = await supabaseClient.from('runs').select('id,code,title,region,start_date,end_date,note,ship_start_date,is_featured'); }
      return res.data||[];
    }
    async function fetchProductRuns(runIds){
      let q=supabaseClient.from('product_runs').select('product_id,run_id');
      if(runIds?.length) q=q.in('run_id',runIds);
      const { data, error }=await q; if(error){ console.error('product_runs error',error); return []; }
      return data||[];
    }
    async function fetchProducts(){
      const { data, error }=await supabaseClient.from('products').select('*');
      if(error){ console.error('products error',error); return []; }
      return data||[];
    }
    async function loadOptions(){
      try{ const { data, error }=await supabaseClient.storage.from(BUCKET).download('admin/options.json'); if(!error&&data){ const json=JSON.parse(await data.text()); if(Array.isArray(json.categories)) OPTIONS.categories=json.categories; } }catch(_){}
    }

    // === UI 注入 ===
    function fillCategories(){
      const sel=document.getElementById('categoryFilter');
      sel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
      const values=[...new Set([... (OPTIONS.categories||[]), ...productsData.map(p=>p.category).filter(Boolean)])]
        .sort((a,b)=>a.localeCompare(b,'zh-Hant'));
      values.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
    }
    function fillRuns(){
      const sel=document.getElementById('runFilter');
      sel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());

      // 最近連線
      if(recentRunId!=null){
        const o=document.createElement('option'); o.value='__recent'; o.textContent='最近連線'; sel.appendChild(o);
      }

      // 真 runs
      runs.filter(r=>!r.pseudo).forEach(r=>{
        const name=r.title||r.code||r.region||(`連線#${r.id}`);
        runIdToLabel.set(String(r.id), name);
        const o=document.createElement('option'); o.value=String(r.id); o.textContent=name; sel.appendChild(o);
      });

      // 假 runs（以產品萃取）
      runs.filter(r=>r.pseudo).forEach(r=>{
        const o=document.createElement('option'); o.value=r.id; o.textContent=r.title; sel.appendChild(o);
      });
    }

    async function loadHomeNotice(){
      const { data }=await supabaseClient.from('site_meta').select('value').eq('key','home_notice').maybeSingle();
      document.getElementById('homeNotice').textContent=data?.value||'';
      document.getElementById('home').style.display='block';
    }

    // === 啟動 ===
    async function enterShop(){
      document.getElementById('loading').style.display='none';
      document.getElementById('shopPage').style.display='block';

      await loadOptions();
      // 先抓產品（供 fallback 用）
      productsData = await fetchProducts();

      // 再抓 runs
      let realRuns = await fetchRuns();

      // 如果沒有真 runs，就用產品的 eta_text 等欄位建「字串連線」
      if(!realRuns || realRuns.length===0){
        runs = buildPseudoRunsFromProducts(productsData);
      }else{
        runs = realRuns;
      }

      // 以「最新」當最近連線
      if(runs.length){
        if(runs[0].pseudo){
          recentRunId = runs[0].id; // 已按最新產品排序
        }else{
          // 真 runs 直接取第 1 筆；若要改規則可調整
          recentRunId = runs[0].id;
        }
      }

      // 如果有真 runs，就抓對應關係
      if(runs.some(r=>!r.pseudo)){
        const realIds = runs.filter(r=>!r.pseudo).map(r=>r.id);
        productRuns = await fetchProductRuns(realIds);
      } else {
        productRuns = []; // 全靠文字連線比對
      }

      await loadHomeNotice();
      fillCategories();
      fillRuns();
      renderHomeRuns();
      applyFilters();
    }

    // 事件
    document.getElementById('searchInput').addEventListener('input',applyFilters);
    document.getElementById('categoryFilter').addEventListener('change',applyFilters);
    document.getElementById('sortSelect').addEventListener('change',applyFilters);
    document.getElementById('runFilter').addEventListener('change',applyFilters);

    enterShop();
  </script>
</body>
</html>
