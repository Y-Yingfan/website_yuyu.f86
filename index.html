<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>旅遊人生選物代購｜Select Shop</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<style>
:root{
  --bg:#f7f3ef;--paper:#fffdf9;--card:#fff;--ink:#2b2b2b;--muted:#7a7267;
  --brand:#8B5E34;--border:#eadfcd;--shadow:0 10px 24px rgba(139,94,52,.08);
  --radius:14px;--maxw:1100px
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#f8f5f1, #f7f3ef);color:var(--ink);
     font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial}
.wrap{max-width:var(--maxw);margin:12px auto;padding:0 14px}
.top{display:flex;align-items:center;gap:12px}
.top img.logo{height:32px;width:auto}
.top h1{font-size:18px;font-weight:800;margin:0}
.top small{display:block;color:#7a7267;margin-top:-2px}

/* 工具列（橫排） */
.toolbar{display:flex;gap:10px;align-items:center;margin:10px 0 14px}
#q{width:260px}                 /* 只縮小搜尋框，其餘照舊 */
.toolbar select{min-width:160px}
.toolbar .spacer{flex:1}        /* 把「我要許願」推到最右側 */

input,select,button,textarea{border:1px solid var(--border);border-radius:999px;padding:9px 12px;background:#fff}
select{padding-right:28px}
button{background:var(--brand);color:#fff;cursor:pointer}
.btn-ghost{background:#fff;color:#2b2b2b}

.notice{border:1px dashed var(--border);background:#fff;width:100%;padding:10px;border-radius:12px;color:#584c3f}
.section-title{font-weight:800;margin:14px 0 8px}
.runs{display:flex;gap:10px;flex-wrap:wrap}
.run{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px;min-width:240px}

.grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(260px,1fr));gap:12px}
.card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
.card .thumb{height:220px;background:#f5efe7;display:flex;align-items:center;justify-content:center}
.card .thumb img{max-width:100%;max-height:100%;object-fit:contain}
.card .body{padding:10px}
.price{color:#b24e00;font-weight:800}
.badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;background:#fff}
.fw{font-weight:700}

/* 許願 Modal */
.modal{display:none;position:fixed;inset:0;z-index:50}
.modal .overlay{position:absolute;inset:0;background:#0008}
.modal .sheet{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:min(920px,92vw);max-height:90vh;overflow:auto;background:#fff;border:1px solid var(--border);
  border-radius:18px;box-shadow:var(--shadow);padding:16px}
.modal h3{margin:0 0 10px}
.form{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form .full{grid-column:1 / -1}
.form textarea{border-radius:12px;min-height:100px}
.helper{font-size:12px;color:var(--muted);margin-top:-6px}
@media (max-width:860px){.form{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="top">
    <img class="logo" src="LOGO.png" alt="logo"/>
    <div>
      <h1>旅遊人生選物代購</h1>
      <small>Select Shop</small>
    </div>
  </div>

  <!-- 工具列（橫排 + 右側「我要許願」） -->
  <div class="toolbar">
    <input id="q" placeholder="搜尋商品…"/>
    <select id="filterRun"><option value="">全部連線</option></select>
    <select id="filterCat"><option value="">全部分類</option></select>
    <select id="sort">
      <option value="new">上架時間：新到舊</option>
      <option value="old">上架時間：舊到新</option>
    </select>
    <div class="spacer"></div>
    <button id="btnWish">我要許願</button>
  </div>

  <!-- 公告（首頁最近連線公告） -->
  <div class="notice" id="homeNotice" style="display:none"></div>

  <!-- 最近連線 -->
  <div class="section-title">最近連線</div>
  <div class="runs" id="runsRow"></div>

  <!-- 商品清單 -->
  <div class="section-title">商品</div>
  <div class="grid" id="list"></div>

</div>

<!-- 許願 Modal -->
<div id="wishModal" class="modal" aria-hidden="true">
  <div class="overlay"></div>
  <div class="sheet">
    <h3>我要許願</h3>
    <div class="form">
      <div>
        <label class="helper">選擇連線（只列出非 Pool）</label>
        <select id="wRun"><option value="">請選擇</option></select>
        <div class="helper">會帶出「連線標題｜起寄日期」。</div>
      </div>
      <div>
        <label class="helper">選擇分類（可選或輸入）</label>
        <input id="wCat" list="catList" placeholder="選或輸入"/>
        <datalist id="catList"></datalist>
      </div>
      <div class="full">
        <label class="helper">商品名稱</label>
        <input id="wName" placeholder="必填"/>
      </div>
      <div class="full">
        <label class="helper">商品網址</label>
        <input id="wUrl" placeholder="可貼購物連結"/>
      </div>
      <div class="full">
        <label class="helper">許願內容（尺寸／顏色／數量…）</label>
        <textarea id="wContent" placeholder="想補充的需求"></textarea>
      </div>
      <div class="full">
        <label class="helper">商品圖片（限 JPG/PNG/WebP ≤ 2MB）</label>
        <input id="wImg" type="file" accept="image/png,image/jpeg,image/webp"/>
      </div>
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn-ghost" id="wClose">關閉</button>
      <button id="wSend">送出許願</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl='https://llbpmqyjigovxixeohzr.supabase.co';
const supabaseKey='sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
const BUCKET='yuyu.f86';
const sb=supabase.createClient(supabaseUrl,supabaseKey);

function publicUrl(p){ if(!p) return ''; const {data}=sb.storage.from(BUCKET).getPublicUrl(p); return data?.publicUrl||''; }
const $=s=>document.querySelector(s);

let runs=[], normalRuns=[], poolRuns=[];
let allProducts=[], categories=[];

/* 首頁「最近連線公告」 */
async function loadNotice(){
  const {data}=await sb.from('site_meta').select('value').eq('key','home_notice').maybeSingle();
  if(data?.value){ $('#homeNotice').textContent=data.value; $('#homeNotice').style.display='block'; }
}

function runLabel(r){
  const d = r.ship_start_date || r.start_date || '';
  return `${r.title||r.region||'連線'}｜${d||''}`;
}

/* 連線（排除 Pool，並顯示在最近連線與許願下拉） */
async function loadRuns(){
  const {data}=await sb.from('runs').select('*').order('created_at',{ascending:false});
  runs = data||[];
  poolRuns = runs.filter(r=>r.is_pool);
  normalRuns = runs.filter(r=>!r.is_pool);

  // 最近連線卡片
  const row=$('#runsRow'); row.innerHTML='';
  normalRuns.slice(0,6).forEach(r=>{
    const div=document.createElement('div'); div.className='run';
    div.innerHTML = `
      <div class="fw">${r.title||r.region||''}</div>
      <div class="helper">${(r.start_date||'')} ~ ${(r.end_date||'')}</div>
      <div class="helper">寄送：${r.ship_start_date||''}</div>`;
    row.appendChild(div);
  });

  // 工具列：全部連線
  const f=$('#filterRun'); f.innerHTML='<option value="">全部連線</option>';
  normalRuns.forEach(r=> f.appendChild(new Option(runLabel(r), r.id)));

  // 許願：選擇連線（排除 Pool）
  const w=$('#wRun'); w.innerHTML='<option value="">請選擇</option>';
  normalRuns.forEach(r=> w.appendChild(new Option(runLabel(r), r.id)));
}

/* 分類（工具列：下拉；許願：datalist 可輸入） */
async function loadCategories(){
  const {data}=await sb.from('products').select('category').not('category','is',null);
  categories = [...new Set((data||[]).map(x=>x.category).filter(Boolean))]
    .sort((a,b)=>a.localeCompare(b,'zh-Hant'));
  const f=$('#filterCat'), dl=$('#catList');
  f.innerHTML='<option value="">全部分類</option>';
  dl.innerHTML='';
  categories.forEach(c=>{
    f.appendChild(new Option(c, c));
    const opt=document.createElement('option'); opt.value=c; dl.appendChild(opt);
  });
}

/* 商品清單：僅顯示「被分派到非 Pool 連線」的商品 */
async function loadProducts(){
  const normalIds=normalRuns.map(r=>r.id);
  if(!normalIds.length){ $('#list').innerHTML=''; return; }
  const {data:links}=await sb.from('product_runs').select('product_id,run_id').in('run_id', normalIds);
  const ids=[...new Set((links||[]).map(x=>x.product_id))];
  if(ids.length===0){ $('#list').innerHTML=''; return; }

  const {data}=await sb.from('products')
    .select('id,name,price,category,product_id,eta_text,img_url,images,created_at')
    .in('id', ids).order('created_at', {ascending:false});
  allProducts = data||[];
  renderList();
}

function firstImage(p){
  const lines = (p.images||'').split(/\n+/).filter(Boolean);
  const first = p.img_url || lines[0] || '';
  return publicUrl(first);
}

function renderList(){
  const q = $('#q').value.trim().toLowerCase();
  const cat = $('#filterCat').value || '';
  const sort = $('#sort').value;

  let arr = [...allProducts];
  if(q)   arr = arr.filter(p=> (p.name||'').toLowerCase().includes(q) || (p.product_id||'').toLowerCase().includes(q));
  if(cat) arr = arr.filter(p=> (p.category||'')===cat);

  arr.sort((a,b)=> sort==='old'
    ? new Date(a.created_at)-new Date(b.created_at)
    : new Date(b.created_at)-new Date(a.created_at));

  const box=$('#list'); box.innerHTML='';
  arr.forEach(p=>{
    const div=document.createElement('div'); div.className='card';
    const img=firstImage(p);
    div.innerHTML=`
      <div class="thumb">${img?`<img src="${img}" alt=""/>`:'<span class="helper">無圖</span>'}</div>
      <div class="body">
        <div class="fw">${p.name||''}</div>
        <div class="helper">${p.category? `<span class="badge">${p.category}</span>`:''}</div>
        <div class="price" style="margin-top:6px">NT$${p.price??''}</div>
        <div class="helper">到貨/寄送：${p.eta_text||''}</div>
      </div>`;
    box.appendChild(div);
  });
}

$('#q').addEventListener('input', renderList);
$('#filterCat').addEventListener('change', renderList);
$('#sort').addEventListener('change', renderList);

/* 許願 Modal：開關 */
const wish=$('#wishModal');
$('#btnWish').onclick=()=> wish.style.display='block';
$('#wishModal .overlay').onclick=()=> wish.style.display='none';
$('#wClose').onclick=()=> wish.style.display='none';

/* 許願：送出 */
$('#wSend').onclick=async()=>{
  const run_id = $('#wRun').value || null;
  const category = $('#wCat').value.trim() || null;
  const product_name = $('#wName').value.trim();
  const product_url = $('#wUrl').value.trim() || null;
  const content = $('#wContent').value.trim() || null;

  if(!product_name){ alert('請填寫商品名稱'); return; }

  // 圖片（可選）
  let image_path=null;
  const f=$('#wImg').files?.[0];
  if(f){
    const okType = ['image/png','image/jpeg','image/webp'].includes(f.type);
    if(!okType){ alert('圖片格式限 JPG/PNG/WebP'); return; }
    if(f.size>2*1024*1024){ alert('圖片大小需 ≤ 2MB'); return; }
    const ym=new Date(); const folder=`wishes/${ym.getFullYear()}${String(ym.getMonth()+1).padStart(2,'0')}`;
    const name=`${Date.now()}_${Math.random().toString(36).slice(2,8)}_${f.name}`;
    image_path=`${folder}/${name}`;
    const {error:upErr}=await sb.storage.from(BUCKET).upload(image_path, f, {cacheControl:'3600', upsert:false});
    if(upErr){ alert('圖片上傳失敗'); return; }
  }

  const {error}=await sb.from('wishes').insert([{run_id, category, product_name, product_url, content, image_path}]);
  if(error){ alert('送出失敗：'+error.message); return; }
  alert('已送出，感謝許願！'); wish.style.display='none';

  // reset
  ['wRun','wCat','wName','wUrl','wContent','wImg'].forEach(id=>{
    const el=document.getElementById(id);
    if(el.type==='file') el.value='';
    else el.value='';
  });
};

/* 啟動 */
(async function(){
  await loadNotice();
  await loadRuns();
  await loadCategories();
  await loadProducts();
})();
</script>
</body>
</html>
