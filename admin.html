<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å¾Œå°ï½œé€£ç·šèˆ‡å•†å“ç®¡ç†</title>
<style>
:root{--bg:#f7f3ef;--paper:#fffdf9;--card:#fff;--ink:#2b2b2b;--muted:#7a7267;--brand:#8B5E34;--border:#eadfcd;--shadow:0 10px 24px rgba(139,94,52,.08);--radius:14px;--maxw:1080px}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#f8f5f1 0%,var(--bg) 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial}
.wrap{max-width:var(--maxw);margin:20px auto;padding:0 16px}
h1{margin:6px 0 14px}.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tabbtn{border:1px solid var(--border);background:#fffdf9;border-radius:999px;padding:8px 14px;cursor:pointer}
.tabbtn.active{background:var(--brand);color:#fff;border-color:transparent}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media (max-width:860px){.row{grid-template-columns:1fr}}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fffdfa}
textarea{min-height:72px}.btn{border:none;background:var(--brand);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid var(--border);color:#2b2b2b}
.list{width:100%;border-collapse:collapse}.list th,.list td{border-top:1px solid var(--border);padding:8px;vertical-align:top}
.list th{background:#fffaf2;text-align:left;font-weight:700}
.muted{color:var(--muted)}.small{font-size:12px}
.uploader{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fff}
.previews{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.preview{position:relative;width:100px;height:100px;background:#f3efe9;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.preview img{max-width:100%;max-height:100%;object-fit:contain}
.preview button{position:absolute;top:4px;right:4px;border:none;background:#000a;color:#fff;border-radius:6px;padding:2px 6px;cursor:pointer;font-size:12px}
.badge{display:inline-block;border:1px solid var(--border);padding:3px 8px;border-radius:999px;font-size:12px;background:#fff}

/* Modal */
.modal{display:none;position:fixed;inset:0;z-index:1000}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
.sheet{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(980px,92vw);max-height:90vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px}
.sheet h3{margin:0 0 8px}

/* Pool grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.card{border:1px solid var(--border);border-radius:10px;background:#fff;padding:10px}
.card .muted{font-size:12px}
hr.sep{border:none;border-top:1px dashed var(--border);margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>å¾Œå°ï½œé€£ç·šèˆ‡å•†å“ç®¡ç† <span class="badge">Supabase</span></h1>

  <div class="tabs">
    <button class="tabbtn active" data-tab="products">Products</button>
    <button class="tabbtn" data-tab="runs">Runs</button>
    <button class="tabbtn" data-tab="pool">Pool æ´¾é€</button>
    <button class="tabbtn" data-tab="bulk">Bulk Move</button>
    <button class="tabbtn" data-tab="wishes">Wishes</button>
    <button class="tabbtn" data-tab="settings">Settings</button>
  </div>

  <!-- PRODUCTS -->
  <section id="tab-products">
    <div class="panel">
      <h3 style="margin:0 0 10px">æ–°å¢å•†å“ï¼ˆå¯æŒ‡æ´¾åˆ°é€£ç·šï¼æˆ–æ”¾å…±ç”¨æ± ï¼‰</h3>
      <div class="row">
        <div><label>åç¨± name</label><input id="pName" /></div>
        <div><label>å”®åƒ¹ priceï¼ˆNT$ï¼‰</label><input id="pPrice" type="number" step="1" min="0" /></div>
        <div><label>åˆ†é¡ categoryï¼ˆä¸‹æ‹‰ï¼‹å¯æ–°å¢ï¼‰</label><input id="pCategory" list="categoryList" placeholder="é¸æˆ–ç›´æ¥è¼¸å…¥æ–°å¢"/><datalist id="categoryList"></datalist></div>
        <div><label>å•†å“ç·¨è™Ÿ product_idï¼ˆç•™ç©ºè‡ªå‹•ï¼‰</label><input id="pPid" placeholder="ç•™ç©ºâ†’è‡ªå‹• PYYYYMMDD-XXX"/></div>
        <div><label>ç‹€æ…‹ status</label>
          <input id="pStatus" list="statusList" placeholder="é¸æˆ–è‡ªè¡Œè¼¸å…¥"/>
          <datalist id="statusList"><option value="ç¾è²¨"></option><option value="é è³¼"></option><option value="å”®ç½„"></option></datalist>
        </div>
        <div><label>é–‹å§‹å¯„é€æ—¥ï¼ˆå‰å°é¡¯ç¤ºï¼‰</label><input id="pArrival" type="date"/></div>
        <div><label>æŒ‡æ´¾åˆ°é€£ç·šï¼ˆå«å…±ç”¨æ± ï¼‰</label><select id="pRunAssign"><option value="">â€” é¸æ“‡é€£ç·š â€”</option></select></div>
        <div><label>eta_textï¼ˆè‹¥ä¸Šé¢æ²’é¸å¯æ‰‹å¡«ï¼‰</label><input id="pEta" placeholder="ä¾‹ï¼š9/26 æ±äº¬"/></div>
        <div style="grid-column:1 / -1"><label>æè¿° descriptionï¼ˆéå¿…å¡«ï¼‰</label><textarea id="pDesc" placeholder="æƒ³è£œå……çš„èªªæ˜æ–‡å­—â€¦"></textarea></div>
        <div style="grid-column:1 / -1"><label>å‚™è¨» / è£œå…… note</label><input id="pNote"/></div>
        <div style="grid-column:1 / -1"><label>æ¨™ç±¤ tagsï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label><input id="pTags" placeholder="3coins,and us,è…®ç´…"/></div>
        <div><label>æˆæœ¬å¹£åˆ¥</label><select id="pCostCurrency"><option value="TWD">TWD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="USD">USD</option></select></div>
        <div><label>æˆæœ¬ï¼ˆåŸå¹£ï¼‰</label><input id="pCostForeign" type="number" step="0.01" min="0" placeholder="ä¾‹å¦‚ 350"/></div>
        <div><label>å°å¹£æˆæœ¬ï¼ˆç³»çµ±è‡ªç®—ï¼Œå¯è¦†å¯«ï¼‰</label><input id="pCostNt" type="number" step="1" min="0" placeholder="è‡ªå‹•æ›ç®—"/></div>
        <div class="small" style="display:flex;align-items:flex-end">ç›®å‰åŒ¯ç‡ï¼š<span id="rateTip" style="margin-left:6px"></span></div>
        <div style="grid-column:1 / -1">
          <label>å•†å“åœ–ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</label>
          <div class="uploader">
            <input type="file" id="imgFiles" accept="image/*" multiple />
            <div class="previews" id="imgPreviews"></div>
            <div class="small muted">ä¸Šå‚³å¾Œå­˜ç›¸å°è·¯å¾‘ï¼›ç¬¬ä¸€å¼µåšä»£è¡¨åœ–ï¼Œå…¶é¤˜å¯«å…¥ <code>products.images</code>ï¼ˆæ›è¡Œåˆ†éš”ï¼‰ã€‚</div>
          </div>
        </div>
      </div>
      <div class="row">
        <div><button class="btn" id="btnCreateProduct">æ–°å¢å•†å“</button></div>
      </div>
    </div>

    <div class="panel">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0 0 10px">å·²æ–°å¢ï¼ˆæœ€æ–° 50ï¼Œå¯ç·¨è¼¯/åˆªé™¤ï¼‰</h3>
        <div class="flex" style="gap:8px;align-items:center">
          <label class="small">æª¢è¦–</label>
          <select id="prodFilterRun" style="min-width:220px"><option value="">å…¨éƒ¨å•†å“</option></select>
        </div>
      </div>
      <table class="list" id="productsTable">
        <thead><tr>
          <th>åç¨±</th><th style="width:90px">å”®åƒ¹</th><th style="width:130px">åˆ†é¡</th>
          <th style="width:150px">ç·¨è™Ÿ</th><th style="width:220px">é€£ç·š / eta_text</th>
          <th style="width:160px">æˆæœ¬(TWD)</th><th style="width:120px">åˆ©æ½¤</th>
          <th style="width:260px">æ“ä½œ</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- RUNS -->
  <section id="tab-runs" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 8px">æ–°å¢ / ç·¨è¼¯ é€£ç·š</h3>
      <div class="row">
        <div><label>æ¨™é¡Œ title</label><input id="rTitle" placeholder="ä¾‹ï¼š9/26 æ±äº¬ æˆ– JP å…±ç”¨æ± "/></div>
        <div><label>ä»£ç¢¼ codeï¼ˆé¸å¡«ï¼‰</label><input id="rCode"/></div>
        <div><label>å€åŸŸ region</label><input id="rRegion" placeholder="JP / KR / etc."/></div>
        <div><label>é–‹å§‹ start_date</label><input id="rStart" type="date"/></div>
        <div><label>çµæŸ end_date</label><input id="rEnd" type="date"/></div>
        <div><label>å¯„é€é–‹å§‹ ship_start_date</label><input id="rShip" type="date"/></div>
        <div style="grid-column:1 / -1"><label>å‚™è¨» note</label><input id="rNote"/></div>
        <div>
          <label>æ˜¯å¦å•Ÿç”¨ is_active</label>
          <select id="rActive"><option>true</option><option>false</option></select>
        </div>
        <div>
          <label>é¦–é  featured</label>
          <select id="rFeatured"><option>false</option><option>true</option></select>
        </div>
        <div>
          <label>æ˜¯å¦ Poolï¼ˆå…±ç”¨æ± ï¼‰</label>
          <select id="rIsPool"><option value="false">å¦</option><option value="true">æ˜¯</option></select>
        </div>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="btnRunCreate">å„²å­˜ï¼ˆæ–°å¢/æ›´æ–°ï¼‰</button>
        <button class="btn ghost" id="btnRunReset">æ¸…ç©º</button>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px">æ‰€æœ‰é€£ç·š</h3>
      <table class="list" id="runsTable">
        <thead><tr>
          <th>æ¨™é¡Œ</th><th>å€åŸŸ</th><th>æ—¥æœŸ</th><th>å¯„é€</th><th>å‚™è¨»</th><th>ç‹€æ…‹</th><th>é¦–é </th><th>Pool</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- POOL æ´¾é€ï¼ˆå¾ pool è¤‡è£½åˆ° runï¼‰ -->
  <section id="tab-pool" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 10px">å¾å…±ç”¨æ± ã€Œè¤‡è£½ã€å•†å“åˆ°æŸæ¬¡é€£ç·š</h3>
      <div class="row">
        <div>
          <label>é¸æ“‡ Pool é€£ç·šï¼ˆis_pool=trueï¼‰</label>
          <select id="poolSelect"><option value="">â€” é¸æ“‡ Pool â€”</option></select>
        </div>
        <div>
          <label>ç›®æ¨™é€£ç·šï¼ˆå¯¦éš›è·‘åœ˜ï¼‰</label>
          <select id="poolTarget"><option value="">â€” é¸æ“‡ç›®æ¨™é€£ç·š â€”</option></select>
        </div>
      </div>
      <div class="small muted">é€™è£¡æ˜¯ã€Œè¤‡è£½ã€é—œè¯ï¼šæœƒæ–°å¢ <code>product_runs</code> åˆ°ç›®æ¨™é€£ç·šï¼›Pool ä»ä¿ç•™ã€‚</div>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Pool å…§å•†å“ï¼ˆå¯å¤šé¸ï¼‰</h3>
        <div>
          <button class="btn ghost" id="poolSelectAll">å…¨é¸/å…¨ä¸é¸</button>
          <button class="btn" id="poolCopy">è¤‡è£½åˆ°ç›®æ¨™é€£ç·š</button>
        </div>
      </div>
      <div id="poolList" class="grid" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- BULK MOVEï¼ˆè¤‡è£½ï¼‰ -->
  <section id="tab-bulk" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 10px">æ‰¹æ¬¡è¤‡è£½å•†å“åˆ°å¦ä¸€å€‹é€£ç·š</h3>
      <div class="row">
        <div><label>ä¾†æºé€£ç·š</label><select id="bulkFrom"><option value="">â€” é¸æ“‡ä¾†æº â€”</option></select></div>
        <div><label>ç›®æ¨™é€£ç·š</label><select id="bulkTo"><option value="">â€” é¸æ“‡ç›®æ¨™ â€”</option></select></div>
        <div><label>ç¯„åœ</label><select id="bulkScope">
          <option value="linked">åªåŒ…å«å·²é—œè¯çš„å•†å“ï¼ˆproduct_runsï¼‰</option>
          <option value="all">ä¾†æºé€£ç·šçš„å…¨éƒ¨å•†å“ï¼ˆåŒä¸Šï¼Œé€šå¸¸ä»ä»¥é—œè¯ç‚ºæº–ï¼‰</option>
        </select></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="bulkPreview">é è¦½æ•¸é‡</button>
        <button class="btn" id="bulkDo">åŸ·è¡Œè¤‡è£½</button>
        <div id="bulkInfo" class="small muted" style="margin-left:8px"></div>
      </div>
    </div>
  </section>

  <!-- WISHES -->
  <section id="tab-wishes" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 8px">è¨±é¡˜æ¸…å–®</h3>
      <div class="row">
        <div><label>ç¯©é¸ç‹€æ…‹</label>
          <select id="wishStatusFilter">
            <option value="">å…¨éƒ¨</option>
            <option value="pending">pending</option>
            <option value="approved">approved</option>
            <option value="rejected">rejected</option>
          </select>
        </div>
        <div><label>ç¯©é¸é€£ç·š</label>
          <select id="wishRunFilter"><option value="">å…¨éƒ¨</option></select>
        </div>
      </div>
      <table class="list" id="wishesTable" style="margin-top:10px">
        <thead>
          <tr>
            <th>æ™‚é–“</th><th>é€£ç·š</th><th>åˆ†é¡</th><th>å•†å“åç¨±</th><th>ç¶²å€</th><th>å…§å®¹</th><th>åœ–ç‰‡</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" style="display:none">
    <div class="panel">
      <div class="panel">
  <h3 style="margin:0 0 10px">é¦–é ã€Œæœ€è¿‘é€£ç·šã€/ å…¬å‘Š</h3>
  <div class="small muted">é¡¯ç¤ºæ–¼å‰å°é¦–é é ‚éƒ¨ï¼ˆindex çš„æé†’æ¢ï¼‰ã€‚</div>
  <div style="display:flex;align-items:center;gap:8px;margin:8px 0">
    <span class="muted" style="display:inline-flex;align-items:center;gap:6px">
      <span style="font-size:18px">ğŸ›«</span> æœ€è¿‘é€£ç·šï¼š9/6~9 æ—¥æœ¬åŒ—æµ·é“
    </span>
  </div>

  <textarea id="homeNotice" style="width:100%;min-height:64px;border:1px solid var(--border);border-radius:10px;padding:10px;background:#fffaf2"></textarea>
  <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
    <button class="btn" id="btnSaveNotice">å„²å­˜å…¬å‘Š</button>
    <button class="btn ghost" id="btnClearNotice">æ¸…ç©º</button>
    <span class="small muted">å„²å­˜åœ¨ <code>site_meta</code> çš„ <code>home_notice</code>ï¼Œå‰å°å·²è‡ªå‹•è®€å–é¡¯ç¤ºã€‚</span>
  </div>
</div>

      <h3 style="margin:0 0 10px">åŒ¯ç‡è¨­å®š</h3>
      <div class="row">
        <div><label>JPY â†’ TWD</label><input id="rateJPY" type="number" step="0.0001" /></div>
        <div><label>KRW â†’ TWD</label><input id="rateKRW" type="number" step="0.00001" /></div>
        <div><label>USD â†’ TWD</label><input id="rateUSD" type="number" step="0.0001" /></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnSaveRates">å„²å­˜åŒ¯ç‡</button>
        <span class="muted small">å„²å­˜åœ¨ <code>site_meta</code>ï¼ˆkeyï¼š<code>rate_JPY</code>/<code>rate_KRW</code>/<code>rate_USD</code>ï¼‰ã€‚</span>
      </div>
    </div>
  </section>
</div>

<!-- ç·¨è¼¯å•†å“ Modal -->
<div id="editModal" class="modal">
  <div class="overlay"></div>
  <div class="sheet">
    <h3>ç·¨è¼¯å•†å“</h3>
    <div class="row">
      <div><label>åç¨±</label><input id="eName"/></div>
      <div><label>å”®åƒ¹ï¼ˆNT$ï¼‰</label><input id="ePrice" type="number" min="0" step="1"/></div>
      <div><label>åˆ†é¡</label><input id="eCategory" list="categoryList"/></div>
      <div><label>å•†å“ç·¨è™Ÿ</label><input id="ePid"/></div>
      <div><label>ç‹€æ…‹</label><input id="eStatus" list="statusList"/></div>
      <div><label>é–‹å§‹å¯„é€æ—¥</label><input id="eArrival" type="date"/></div>
      <div><label>æŒ‡æ´¾åˆ°é€£ç·š</label><select id="eRunAssign"><option value="">â€” é¸æ“‡é€£ç·š â€”</option></select></div>
      <div><label>eta_text</label><input id="eEta"/></div>
      <div style="grid-column:1 / -1"><label>æè¿°</label><textarea id="eDesc"></textarea></div>
      <div style="grid-column:1 / -1"><label>å‚™è¨»</label><input id="eNote"/></div>
      <div style="grid-column:1 / -1"><label>æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label><input id="eTags"/></div>
      <div><label>æˆæœ¬å¹£åˆ¥</label><select id="eCostCurrency"><option>TWD</option><option>JPY</option><option>KRW</option><option>USD</option></select></div>
      <div><label>æˆæœ¬ï¼ˆåŸå¹£ï¼‰</label><input id="eCostForeign" type="number" step="0.01" min="0"/></div>
      <div><label>å°å¹£æˆæœ¬</label><input id="eCostNt" type="number" step="1" min="0"/></div>
      <div style="grid-column:1 / -1">
        <label>åœ–ç‰‡ï¼ˆå¯è¿½åŠ æ›¿æ›ï¼‰</label>
        <div class="uploader">
          <input type="file" id="eImgFiles" accept="image/*" multiple/>
          <div class="previews" id="eImgPreviews"></div>
          <div class="small muted">ä¿ç•™æ—¢æœ‰åœ–ç‰‡ï¼›æ–°å¢çš„æœƒè¿½åŠ ã€‚è¦å®Œå…¨æ›¿æ›å¯æŠŠã€Œä¿ç•™æ—¢æœ‰ã€å‹¾é—œæ‰ã€‚</div>
          <label class="small"><input type="checkbox" id="eKeepOld" checked/> ä¿ç•™æ—¢æœ‰</label>
        </div>
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="btn" id="btnEditSave">å„²å­˜</button>
      <button class="btn ghost" id="btnEditCancel">é—œé–‰</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ==== Supabase åŸºæœ¬è¨­å®š ==== */
const supabaseUrl='https://llbpmqyjigovxixeohzr.supabase.co';
const supabaseKey='sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
const BUCKET='yuyu.f86';
const sb=supabase.createClient(supabaseUrl,supabaseKey);

/* ==== Tabs ==== */
document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none');
    document.getElementById('tab-'+btn.dataset.tab).style.display='block';
  };
});

/* ==== Helpers ==== */
function publicUrlFromPath(path){ if(!path) return ''; const { data }=sb.storage.from(BUCKET).getPublicUrl(path); return data?.publicUrl||''; }
let RATES={JPY:0.22, KRW:0.024, USD:32.0};
let runsCache=[], poolRuns=[], normalRuns=[];

/* ==== Rates ==== */
async function loadRates(){
  const keys=['rate_JPY','rate_KRW','rate_USD'];
  const { data }=await sb.from('site_meta').select('key,value').in('key', keys);
  (data||[]).forEach(kv=>{
    if(kv.key==='rate_JPY') RATES.JPY = Number(kv.value)||RATES.JPY;
    if(kv.key==='rate_KRW') RATES.KRW = Number(kv.value)||RATES.KRW;
    if(kv.key==='rate_USD') RATES.USD = Number(kv.value)||RATES.USD;
  });
  rateJPY.value=RATES.JPY; rateKRW.value=RATES.KRW; rateUSD.value=RATES.USD;
  document.getElementById('rateTip').textContent=`JPY=${RATES.JPY}ï¼ŒKRW=${RATES.KRW}ï¼ŒUSD=${RATES.USD}`;
}
btnSaveRates.onclick=async()=>{
  const rows=[
    {key:'rate_JPY', value:String(rateJPY.value||RATES.JPY)},
    {key:'rate_KRW', value:String(rateKRW.value||RATES.KRW)},
    {key:'rate_USD', value:String(rateUSD.value||RATES.USD)},
  ];
  for(const r of rows){ await sb.from('site_meta').upsert(r,{onConflict:'key'}); }
  await loadRates(); alert('å·²å„²å­˜åŒ¯ç‡');
};
  
// --- Home Notice (Settings) ---
async function loadHomeNotice() {
  const { data, error } = await sb
    .from('site_meta')
    .select('value')
    .eq('key', 'home_notice')
    .maybeSingle();
  if (!error && data) homeNotice.value = data.value || '';
}

btnSaveNotice.onclick = async () => {
  const val = (homeNotice.value || '').trim();
  await sb.from('site_meta').upsert({ key: 'home_notice', value: val }, { onConflict: 'key' });
  alert('å·²å„²å­˜é¦–é å…¬å‘Š');
};

btnClearNotice.onclick = async () => {
  if (!confirm('è¦æ¸…ç©ºé¦–é å…¬å‘Šå—ï¼Ÿ')) return;
  await sb.from('site_meta').delete().eq('key', 'home_notice');
  homeNotice.value = '';
  alert('å·²æ¸…ç©º');
};

  
/* æˆæœ¬è‡ªç®—ï¼ˆæ–°å¢/ç·¨è¼¯ï¼‰ */
['pCostCurrency','pCostForeign'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    const cur=pCostCurrency.value, amt=Number(pCostForeign.value||0);
    let nt=null;
    if(cur==='TWD') nt=amt; else if(cur==='JPY') nt=amt*RATES.JPY; else if(cur==='KRW') nt=amt*RATES.KRW; else if(cur==='USD') nt=amt*RATES.USD;
    pCostNt.value = nt? Math.round(nt) : '';
  });
});
['eCostCurrency','eCostForeign'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    const cur=eCostCurrency.value, amt=Number(eCostForeign.value||0);
    let nt=null;
    if(cur==='TWD') nt=amt; else if(cur==='JPY') nt=amt*RATES.JPY; else if(cur==='KRW') nt=amt*RATES.KRW; else if(cur==='USD') nt=amt*RATES.USD;
    eCostNt.value = nt? Math.round(nt) : '';
  });
});

/* ==== Runs ==== */
function runLabel(r){
  const d1=r.start_date? String(r.start_date):'';
  const d2=r.end_date? String(r.end_date):'';
  const date = (d1||d2)? `${d1}${d2?(' ~ '+d2):''}` : '';
  return (r.title||r.code||r.region||('Run#'+r.id)) + (date? `ï¼ˆ${date}ï¼‰`: '');
}
async function loadRuns(){
  const { data }=await sb.from('runs').select('*').order('created_at',{ascending:false});
  runsCache=data||[];
  poolRuns=runsCache.filter(r=>r.is_pool);
  normalRuns=runsCache.filter(r=>!r.is_pool);

  // Products é é¢çš„ run ä¸‹æ‹‰
  pRunAssign.innerHTML='<option value="">â€” é¸æ“‡é€£ç·š â€”</option>';
  eRunAssign.innerHTML='<option value="">â€” é¸æ“‡é€£ç·š â€”</option>';
  prodFilterRun.innerHTML='<option value="">å…¨éƒ¨å•†å“</option>';
  runsCache.forEach(r=>{
    const v=JSON.stringify({id:r.id,title:r.title||''});
    pRunAssign.appendChild(new Option(runLabel(r), v));
    eRunAssign.appendChild(new Option(runLabel(r), v));
    prodFilterRun.appendChild(new Option(runLabel(r), r.id));
  });

  // Runs tab åˆ—è¡¨
  await renderRunsTable();

  // Pool tab ä¸‹æ‹‰
  poolSelect.innerHTML='<option value="">â€” é¸æ“‡ Pool â€”</option>';
  poolRuns.forEach(r=> poolSelect.appendChild(new Option(runLabel(r), r.id)));
  poolTarget.innerHTML='<option value="">â€” é¸æ“‡ç›®æ¨™é€£ç·š â€”</option>';
  normalRuns.forEach(r=> poolTarget.appendChild(new Option(runLabel(r), r.id)));

  // Bulk
  bulkFrom.innerHTML='<option value="">â€” é¸æ“‡ä¾†æº â€”</option>';
  bulkTo.innerHTML='<option value="">â€” é¸æ“‡ç›®æ¨™ â€”</option>';
  runsCache.forEach(r=>{
    bulkFrom.appendChild(new Option(runLabel(r), r.id));
    bulkTo.appendChild(new Option(runLabel(r), r.id));
  });

  // Wishes ç¯©é¸é€£ç·š
  wishRunFilter.innerHTML='<option value="">å…¨éƒ¨</option>';
  runsCache.forEach(r=> wishRunFilter.appendChild(new Option(runLabel(r), r.id)));
}
pRunAssign.addEventListener('change', e=>{ try{ const o=JSON.parse(e.target.value||''); if(o.title) pEta.value=o.title; }catch(_){ } });
eRunAssign.addEventListener('change', e=>{ try{ const o=JSON.parse(e.target.value||''); if(o.title) eEta.value=o.title; }catch(_){ } });

async function renderRunsTable(){
  const tb=runsTable.querySelector('tbody'); tb.innerHTML='';
  runsCache.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.title||''}</td>
      <td>${r.region||''}</td>
      <td>${r.start_date||''} ~ ${r.end_date||''}</td>
      <td>${r.ship_start_date||''}</td>
      <td>${r.note||''}</td>
      <td>${r.is_active? 'å•Ÿç”¨':'åœç”¨'}</td>
      <td>${r.is_featured? 'âœ”':''}</td>
      <td>${r.is_pool? 'âœ”':''}</td>
      <td>
        <button class="btn ghost" onclick='editRun("${r.id}")'>ç·¨è¼¯</button>
        <button class="btn ghost" onclick='deleteRun("${r.id}")'>åˆªé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}
window.editRun=async(id)=>{
  const r=runsCache.find(x=>x.id===id); if(!r) return;
  rTitle.value=r.title||''; rCode.value=r.code||''; rRegion.value=r.region||'';
  rStart.value=r.start_date||''; rEnd.value=r.end_date||''; rShip.value=r.ship_start_date||'';
  rNote.value=r.note||''; rActive.value=String(!!r.is_active); rFeatured.value=String(!!r.is_featured);
  rIsPool.value=String(!!r.is_pool);
  rTitle.dataset.editId=id;
};
window.deleteRun=async(id)=>{
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤é€£ç·šï¼Ÿï¼ˆæœƒé€£åŒå°æ‡‰é—œè¯ç§»é™¤ï¼‰')) return;
  const { error }=await sb.from('runs').delete().eq('id',id);
  if(error){ alert('åˆªé™¤å¤±æ•—ï¼š'+error.message); return; }
  await loadRuns(); alert('å·²åˆªé™¤');
};
btnRunCreate.onclick=async()=>{
  const payload={
    title:(rTitle.value||'').trim(),
    code:(rCode.value||'').trim()||null,
    region:(rRegion.value||'').trim()||null,
    start_date:rStart.value||null,
    end_date:rEnd.value||null,
    ship_start_date:rShip.value||null,
    note:(rNote.value||'').trim()||null,
    is_active:(rActive.value==='true'),
    is_featured:(rFeatured.value==='true'),
    is_pool:(rIsPool.value==='true'),
  };
  if(!payload.title){ alert('è«‹è¼¸å…¥æ¨™é¡Œ'); return; }
  const editId=rTitle.dataset.editId||null;
  if(editId){
    const { error }=await sb.from('runs').update(payload).eq('id',editId);
    if(error){ alert('æ›´æ–°å¤±æ•—ï¼š'+error.message); return; }
    delete rTitle.dataset.editId;
  }else{
    const { error }=await sb.from('runs').insert(payload);
    if(error){ alert('æ–°å¢å¤±æ•—ï¼š'+error.message); return; }
  }
  btnRunReset.click(); await loadRuns(); alert('å·²å„²å­˜');
};
btnRunReset.onclick=()=>{ [rTitle,rCode,rRegion,rStart,rEnd,rShip,rNote].forEach(i=>i.value=''); rActive.value='true'; rFeatured.value='false'; rIsPool.value='false'; delete rTitle.dataset.editId; };

/* ==== Category datalist ==== */
async function fillCategoryDatalist(){
  const { data }=await sb.from('products').select('category').not('category','is',null);
  const set=new Set((data||[]).map(x=>x.category).filter(Boolean));
  categoryList.innerHTML=''; Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hant')).forEach(c=>categoryList.appendChild(new Option('',c)));
}

/* ==== Auto product_id ==== */
async function genNextPid(){
  const d=new Date(), prefix=`P${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-`;
  const { data } = await sb.from('products').select('product_id').ilike('product_id', `${prefix}%`).order('product_id',{ascending:false}).limit(1);
  let seq=1; if(data&&data[0]?.product_id){ const n=parseInt(String(data[0].product_id).split('-').pop().replace(/\D/g,''),10); if(!isNaN(n)) seq=n+1; }
  return prefix+String(seq).padStart(3,'0');
}
function parseTags(s){ const raw=(s||'').trim(); return raw? raw.split(',').map(x=>x.trim()).filter(Boolean):null; }

/* ==== Upload helpers ==== */
const addFilesState=[]; const editFilesState=[];
function renderPreviews(box, state){
  box.innerHTML=''; state.forEach((f,idx)=>{ const div=document.createElement('div'); div.className='preview';
    const img=document.createElement('img'); img.src=f.url; div.appendChild(img);
    const x=document.createElement('button'); x.textContent='åˆªé™¤'; x.onclick=()=>{ state.splice(idx,1); renderPreviews(box,state); };
    div.appendChild(x); box.appendChild(div);
  });
}
imgFiles.addEventListener('change',e=>{
  Array.from(e.target.files||[]).forEach(file=> addFilesState.push({file, url:URL.createObjectURL(file), uploadedPath:null}));
  renderPreviews(imgPreviews, addFilesState);
});
eImgFiles.addEventListener('change',e=>{
  Array.from(e.target.files||[]).forEach(file=> editFilesState.push({file, url:URL.createObjectURL(file), uploadedPath:null}));
  renderPreviews(eImgPreviews, editFilesState);
});
async function uploadAll(state, baseFolder){
  const out=[];
  for(const item of state){
    if(item.uploadedPath){ out.push(item.uploadedPath); continue; }
    const name=`${Date.now()}_${Math.random().toString(36).slice(2,8)}_${item.file.name}`;
    const path=`${baseFolder}/${name}`.replace(/\/+/g,'/');
    const { error }=await sb.storage.from(BUCKET).upload(path, item.file, { upsert:false, cacheControl:'3600' });
    if(!error){ item.uploadedPath=path; out.push(path); }
  }
  return out;
}

/* ==== Create Product ==== */
btnCreateProduct.onclick=async()=>{
  let pid=(pPid.value||'').trim(); if(!pid) pid=await genNextPid();
  let runObj=null; try{ runObj=JSON.parse(pRunAssign.value||''); }catch(_){}
  const eta=(pEta.value||'').trim() || (runObj?.title||null);

  const date=new Date(), ym=`${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}`;
  const uploaded=await uploadAll(addFilesState, `uploads/${ym}`);
  const img_url=uploaded[0]||null, imagesText=uploaded.slice(1).join('\n');

  const payload={
    name:(pName.value||'').trim(), price:pPrice.value?Number(pPrice.value):null,
    category:(pCategory.value||'').trim()||null, product_id:pid, status:(pStatus.value||'').trim()||null,
    arrival_time:(pArrival.value||'')||null, eta_text:eta, note:(pNote.value||'').trim()||null,
    description:(pDesc.value||'').trim()||null,
    img_url, images:imagesText,
    cost_jpy:(pCostCurrency.value==='JPY'? Number(pCostForeign.value||0): null),
    cost_nt: pCostNt.value? Number(pCostNt.value): null,
    tags: parseTags(pTags.value)
  };
  if(!payload.name){ alert('è«‹è¼¸å…¥å•†å“åç¨±'); return; }
  const { data, error }=await sb.from('products').insert(payload).select(); if(error){ alert('æ–°å¢å¤±æ•—ï¼š'+error.message); return; }
  const product=data?.[0];
  if(runObj?.id && product?.id){ await sb.from('product_runs').upsert({product_id:product.id, run_id:runObj.id},{onConflict:'product_id,run_id'}); }
  addFilesState.length=0; renderPreviews(imgPreviews, addFilesState);
  ['pName','pPrice','pCategory','pPid','pStatus','pArrival','pEta','pNote','pDesc','pTags','pCostForeign','pCostNt'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
  alert('æ–°å¢æˆåŠŸ'); await fillCategoryDatalist(); await loadProducts();
};

/* ==== Table & Edit & Delete ==== */
function nt(price,cost){ if(price==null||cost==null) return 'â€”'; return Math.round(Number(price)-Number(cost)); }
async function loadProducts(runFilterId=null){
  let q=sb.from('products').select('id,name,price,category,product_id,eta_text,cost_jpy,cost_nt,img_url,images').order('created_at',{ascending:false}).limit(50);
  if(runFilterId){
    const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',runFilterId);
    const ids=(pr||[]).map(x=>x.product_id); q = ids.length? q.in('id',ids) : q.in('id',['00000000-0000-0000-0000-000000000000']);
  }
  const { data, error }=await q; if(error){ console.error(error); return; }
  const tb=productsTable.querySelector('tbody'); tb.innerHTML='';
  (data||[]).forEach(p=>{
    const costNT=(p.cost_nt!=null)?Number(p.cost_nt):(p.cost_jpy!=null?Number(p.cost_jpy)*RATES.JPY:null);
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${p.name||''}</td><td>${p.price??''}</td><td>${p.category||''}</td>
      <td>${p.product_id||''}</td><td>${p.eta_text||''}</td>
      <td>${costNT!=null?Math.round(costNT):'â€”'}</td><td>${nt(p.price,costNT)}</td>
      <td style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn ghost" onclick="openEdit('${p.id}')">ç·¨è¼¯</button>
        <button class="btn ghost" onclick="copyPublicImages('${(p.img_url||'')}', \`${(p.images||'').replace(/`/g,'\\`')}\`)">è¤‡è£½åœ–ç‰‡é€£çµ</button>
        <button class="btn ghost" onclick="deleteProduct('${p.id}')">åˆªé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
}
prodFilterRun.addEventListener('change',e=> loadProducts(e.target.value||null));
function copyPublicImages(main, others){
  const arr=[main, ...others.split(/\n+/).filter(Boolean)].filter(Boolean).map(publicUrlFromPath);
  navigator.clipboard.writeText(arr.join('\n')); alert('å·²è¤‡è£½åœ–ç‰‡ URLï¼ˆå…¬é–‹ï¼‰');
}
window.deleteProduct=async(id)=>{
  if(!confirm('ç¢ºå®šåˆªé™¤æ­¤å•†å“ï¼Ÿï¼ˆæœƒé€£åŒå°æ‡‰é—œè¯ç§»é™¤ï¼‰')) return;
  const { error }=await sb.from('products').delete().eq('id',id);
  if(error){ alert('åˆªé™¤å¤±æ•—ï¼š'+error.message); return; }
  await loadProducts(prodFilterRun.value||null); alert('å·²åˆªé™¤');
};

/* ==== Edit modal ==== */
const editModal=document.getElementById('editModal'); editModal.querySelector('.overlay').onclick=()=> editModal.style.display='none';
document.getElementById('btnEditCancel').onclick=()=> editModal.style.display='none';
let editing=null, keepOld=true, oldMain=null, oldImages=[];
async function openEdit(id){
  const { data }=await sb.from('products').select('*').eq('id',id).maybeSingle();
  if(!data){ alert('è®€å–å¤±æ•—'); return; }
  editing=data;
  const { data:pr }=await sb.from('product_runs').select('run_id').eq('product_id',id).limit(1);
  const runId=pr?.[0]?.run_id||null;

  eName.value=data.name||''; ePrice.value=data.price??''; eCategory.value=data.category||''; ePid.value=data.product_id||'';
  eStatus.value=data.status||''; eArrival.value=data.arrival_time||''; eEta.value=data.eta_text||''; eNote.value=data.note||'';
  eDesc.value=data.description||''; eTags.value=(Array.isArray(data.tags)? data.tags.join(','): (data.tags||'')); eCostNt.value=data.cost_nt??'';
  if(data.cost_jpy!=null){ eCostCurrency.value='JPY'; eCostForeign.value=data.cost_jpy; }
  else { eCostCurrency.value='TWD'; eCostForeign.value=''; }

  eRunAssign.value='';
  if(runId){ const v=JSON.stringify({id:runId,title:(runsCache.find(r=>r.id===runId)?.title||'')}); Array.from(eRunAssign.options).forEach(o=>{ if(o.value===v) eRunAssign.value=v; }); }

  oldMain=data.img_url||null; oldImages=(data.images||'').split(/\n+/).filter(Boolean);
  eKeepOld.checked=true; keepOld=true; editFilesState.length=0; renderPreviews(eImgPreviews, editFilesState);

  editModal.style.display='block';
}
document.getElementById('eKeepOld').onchange=(e)=> keepOld=e.target.checked;

btnEditSave.onclick=async()=>{
  if(!editing) return;
  const d=new Date(), ym=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
  const uploaded=await uploadAll(editFilesState, `uploads/${ym}`);
  let main=oldMain, imgs=[...oldImages];
  if(!keepOld){ main=null; imgs=[]; }
  if(uploaded.length){
    if(!main) main=uploaded[0];
    imgs.push(...uploaded.slice(main?0:1));
  }

  let runObj=null; try{ runObj=JSON.parse(eRunAssign.value||''); }catch(_){}
  const eta=(eEta.value||'').trim() || (runObj?.title||null);

  const payload={
    name:eName.value||null, price:ePrice.value?Number(ePrice.value):null,
    category:eCategory.value||null, product_id:ePid.value||null, status:eStatus.value||null,
    arrival_time:eArrival.value||null, eta_text:eta, note:eNote.value||null,
    description:eDesc.value||null,
    img_url:main||null, images:imgs.join('\n'), cost_nt:eCostNt.value?Number(eCostNt.value):null,
    cost_jpy:(eCostCurrency.value==='JPY'? (eCostForeign.value?Number(eCostForeign.value):null) : null),
    tags: parseTags(eTags.value)
  };
  const { error }=await sb.from('products').update(payload).eq('id',editing.id);
  if(error){ alert('å„²å­˜å¤±æ•—ï¼š'+error.message); return; }

  // æ›´æ–° run å°æ‡‰
  await sb.from('product_runs').delete().match({product_id:editing.id});
  if(runObj?.id){ await sb.from('product_runs').upsert({product_id:editing.id, run_id:runObj.id},{onConflict:'product_id,run_id'}); }

  alert('å·²æ›´æ–°'); editModal.style.display='none'; await fillCategoryDatalist(); await loadProducts(prodFilterRun.value||null);
};

/* ==== Pool æ´¾é€ ==== */
let poolCheckedAll=false;
poolSelect.addEventListener('change', loadPoolProducts);
poolSelectAll.onclick=()=>{
  poolCheckedAll=!poolCheckedAll;
  document.querySelectorAll('.poolItemChk').forEach(c=> c.checked=poolCheckedAll);
};
async function loadPoolProducts(){
  const poolId=poolSelect.value||null;
  const box=document.getElementById('poolList'); box.innerHTML='';
  if(!poolId) return;
  const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',poolId);
  const ids=(pr||[]).map(x=>x.product_id);
  if(!ids.length){ box.innerHTML='<div class="muted">æ­¤ Pool ç›®å‰æ²’æœ‰å•†å“</div>'; return; }
  const { data:ps }=await sb.from('products').select('id,name,price,category,img_url,images').in('id',ids).order('created_at',{ascending:false});
  (ps||[]).forEach(p=>{
    const div=document.createElement('div'); div.className='card';
    const thumb=p.img_url? publicUrlFromPath(p.img_url):'';
    div.innerHTML=`
      <label style="display:flex;gap:8px;align-items:flex-start">
        <input type="checkbox" class="poolItemChk" value="${p.id}">
        <div style="flex:1">
          <div style="display:flex;gap:8px;align-items:center">
            ${thumb? `<img src="${thumb}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">`:''}
            <div>
              <div><strong>${p.name||''}</strong></div>
              <div class="muted">${p.category||''}ã€€NT$${p.price??''}</div>
            </div>
          </div>
        </div>
      </label>`;
    box.appendChild(div);
  });
}
poolCopy.onclick=async()=>{
  const poolId=poolSelect.value||''; const targetId=poolTarget.value||'';
  if(!poolId||!targetId){ alert('è«‹é¸ Pool èˆ‡ç›®æ¨™é€£ç·š'); return; }
  const ids=[...document.querySelectorAll('.poolItemChk:checked')].map(c=>c.value);
  if(!ids.length){ alert('è«‹å…ˆå‹¾é¸è¦è¤‡è£½çš„å•†å“'); return; }
  const rows=ids.map(pid=>({product_id:pid, run_id:targetId}));
  const { error }=await sb.from('product_runs').upsert(rows,{onConflict:'product_id,run_id'});
  if(error){ alert('è¤‡è£½å¤±æ•—ï¼š'+error.message); return; }
  alert(`å·²è¤‡è£½ ${ids.length} ä»¶åˆ°ç›®æ¨™é€£ç·š`);
};

/* ==== Bulkï¼ˆè¤‡è£½ï¼‰ ==== */
let bulkPreviewCount=0;
bulkPreview.onclick=async()=>{
  const from=bulkFrom.value||''; const to=bulkTo.value||''; const scope=bulkScope.value;
  if(!from||!to){ alert('è«‹é¸ä¾†æºèˆ‡ç›®æ¨™'); return; }
  let ids=[];
  const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',from);
  ids=(pr||[]).map(x=>x.product_id);
  bulkPreviewCount=ids.length;
  bulkInfo.textContent=`é è¨ˆè¤‡è£½ ${bulkPreviewCount} ä»¶ã€‚`;
};
bulkDo.onclick=async()=>{
  const to=bulkTo.value||''; if(!bulkPreviewCount||!to){ alert('è«‹å…ˆé è¦½'); return; }
  const from=bulkFrom.value||''; const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',from);
  const ids=(pr||[]).map(x=>x.product_id);
  const rows=ids.map(pid=>({product_id:pid, run_id:to}));
  const { error }=await sb.from('product_runs').upsert(rows,{onConflict:'product_id,run_id'});
  if(error){ alert('åŸ·è¡Œå¤±æ•—ï¼š'+error.message); return; }
  alert(`å·²è¤‡è£½ ${ids.length} ä»¶åˆ°ç›®æ¨™é€£ç·š`); bulkInfo.textContent='';
};

/* ==== Wishes ==== */
wishStatusFilter.addEventListener('change', loadWishes);
wishRunFilter.addEventListener('change', loadWishes);

async function loadWishes(){
  let q=sb.from('wishes')
    .select('id,created_at,run_id,category,product_name,product_url,content,image_path,status')
    .order('created_at',{ascending:false});
  const st=wishStatusFilter.value||''; if(st) q=q.eq('status', st);
  const rid=wishRunFilter.value||''; if(rid) q=q.eq('run_id', rid);
  const { data, error }=await q;
  const tb=wishesTable.querySelector('tbody'); tb.innerHTML='';
  if(error){ console.error(error); return; }
  (data||[]).forEach(w=>{
    const run = runsCache.find(r=>r.id===w.run_id);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="small muted">${new Date(w.created_at).toLocaleString('zh-TW')}</td>
      <td>${run? runLabel(run):''}</td>
      <td>${w.category||''}</td>
      <td>${w.product_name||''}</td>
      <td>${w.product_url? `<a href="${w.product_url}" target="_blank">é€£çµ</a>`:''}</td>
      <td>${w.content||''}</td>
      <td>${w.image_path? `<a href="${publicUrlFromPath(w.image_path)}" target="_blank">åœ–ç‰‡</a>`:''}</td>
      <td>
        <select data-id="${w.id}" class="wish-status">
          ${['pending','approved','rejected'].map(s=>`<option ${w.status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td>
        <button class="btn ghost" onclick="openReply('${w.id}')">å›è¦†</button>
        <button class="btn ghost" onclick="deleteWish('${w.id}')">åˆªé™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
  // ç¶å®šç‹€æ…‹æ›´æ–°
  document.querySelectorAll('.wish-status').forEach(sel=>{
    sel.onchange=async(e)=>{
      const id=e.target.getAttribute('data-id'); const st=e.target.value;
      await sb.from('wishes').update({status:st}).eq('id',id);
    };
  });
}
window.deleteWish=async(id)=>{
  if(!confirm('åˆªé™¤æ­¤è¨±é¡˜å–®ï¼Ÿ')) return;
  const { error }=await sb.from('wishes').delete().eq('id',id);
  if(error){ alert('åˆªé™¤å¤±æ•—ï¼š'+error.message); return; }
  await loadWishes();
};
window.openReply=async(id)=>{
  const text=prompt('è¼¸å…¥å›è¦†å…§å®¹'); if(!text) return;
  await sb.from('wish_replies').insert({wish_id:id, reply_text:text});
  alert('å·²å›è¦†');
};

/* ==== init ==== */
document.querySelectorAll('.tabbtn').forEach((b,i)=>{ if(i===0) b.click(); });
(async function init(){
  await loadRates(); await loadRuns(); await fillCategoryDatalist(); await loadProducts(); await loadWishes();await loadHomeNotice();
})();
</script>
</body>
</html>

