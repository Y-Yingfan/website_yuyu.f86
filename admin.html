<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>後台｜連線與商品管理</title>
<style>
:root{--bg:#f7f3ef;--paper:#fffdf9;--card:#fff;--ink:#2b2b2b;--muted:#7a7267;--brand:#8B5E34;--border:#eadfcd;--shadow:0 10px 24px rgba(139,94,52,.08);--radius:14px;--maxw:1080px}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#f8f5f1 0%,var(--bg) 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial}
.wrap{max-width:var(--maxw);margin:20px auto;padding:0 16px}
h1{margin:6px 0 14px}.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tabbtn{border:1px solid var(--border);background:#fffdf9;border-radius:999px;padding:8px 14px;cursor:pointer}
.tabbtn.active{background:var(--brand);color:#fff;border-color:transparent}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media (max-width:860px){.row{grid-template-columns:1fr}}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fffdfa}
textarea{min-height:72px}.btn{border:none;background:var(--brand);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid var(--border);color:#2b2b2b}
.list{width:100%;border-collapse:collapse}.list th,.list td{border-top:1px solid var(--border);padding:8px;vertical-align:top}
.list th{background:#fffaf2;text-align:left;font-weight:700}
.muted{color:var(--muted)}.small{font-size:12px}
.hr{height:1px;background:var(--border);margin:10px 0}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

.uploader{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fff}
.previews{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.preview{position:relative;width:100px;height:100px;background:#f3efe9;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.preview img{max-width:100%;max-height:100%;object-fit:contain}
.preview button{position:absolute;top:4px;right:4px;border:none;background:#000a;color:#fff;border-radius:6px;padding:2px 6px;cursor:pointer;font-size:12px}
.badge{display:inline-block;border:1px solid var(--border);padding:3px 8px;border-radius:999px;font-size:12px;background:#fff}
</style>
</head>
<body>
<div class="wrap">
  <h1>後台｜連線與商品管理 <span class="badge">Supabase</span></h1>

  <div class="tabs">
    <button class="tabbtn active" data-tab="products">Products</button>
    <button class="tabbtn" data-tab="runs">Runs</button>
    <button class="tabbtn" data-tab="pool">Pool 派送</button>
    <button class="tabbtn" data-tab="bulk">Bulk Move</button>
    <button class="tabbtn" data-tab="settings">Settings</button>
  </div>

  <!-- PRODUCTS -->
  <section id="tab-products">
    <div class="panel">
      <h3 style="margin:0 0 10px">新增商品（可指派到連線／或放共用池）</h3>
      <div class="row">
        <div>
          <label>名稱 name</label>
          <input id="pName" />
        </div>
        <div>
          <label>售價 price（NT$）</label>
          <input id="pPrice" type="number" step="1" min="0" />
        </div>

        <div>
          <label>分類 category（下拉＋可新增）</label>
          <input id="pCategory" list="categoryList" placeholder="選或直接輸入新增"/>
          <datalist id="categoryList"></datalist>
        </div>
        <div>
          <label>商品編號 product_id（留空自動）</label>
          <input id="pPid" placeholder="留空→自動 PYYYYMMDD-XXX"/>
        </div>

        <div>
          <label>狀態 status</label>
          <input id="pStatus" list="statusList" placeholder="選或自行輸入"/>
          <datalist id="statusList">
            <option value="現貨"></option>
            <option value="預購"></option>
            <option value="售罄"></option>
          </datalist>
        </div>
        <div>
          <label>到貨日 arrival_time</label>
          <input id="pArrival" type="date"/>
        </div>

        <div>
          <label>指派到連線（含共用池）</label>
          <select id="pRunAssign"><option value="">— 選擇連線 —</option></select>
        </div>
        <div>
          <label>eta_text（若上面沒選可手填）</label>
          <input id="pEta" placeholder="例：9/26 東京"/>
        </div>

        <div style="grid-column:1 / -1">
          <label>備註 / 補充 note</label>
          <input id="pNote"/>
        </div>

        <div style="grid-column:1 / -1">
          <label>標籤 tags（逗號分隔）</label>
          <input id="pTags" placeholder="3coins,and us,腮紅"/>
        </div>

        <!-- 成本與幣別 -->
        <div>
          <label>成本幣別</label>
          <select id="pCostCurrency">
            <option value="TWD">TWD（台幣）</option>
            <option value="JPY">JPY（日幣）</option>
            <option value="KRW">KRW（韓元）</option>
            <option value="USD">USD（美金）</option>
          </select>
        </div>
        <div>
          <label>成本（原幣）</label>
          <input id="pCostForeign" type="number" step="0.01" min="0" placeholder="例如 350"/>
        </div>
        <div>
          <label>台幣成本（系統自算，可覆寫）</label>
          <input id="pCostNt" type="number" step="1" min="0" placeholder="自動換算"/>
        </div>
        <div class="small" style="display:flex;align-items:flex-end">目前匯率：
          <span id="rateTip" style="margin-left:6px"></span>
        </div>

        <!-- 圖片上傳 -->
        <div style="grid-column:1 / -1">
          <label>商品圖片（可多張）</label>
          <div class="uploader">
            <input type="file" id="imgFiles" accept="image/*" multiple />
            <div class="previews" id="imgPreviews"></div>
            <div class="small muted">上傳後會存相對路徑至 DB：第一張作為代表圖，其餘寫入 <code>products.images</code>（換行分隔）。</div>
          </div>
        </div>
      </div>

      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnCreateProduct">新增商品</button>
        <span class="muted small">送出將自動建立 <code>product_runs</code> 對應（若有選連線）。</span>
      </div>
    </div>

    <div class="panel">
      <div class="flex" style="justify-content:space-between">
        <h3 style="margin:0 0 10px">已新增（最新 50，可編輯）</h3>
        <div class="flex">
          <label class="small">檢視</label>
          <select id="prodFilterRun" style="min-width:220px">
            <option value="">全部商品</option>
          </select>
        </div>
      </div>
      <table class="list" id="productsTable">
        <thead><tr>
          <th>名稱</th><th style="width:90px">售價</th><th style="width:130px">分類</th>
          <th style="width:150px">編號</th><th style="width:220px">連線 / eta_text</th>
          <th style="width:160px">成本(TWD)</th><th style="width:120px">利潤</th>
          <th style="width:170px">操作</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- RUNS（保留你原本的功能，省略細節） -->
  <section id="tab-runs" style="display:none">
    <div class="panel"><h3 style="margin:0 0 10px">Runs</h3>
      <div id="runsHint" class="small muted">（此分頁保留，與前版一致；若要我再加功能，跟我說）</div>
    </div>
  </section>

  <!-- Pool -->
  <section id="tab-pool" style="display:none">
    <div class="panel"><h3 style="margin:0 0 10px">Pool 派送</h3>
      <div id="poolHint" class="small muted">（保留：從共用池多選派送到某連線的功能）</div>
    </div>
  </section>

  <!-- Bulk -->
  <section id="tab-bulk" style="display:none">
    <div class="panel"><h3 style="margin:0 0 10px">Bulk Move</h3>
      <div id="bulkHint" class="small muted">（保留：連線間批次移動/複製）</div>
    </div>
  </section>

  <!-- SETTINGS：匯率 -->
  <section id="tab-settings" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 10px">匯率設定</h3>
      <div class="row">
        <div><label>JPY → TWD</label><input id="rateJPY" type="number" step="0.0001" /></div>
        <div><label>KRW → TWD</label><input id="rateKRW" type="number" step="0.00001" /></div>
        <div><label>USD → TWD</label><input id="rateUSD" type="number" step="0.0001" /></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnSaveRates">儲存匯率</button>
        <span class="muted small">儲存在 <code>site_meta</code>（key：<code>rate_JPY</code>/<code>rate_KRW</code>/<code>rate_USD</code>）。</span>
      </div>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl='https://llbpmqyjigovxixeohzr.supabase.co';
const supabaseKey='sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
const BUCKET='yuyu.f86';
const sb=supabase.createClient(supabaseUrl,supabaseKey);

// Tabs
document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none');
    document.getElementById('tab-'+btn.dataset.tab).style.display='block';
  };
});

// ====== 匯率 ======
let RATES={JPY:0.22, KRW:0.024, USD:32.0};
async function loadRates(){
  const keys=['rate_JPY','rate_KRW','rate_USD'];
  const { data }=await sb.from('site_meta').select('key,value').in('key', keys);
  (data||[]).forEach(kv=>{
    if(kv.key==='rate_JPY') RATES.JPY = Number(kv.value)||RATES.JPY;
    if(kv.key==='rate_KRW') RATES.KRW = Number(kv.value)||RATES.KRW;
    if(kv.key==='rate_USD') RATES.USD = Number(kv.value)||RATES.USD;
  });
  rateJPY.value=RATES.JPY; rateKRW.value=RATES.KRW; rateUSD.value=RATES.USD;
  document.getElementById('rateTip').textContent=`JPY=${RATES.JPY}，KRW=${RATES.KRW}，USD=${RATES.USD}`;
}
document.getElementById('btnSaveRates').onclick=async()=>{
  const rows=[
    {key:'rate_JPY', value:String(rateJPY.value||RATES.JPY)},
    {key:'rate_KRW', value:String(rateKRW.value||RATES.KRW)},
    {key:'rate_USD', value:String(rateUSD.value||RATES.USD)},
  ];
  for(const r of rows){
    await sb.from('site_meta').upsert(r,{onConflict:'key'});
  }
  await loadRates(); alert('已儲存匯率');
};

// 成本自動換算
['pCostCurrency','pCostForeign'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    const cur=pCostCurrency.value, amt=Number(pCostForeign.value||0);
    let nt=null;
    if(cur==='TWD') nt=amt;
    else if(cur==='JPY') nt=amt*RATES.JPY;
    else if(cur==='KRW') nt=amt*RATES.KRW;
    else if(cur==='USD') nt=amt*RATES.USD;
    pCostNt.value = nt? Math.round(nt) : '';
  });
});

// ====== 連線 ======
let runsCache=[];
function runLabel(r){ return r.title||r.code||r.region||('Run#'+r.id); }
async function loadRuns(){
  const { data }=await sb.from('runs').select('*').order('created_at',{ascending:false});
  runsCache=data||[];
  const assign=document.getElementById('pRunAssign');
  const prodFilter=document.getElementById('prodFilterRun');
  assign.innerHTML='<option value="">— 選擇連線 —</option>';
  prodFilter.innerHTML='<option value="">全部商品</option>';
  runsCache.forEach(r=>{
    assign.appendChild(new Option(runLabel(r), JSON.stringify({id:r.id,title:r.title||''})));
    prodFilter.appendChild(new Option(runLabel(r), r.id));
  });
}

// ====== 類別/狀態 候選 ======
async function fillCategoryDatalist(){
  const { data }=await sb.from('products').select('category').not('category','is',null);
  const set=new Set((data||[]).map(x=>x.category).filter(Boolean));
  const dl=document.getElementById('categoryList'); dl.innerHTML='';
  Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hant')).forEach(c=>{
    const o=document.createElement('option'); o.value=c; dl.appendChild(o);
  });
}

// ====== 自動編號 ======
async function genNextPid(){
  const d=new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  const prefix=`P${y}${m}${day}-`;
  const { data } = await sb.from('products').select('product_id').ilike('product_id', `${prefix}%`).order('product_id',{ascending:false}).limit(1);
  let seq=1;
  if(data&&data[0]?.product_id){ const n=parseInt(String(data[0].product_id).split('-').pop().replace(/\D/g,''),10); if(!isNaN(n)) seq=n+1; }
  return prefix+String(seq).padStart(3,'0');
}

// ====== 圖片上傳（多張） ======
const filesState=[]; // {file, url(preview), uploadedPath}
const previewsBox=document.getElementById('imgPreviews');

function renderPreviews(){
  previewsBox.innerHTML='';
  filesState.forEach((f,idx)=>{
    const box=document.createElement('div'); box.className='preview';
    const img=document.createElement('img'); img.src=f.url; box.appendChild(img);
    const x=document.createElement('button'); x.textContent='刪除';
    x.onclick=()=>{ filesState.splice(idx,1); renderPreviews(); };
    box.appendChild(x);
    previewsBox.appendChild(box);
  });
}

document.getElementById('imgFiles').addEventListener('change', (e)=>{
  Array.from(e.target.files||[]).forEach(file=>{
    const url=URL.createObjectURL(file);
    filesState.push({file, url, uploadedPath:null});
  });
  renderPreviews();
});

async function uploadAllImages(baseFolder){
  // baseFolder 建議：`products/${YYYYMM}/${runTitle或category}`
  const uploaded=[];
  for(const item of filesState){
    if(item.uploadedPath){ uploaded.push(item.uploadedPath); continue; }
    const name= `${Date.now()}_${Math.random().toString(36).slice(2,8)}_${item.file.name}`;
    const path=`${baseFolder}/${name}`.replace(/\/+/g,'/');
    const { error } = await sb.storage.from(BUCKET).upload(path, item.file, { upsert:false, cacheControl:'3600' });
    if(error){ console.error('upload fail', error); continue; }
    item.uploadedPath=path; uploaded.push(path);
  }
  return uploaded; // 相對路徑
}

// ====== 新增商品 ======
function parseTags(s){ const raw=(s||'').trim(); return raw? raw.split(',').map(x=>x.trim()).filter(Boolean):null; }

document.getElementById('pRunAssign').addEventListener('change', e=>{
  const v=e.target.value; if(!v) return; try{ const obj=JSON.parse(v); if(obj.title) document.getElementById('pEta').value=obj.title; }catch(_){}
});

document.getElementById('btnCreateProduct').onclick=async()=>{
  let pid=(pPid.value||'').trim(); if(!pid) pid=await genNextPid();
  let runObj=null; try{ runObj=JSON.parse(pRunAssign.value||''); }catch(_){}
  const eta=(pEta.value||'').trim() || (runObj?.title||null);

  // 先上傳圖片
  const date=new Date(), ym=`${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}`;
  const baseFolder = `uploads/${ym}`;
  const uploaded = await uploadAllImages(baseFolder);
  const img_url = uploaded[0] ? uploaded[0] : (null);
  const imagesText = uploaded.slice(1).join('\n'); // 其餘寫 images（換行分隔）

  // 成本
  let cost_nt = pCostNt.value? Number(pCostNt.value): null;

  const payload={
    name:(pName.value||'').trim(),
    price: pPrice.value? Number(pPrice.value): null,
    category:(pCategory.value||'').trim()||null,
    product_id: pid,
    status:(pStatus.value||'').trim()||null,
    arrival_time:(pArrival.value||'')||null,
    eta_text: eta,
    note:(pNote.value||'').trim()||null,
    img_url: img_url,
    images: imagesText,
    cost_jpy: (pCostCurrency.value==='JPY' ? Number(pCostForeign.value||0): null),
    cost_nt : cost_nt,
    tags: parseTags(pTags.value)
  };

  if(!payload.name){ alert('請輸入商品名稱'); return; }

  const { data, error } = await sb.from('products').insert(payload).select();
  if(error){ alert('新增商品失敗：'+error.message); return; }
  const product=data?.[0];

  if(runObj?.id && product?.id){
    await sb.from('product_runs').delete().match({product_id:product.id});
    await sb.from('product_runs').insert({product_id:product.id, run_id:runObj.id});
  }

  alert('新增商品成功');
  // reset
  ['pName','pPrice','pCategory','pPid','pStatus','pArrival','pEta','pNote','pTags','pCostForeign','pCostNt'].forEach(id=>document.getElementById(id).value='');
  filesState.length=0; renderPreviews();
  await fillCategoryDatalist();
  await loadProducts();
};

// ====== 列表（簡版、含利潤） ======
function profitNT(price, cost_nt){
  if(price==null || cost_nt==null) return null;
  return Number(price)-Number(cost_nt);
}
async function loadProducts(runFilterId=null){
  let q=sb.from('products').select('id,name,price,category,product_id,eta_text,cost_jpy,cost_nt').order('created_at',{ascending:false}).limit(50);
  if(runFilterId){
    const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',runFilterId);
    const ids=(pr||[]).map(x=>x.product_id); if(ids.length) q=q.in('id',ids); else q=q.in('id',['00000000-0000-0000-0000-000000000000']);
  }
  const { data, error } = await q;
  if(error){ console.error(error); return; }
  const tb=document.querySelector('#productsTable tbody'); tb.innerHTML='';
  (data||[]).forEach(p=>{
    const costNT=(p.cost_nt!=null)?Number(p.cost_nt):(p.cost_jpy!=null?Number(p.cost_jpy)*RATES.JPY:null);
    const pf=profitNT(p.price, costNT);
    const tr=document.createElement('tr'); tr.dataset.id=p.id;
    tr.innerHTML=`
      <td>${p.name||''}</td>
      <td>${p.price??''}</td>
      <td>${p.category||''}</td>
      <td>${p.product_id||''}</td>
      <td>${p.eta_text||''}</td>
      <td>${costNT!=null?Math.round(costNT):'—'}</td>
      <td>${pf!=null?Math.round(pf):'—'}</td>
      <td><button class="btn ghost" data-id="${p.id}" onclick="alert('暫留：如需完整編輯/刪除，跟我說要加哪幾欄')">編輯</button></td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('prodFilterRun').addEventListener('change', e=>{
  const id=e.target.value||null; loadProducts(id);
});

// ====== init ======
(async function init(){
  await loadRates();
  await loadRuns();
  await fillCategoryDatalist();
  await loadProducts();
})();
</script>
</body>
</html>
