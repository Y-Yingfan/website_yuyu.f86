<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>商品後台管理</title>
  <style>
    :root {
      --bg: #f9f5ef;
      --muted: #6c757d;
      --line: #cccccc;
      --primary: #d4a373;
    }
    body {
      margin: 0; padding: 20px;
      font-family: sans-serif;
      background: var(--bg); color: #333;
    }
    h1, h2, h3 { margin: 0 0 15px; }
    input, button { font: inherit; }
    input[type=email], input[type=password],
    input[type=text], input[type=number] {
      display: block;
      width: 100%; max-width: 300px;
      box-sizing: border-box;
      padding: 8px;
      margin: 5px 0 10px;
    }
    button {
      cursor: pointer;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
    }
    .btn.primary {
      background: var(--primary);
      color: #fff;
      border: 1px solid var(--primary);
    }
    .btn.outline {
      background: #fff;
      color: #000;
      border: 1px solid var(--line);
    }
    .hide { display: none; }
    table {
      width: 100%; max-width: 800px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: left;
      padding: 8px;
    }
    th { background: #eee; }
    img.product-img {
      display: block;
      max-width: 60px;
      max-height: 60px;
    }
  </style>
</head>
<body>

<h1>商品後台管理</h1>

<!-- 登入區塊 -->
<div id="authSection">
  <h2>管理員登入</h2>
  <form id="loginForm">
    <input id="email" type="email" placeholder="電子郵件" required />
    <input id="password" type="password" placeholder="密碼（至少8位數）" minlength="8" required />
    <button type="submit" class="btn primary">登入</button>
    <button type="button" id="btnRegister" class="btn outline">註冊（第一次使用）</button>
  </form>
</div>

<!-- 管理介面區塊（登入後顯示） -->
<div id="adminSection" class="hide">
  <h2>商品列表</h2>
  <table>
    <thead>
      <tr>
        <th>圖片</th><th>名稱</th><th>分類</th><th>價格</th><th>狀態</th><th>到貨時間</th><th>操作</th>
      </tr>
    </thead>
    <tbody id="productTableBody"></tbody>
  </table>

  <h3 style="margin-top:30px;">新增商品</h3>
  <form id="productForm">
    <div style="margin-bottom: 8px;">
      <label>名稱：<input type="text" id="prodName" required /></label>
    </div>
    <div style="margin-bottom: 8px;">
      <label>價格：<input type="number" id="prodPrice" required /></label>
    </div>
    <div style="margin-bottom: 8px;">
      <label>分類：<input type="text" id="prodCategory" /></label>
    </div>
    <div style="margin-bottom: 8px;">
      <label>狀態：<input type="text" id="prodStatus" /></label>
    </div>
    <div style="margin-bottom: 8px;">
      <label>到貨時間：<input type="text" id="prodArrival" /></label>
    </div>
    <div style="margin-bottom: 8px;">
      <label>圖片：<input type="file" id="prodImage" accept="image/*" /></label>
    </div>
    <button type="submit" class="btn primary">新增商品</button>
  </form>
</div>

<!-- Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // 初始化 Supabase 用戶端
  const SUPABASE_URL = 'https://yuyu.f86.supabase.co';
  const SUPABASE_ANON_KEY = 'sb.publishable_LfRyqSfqfQWsC8SDGumiJA_2YfoAtHB';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // 常用 DOM 元素
  const authSection = document.getElementById('authSection');
  const adminSection = document.getElementById('adminSection');
  const loginForm = document.getElementById('loginForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const btnRegister = document.getElementById('btnRegister');
  const productTableBody = document.getElementById('productTableBody');
  const productForm = document.getElementById('productForm');
  const prodName = document.getElementById('prodName');
  const prodPrice = document.getElementById('prodPrice');
  const prodCategory = document.getElementById('prodCategory');
  const prodStatus = document.getElementById('prodStatus');
  const prodArrival = document.getElementById('prodArrival');
  const prodImage = document.getElementById('prodImage');

  // 將商品渲染為表格一列
  function appendProductRow(product, imageUrl) {
    const tr = document.createElement('tr');

    // 圖片欄位
    const tdImg = document.createElement('td');
    if (imageUrl) {
      const img = document.createElement('img');
      img.src = imageUrl;
      img.alt = '產品圖片';
      img.className = 'product-img';
      tdImg.appendChild(img);
    }
    tr.appendChild(tdImg);

    // 名稱欄位
    const tdName = document.createElement('td');
    tdName.textContent = product.name || '';
    tr.appendChild(tdName);

    // 分類欄位
    const tdCat = document.createElement('td');
    tdCat.textContent = product.category || '';
    tr.appendChild(tdCat);

    // 價格欄位
    const tdPrice = document.createElement('td');
    tdPrice.textContent = (product.price !== null) ? product.price : '';
    tr.appendChild(tdPrice);

    // 狀態欄位
    const tdStatus = document.createElement('td');
    tdStatus.textContent = product.status || '';
    tr.appendChild(tdStatus);

    // 到貨時間欄位
    const tdArr = document.createElement('td');
    tdArr.textContent = product.arrival_time || '';
    tr.appendChild(tdArr);

    // 操作欄位（刪除按鈕）
    const tdAction = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.textContent = '刪除';
    delBtn.className = 'btn outline delete-btn';
    delBtn.setAttribute('data-id', product.id);
    tdAction.appendChild(delBtn);
    tr.appendChild(tdAction);

    productTableBody.appendChild(tr);
  }

  // 從資料庫載入產品列表並顯示
  async function loadProducts() {
    const { data: products, error } = await supabase
      .from('products')
      .select('*')
      .order('created_at', { ascending: true });
    if (error) {
      alert('載入商品資料失敗：' + error.message);
      return;
    }
    // 取得圖片清單以配對產品ID
    let files = [];
    const { data: fileList, error: fileError } = await supabase
      .storage
      .from('yuyu.f86')
      .list('', { limit: 1000 });
    if (!fileError) {
      files = fileList;
    } else {
      console.warn('載入圖片清單失敗：', fileError.message);
    }
    productTableBody.innerHTML = ''; // 清空表格
    for (const prod of products) {
      let imageUrl = '';
      if (files.length > 0) {
        const file = files.find(f => f.name.split('.')[0] === prod.id);
        if (file) {
          const { data: urlData } = supabase.storage.from('yuyu.f86').getPublicUrl(file.name);
          imageUrl = urlData.publicUrl;
        }
      }
      appendProductRow(prod, imageUrl);
    }
  }

  // 頁面載入時檢查當前是否有登入會話
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      authSection.classList.add('hide');
      adminSection.classList.remove('hide');
      loadProducts();
    }
  });

  // 監聽登入表單提交事件
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = emailInput.value;
    const password = passwordInput.value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      alert(error.message);
    } else {
      // 登入成功
      emailInput.value = passwordInput.value = '';
      authSection.classList.add('hide');
      adminSection.classList.remove('hide');
      loadProducts();
    }
  });

  // 監聽「註冊」按鈕點擊事件
  btnRegister.addEventListener('click', async () => {
    const email = emailInput.value;
    const password = passwordInput.value;
    if (!email || !password) {
      alert('請輸入電子郵件和密碼進行註冊');
      return;
    }
    const { data, error } = await supabase.auth.signUp({ email, password });
    if (error) {
      alert(error.message);
    } else {
      // 註冊成功
      if (data.user && !data.session) {
        alert('註冊成功！請至信箱完成驗證，然後使用該帳號登入。');
        emailInput.value = passwordInput.value = '';
      }
      if (data.session) {
        alert('註冊成功！已自動登入。');
        emailInput.value = passwordInput.value = '';
        authSection.classList.add('hide');
        adminSection.classList.remove('hide');
        loadProducts();
      }
    }
  });

  // 監聽商品新增表單提交事件
  productForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = prodName.value.trim();
    const price = prodPrice.value ? Number(prodPrice.value) : null;
    const category = prodCategory.value.trim();
    const status = prodStatus.value.trim();
    const arrival = prodArrival.value.trim();
    if (!name || price === null || isNaN(price)) {
      alert('請填寫完整的商品名稱和價格！');
      return;
    }
    // 新增產品資料到資料庫
    const { data: result, error } = await supabase.from('products').insert([{
      name: name,
      price: price,
      category: category || null,
      status: status || null,
      arrival_time: arrival || null
    }]).select();
    if (error) {
      alert('新增商品失敗：' + error.message);
      return;
    }
    const newProduct = result[0];
    let imageUrl = '';
    // 如果有選擇圖片，則上傳至 Storage
    const file = prodImage.files[0];
    if (file) {
      const ext = file.name.split('.').pop();
      const fileName = newProduct.id + (ext ? '.' + ext : '');
      const { error: uploadError } = await supabase.storage.from('yuyu.f86').upload(fileName, file);
      if (uploadError) {
        // 圖片上傳失敗，但產品已新增
        appendProductRow(newProduct, '');  // 顯示產品無圖
        productForm.reset();
        alert('商品已新增，但圖片上傳失敗：' + uploadError.message);
        return;
      } else {
        const { data: pubData } = supabase.storage.from('yuyu.f86').getPublicUrl(fileName);
        imageUrl = pubData.publicUrl;
      }
    }
    // 將新商品加入列表顯示
    appendProductRow(newProduct, imageUrl);
    productForm.reset();
    alert('商品新增成功！');
  });

  // 監聽刪除按鈕點擊事件（利用事件委派）
  productTableBody.addEventListener('click', async (e) => {
    if (e.target.matches('.delete-btn')) {
      const productId = e.target.getAttribute('data-id');
      if (productId && confirm('確定要刪除此商品嗎？')) {
        const { error } = await supabase.from('products').delete().eq('id', productId);
        if (error) {
          alert('刪除失敗：' + error.message);
        } else {
          e.target.closest('tr').remove();
          alert('商品已刪除！');
        }
      }
    }
  });
</script>
</body>
</html>
