<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>後台｜連線與商品管理</title>
<style>
:root{--bg:#f7f3ef;--paper:#fffdf9;--card:#fff;--ink:#2b2b2b;--muted:#7a7267;--brand:#8B5E34;--border:#eadfcd;--shadow:0 10px 24px rgba(139,94,52,.08);--radius:14px;--maxw:1080px}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#f8f5f1 0%,var(--bg) 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial}
.wrap{max-width:var(--maxw);margin:20px auto;padding:0 16px}
h1{margin:6px 0 14px}.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tabbtn{border:1px solid var(--border);background:#fffdf9;border-radius:999px;padding:8px 14px;cursor:pointer}
.tabbtn.active{background:var(--brand);color:#fff;border-color:transparent}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media (max-width:860px){.row{grid-template-columns:1fr}}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fffdfa}
textarea{min-height:72px}.btn{border:none;background:var(--brand);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid var(--border);color:#2b2b2b}
.list{width:100%;border-collapse:collapse}.list th,.list td{border-top:1px solid var(--border);padding:8px;vertical-align:top}
.list th{background:#fffaf2;text-align:left;font-weight:700}
.muted{color:var(--muted)}.small{font-size:12px}
.uploader{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fff}
.previews{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.preview{position:relative;width:100px;height:100px;background:#f3efe9;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.preview img{max-width:100%;max-height:100%;object-fit:contain}
.preview button{position:absolute;top:4px;right:4px;border:none;background:#000a;color:#fff;border-radius:6px;padding:2px 6px;cursor:pointer;font-size:12px}
.badge{display:inline-block;border:1px solid var(--border);padding:3px 8px;border-radius:999px;font-size:12px;background:#fff}

/* Modal */
.modal{display:none;position:fixed;inset:0;z-index:1000}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
.sheet{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(980px,92vw);max-height:90vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px}
.sheet h3{margin:0 0 8px}

/* Pool grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.card{border:1px solid var(--border);border-radius:10px;background:#fff;padding:10px}
.card .muted{font-size:12px}
hr.sep{border:none;border-top:1px dashed var(--border);margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <h1>後台｜連線與商品管理 <span class="badge">Supabase</span></h1>

  <div class="tabs">
    <button class="tabbtn active" data-tab="products">Products</button>
    <button class="tabbtn" data-tab="runs">Runs</button>
    <button class="tabbtn" data-tab="pool">Pool 派送</button>
    <button class="tabbtn" data-tab="bulk">Bulk Move</button>
    <button class="tabbtn" data-tab="wishes">Wishes</button>
    <button class="tabbtn" data-tab="settings">Settings</button>
  </div>

  <!-- PRODUCTS -->
  <section id="tab-products">
    <div class="panel">
      <h3 style="margin:0 0 10px">新增商品（可指派到連線／或放共用池）</h3>
      <div class="row">
        <div><label>名稱 name</label><input id="pName" /></div>
        <div><label>售價 price（NT$）</label><input id="pPrice" type="number" step="1" min="0" /></div>
        <div><label>分類 category（下拉＋可新增）</label><input id="pCategory" list="categoryList" placeholder="選或直接輸入新增"/><datalist id="categoryList"></datalist></div>
        <div><label>商品編號 product_id（留空自動）</label><input id="pPid" placeholder="留空→自動 PYYYYMMDD-XXX"/></div>
        <div><label>狀態 status</label>
          <input id="pStatus" list="statusList" placeholder="選或自行輸入"/>
          <datalist id="statusList"><option value="現貨"></option><option value="預購"></option><option value="售罄"></option></datalist>
        </div>
        <div><label>開始寄送日（前台顯示）</label><input id="pArrival" type="date"/></div>
        <div><label>指派到連線（含共用池）</label><select id="pRunAssign"><option value="">— 選擇連線 —</option></select></div>
        <div><label>eta_text（若上面沒選可手填）</label><input id="pEta" placeholder="例：9/26 東京"/></div>
        <div style="grid-column:1 / -1"><label>描述 description（非必填）</label><textarea id="pDesc" placeholder="想補充的說明文字…"></textarea></div>
        <div style="grid-column:1 / -1"><label>備註 / 補充 note</label><input id="pNote"/></div>
        <div style="grid-column:1 / -1"><label>標籤 tags（逗號分隔）</label><input id="pTags" placeholder="3coins,and us,腮紅"/></div>
        <div><label>成本幣別</label><select id="pCostCurrency"><option value="TWD">TWD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="USD">USD</option></select></div>
        <div><label>成本（原幣）</label><input id="pCostForeign" type="number" step="0.01" min="0" placeholder="例如 350"/></div>
        <div><label>台幣成本（系統自算，可覆寫）</label><input id="pCostNt" type="number" step="1" min="0" placeholder="自動換算"/></div>
        <div class="small" style="display:flex;align-items:flex-end">目前匯率：<span id="rateTip" style="margin-left:6px"></span></div>
        <div style="grid-column:1 / -1">
          <label>商品圖片（可多張）</label>
          <div class="uploader">
            <input type="file" id="imgFiles" accept="image/*" multiple />
            <div class="previews" id="imgPreviews"></div>
            <div class="small muted">上傳後存相對路徑；第一張做代表圖，其餘寫入 <code>products.images</code>（換行分隔）。</div>
          </div>
        </div>
      </div>
      <div class="row">
        <div><button class="btn" id="btnCreateProduct">新增商品</button></div>
      </div>
    </div>

    <div class="panel">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0 0 10px">已新增（最新 50，可編輯/刪除）</h3>
        <div class="flex" style="gap:8px;align-items:center">
          <label class="small">檢視</label>
          <select id="prodFilterRun" style="min-width:220px"><option value="">全部商品</option></select>
        </div>
      </div>
      <table class="list" id="productsTable">
        <thead><tr>
          <th>名稱</th><th style="width:90px">售價</th><th style="width:130px">分類</th>
          <th style="width:150px">編號</th><th style="width:220px">連線 / eta_text</th>
          <th style="width:160px">成本(TWD)</th><th style="width:120px">利潤</th>
          <th style="width:260px">操作</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- RUNS -->
  <section id="tab-runs" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 8px">新增 / 編輯 連線</h3>
      <div class="row">
        <div><label>標題 title</label><input id="rTitle" placeholder="例：9/26 東京 或 JP 共用池"/></div>
        <div><label>代碼 code（選填）</label><input id="rCode"/></div>
        <div><label>區域 region</label><input id="rRegion" placeholder="JP / KR / etc."/></div>
        <div><label>開始 start_date</label><input id="rStart" type="date"/></div>
        <div><label>結束 end_date</label><input id="rEnd" type="date"/></div>
        <div><label>寄送開始 ship_start_date</label><input id="rShip" type="date"/></div>
        <div style="grid-column:1 / -1"><label>備註 note</label><input id="rNote"/></div>
        <div>
          <label>是否啟用 is_active</label>
          <select id="rActive"><option>true</option><option>false</option></select>
        </div>
        <div>
          <label>首頁 featured</label>
          <select id="rFeatured"><option>false</option><option>true</option></select>
        </div>
        <div>
          <label>是否 Pool（共用池）</label>
          <select id="rIsPool"><option value="false">否</option><option value="true">是</option></select>
        </div>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="btnRunCreate">儲存（新增/更新）</button>
        <button class="btn ghost" id="btnRunReset">清空</button>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px">所有連線</h3>
      <table class="list" id="runsTable">
        <thead><tr>
          <th>標題</th><th>區域</th><th>日期</th><th>寄送</th><th>備註</th><th>狀態</th><th>首頁</th><th>Pool</th><th>操作</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- POOL 派送（從 pool 複製到 run） -->
  <section id="tab-pool" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 10px">從共用池「複製」商品到某次連線</h3>
      <div class="row">
        <div>
          <label>選擇 Pool 連線（is_pool=true）</label>
          <select id="poolSelect"><option value="">— 選擇 Pool —</option></select>
        </div>
        <div>
          <label>目標連線（實際跑團）</label>
          <select id="poolTarget"><option value="">— 選擇目標連線 —</option></select>
        </div>
      </div>
      <div class="small muted">這裡是「複製」關聯：會新增 <code>product_runs</code> 到目標連線；Pool 仍保留。</div>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Pool 內商品（可多選）</h3>
        <div>
          <button class="btn ghost" id="poolSelectAll">全選/全不選</button>
          <button class="btn" id="poolCopy">複製到目標連線</button>
        </div>
      </div>
      <div id="poolList" class="grid" style="margin-top:10px"></div>
    </div>
  </section>

  <!-- BULK MOVE（複製） -->
  <section id="tab-bulk" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 10px">批次複製商品到另一個連線</h3>
      <div class="row">
        <div><label>來源連線</label><select id="bulkFrom"><option value="">— 選擇來源 —</option></select></div>
        <div><label>目標連線</label><select id="bulkTo"><option value="">— 選擇目標 —</option></select></div>
        <div><label>範圍</label><select id="bulkScope">
          <option value="linked">只包含已關聯的商品（product_runs）</option>
          <option value="all">來源連線的全部商品（同上，通常仍以關聯為準）</option>
        </select></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="bulkPreview">預覽數量</button>
        <button class="btn" id="bulkDo">執行複製</button>
        <div id="bulkInfo" class="small muted" style="margin-left:8px"></div>
      </div>
    </div>
  </section>

  <!-- WISHES -->
  <section id="tab-wishes" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 8px">許願清單</h3>
      <div class="row">
        <div><label>篩選狀態</label>
          <select id="wishStatusFilter">
            <option value="">全部</option>
            <option value="pending">pending</option>
            <option value="approved">approved</option>
            <option value="rejected">rejected</option>
          </select>
        </div>
        <div><label>篩選連線</label>
          <select id="wishRunFilter"><option value="">全部</option></select>
        </div>
      </div>
      <table class="list" id="wishesTable" style="margin-top:10px">
        <thead>
          <tr>
            <th>時間</th><th>連線</th><th>分類</th><th>商品名稱</th><th>網址</th><th>內容</th><th>圖片</th><th>狀態</th><th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 10px">匯率設定</h3>
      <div class="row">
        <div><label>JPY → TWD</label><input id="rateJPY" type="number" step="0.0001" /></div>
        <div><label>KRW → TWD</label><input id="rateKRW" type="number" step="0.00001" /></div>
        <div><label>USD → TWD</label><input id="rateUSD" type="number" step="0.0001" /></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="btnSaveRates">儲存匯率</button>
        <span class="muted small">儲存在 <code>site_meta</code>（key：<code>rate_JPY</code>/<code>rate_KRW</code>/<code>rate_USD</code>）。</span>
      </div>
    </div>
  </section>
</div>

<!-- 編輯商品 Modal -->
<div id="editModal" class="modal">
  <div class="overlay"></div>
  <div class="sheet">
    <h3>編輯商品</h3>
    <div class="row">
      <div><label>名稱</label><input id="eName"/></div>
      <div><label>售價（NT$）</label><input id="ePrice" type="number" min="0" step="1"/></div>
      <div><label>分類</label><input id="eCategory" list="categoryList"/></div>
      <div><label>商品編號</label><input id="ePid"/></div>
      <div><label>狀態</label><input id="eStatus" list="statusList"/></div>
      <div><label>開始寄送日</label><input id="eArrival" type="date"/></div>
      <div><label>指派到連線</label><select id="eRunAssign"><option value="">— 選擇連線 —</option></select></div>
      <div><label>eta_text</label><input id="eEta"/></div>
      <div style="grid-column:1 / -1"><label>描述</label><textarea id="eDesc"></textarea></div>
      <div style="grid-column:1 / -1"><label>備註</label><input id="eNote"/></div>
      <div style="grid-column:1 / -1"><label>標籤（逗號分隔）</label><input id="eTags"/></div>
      <div><label>成本幣別</label><select id="eCostCurrency"><option>TWD</option><option>JPY</option><option>KRW</option><option>USD</option></select></div>
      <div><label>成本（原幣）</label><input id="eCostForeign" type="number" step="0.01" min="0"/></div>
      <div><label>台幣成本</label><input id="eCostNt" type="number" step="1" min="0"/></div>
      <div style="grid-column:1 / -1">
        <label>圖片（可追加替換）</label>
        <div class="uploader">
          <input type="file" id="eImgFiles" accept="image/*" multiple/>
          <div class="previews" id="eImgPreviews"></div>
          <div class="small muted">保留既有圖片；新增的會追加。要完全替換可把「保留既有」勾關掉。</div>
          <label class="small"><input type="checkbox" id="eKeepOld" checked/> 保留既有</label>
        </div>
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button class="btn" id="btnEditSave">儲存</button>
      <button class="btn ghost" id="btnEditCancel">關閉</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ==== Supabase 基本設定 ==== */
const supabaseUrl='https://llbpmqyjigovxixeohzr.supabase.co';
const supabaseKey='sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
const BUCKET='yuyu.f86';
const sb=supabase.createClient(supabaseUrl,supabaseKey);

/* ==== Tabs ==== */
document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none');
    document.getElementById('tab-'+btn.dataset.tab).style.display='block';
  };
});

/* ==== Helpers ==== */
function publicUrlFromPath(path){ if(!path) return ''; const { data }=sb.storage.from(BUCKET).getPublicUrl(path); return data?.publicUrl||''; }
let RATES={JPY:0.22, KRW:0.024, USD:32.0};
let runsCache=[], poolRuns=[], normalRuns=[];

/* ==== Rates ==== */
async function loadRates(){
  const keys=['rate_JPY','rate_KRW','rate_USD'];
  const { data }=await sb.from('site_meta').select('key,value').in('key', keys);
  (data||[]).forEach(kv=>{
    if(kv.key==='rate_JPY') RATES.JPY = Number(kv.value)||RATES.JPY;
    if(kv.key==='rate_KRW') RATES.KRW = Number(kv.value)||RATES.KRW;
    if(kv.key==='rate_USD') RATES.USD = Number(kv.value)||RATES.USD;
  });
  rateJPY.value=RATES.JPY; rateKRW.value=RATES.KRW; rateUSD.value=RATES.USD;
  document.getElementById('rateTip').textContent=`JPY=${RATES.JPY}，KRW=${RATES.KRW}，USD=${RATES.USD}`;
}
btnSaveRates.onclick=async()=>{
  const rows=[
    {key:'rate_JPY', value:String(rateJPY.value||RATES.JPY)},
    {key:'rate_KRW', value:String(rateKRW.value||RATES.KRW)},
    {key:'rate_USD', value:String(rateUSD.value||RATES.USD)},
  ];
  for(const r of rows){ await sb.from('site_meta').upsert(r,{onConflict:'key'}); }
  await loadRates(); alert('已儲存匯率');
};

/* 成本自算（新增/編輯） */
['pCostCurrency','pCostForeign'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    const cur=pCostCurrency.value, amt=Number(pCostForeign.value||0);
    let nt=null;
    if(cur==='TWD') nt=amt; else if(cur==='JPY') nt=amt*RATES.JPY; else if(cur==='KRW') nt=amt*RATES.KRW; else if(cur==='USD') nt=amt*RATES.USD;
    pCostNt.value = nt? Math.round(nt) : '';
  });
});
['eCostCurrency','eCostForeign'].forEach(id=>{
  document.getElementById(id).addEventListener('input',()=>{
    const cur=eCostCurrency.value, amt=Number(eCostForeign.value||0);
    let nt=null;
    if(cur==='TWD') nt=amt; else if(cur==='JPY') nt=amt*RATES.JPY; else if(cur==='KRW') nt=amt*RATES.KRW; else if(cur==='USD') nt=amt*RATES.USD;
    eCostNt.value = nt? Math.round(nt) : '';
  });
});

/* ==== Runs ==== */
function runLabel(r){
  const d1=r.start_date? String(r.start_date):'';
  const d2=r.end_date? String(r.end_date):'';
  const date = (d1||d2)? `${d1}${d2?(' ~ '+d2):''}` : '';
  return (r.title||r.code||r.region||('Run#'+r.id)) + (date? `（${date}）`: '');
}
async function loadRuns(){
  const { data }=await sb.from('runs').select('*').order('created_at',{ascending:false});
  runsCache=data||[];
  poolRuns=runsCache.filter(r=>r.is_pool);
  normalRuns=runsCache.filter(r=>!r.is_pool);

  // Products 頁面的 run 下拉
  pRunAssign.innerHTML='<option value="">— 選擇連線 —</option>';
  eRunAssign.innerHTML='<option value="">— 選擇連線 —</option>';
  prodFilterRun.innerHTML='<option value="">全部商品</option>';
  runsCache.forEach(r=>{
    const v=JSON.stringify({id:r.id,title:r.title||''});
    pRunAssign.appendChild(new Option(runLabel(r), v));
    eRunAssign.appendChild(new Option(runLabel(r), v));
    prodFilterRun.appendChild(new Option(runLabel(r), r.id));
  });

  // Runs tab 列表
  await renderRunsTable();

  // Pool tab 下拉
  poolSelect.innerHTML='<option value="">— 選擇 Pool —</option>';
  poolRuns.forEach(r=> poolSelect.appendChild(new Option(runLabel(r), r.id)));
  poolTarget.innerHTML='<option value="">— 選擇目標連線 —</option>';
  normalRuns.forEach(r=> poolTarget.appendChild(new Option(runLabel(r), r.id)));

  // Bulk
  bulkFrom.innerHTML='<option value="">— 選擇來源 —</option>';
  bulkTo.innerHTML='<option value="">— 選擇目標 —</option>';
  runsCache.forEach(r=>{
    bulkFrom.appendChild(new Option(runLabel(r), r.id));
    bulkTo.appendChild(new Option(runLabel(r), r.id));
  });

  // Wishes 篩選連線
  wishRunFilter.innerHTML='<option value="">全部</option>';
  runsCache.forEach(r=> wishRunFilter.appendChild(new Option(runLabel(r), r.id)));
}
pRunAssign.addEventListener('change', e=>{ try{ const o=JSON.parse(e.target.value||''); if(o.title) pEta.value=o.title; }catch(_){ } });
eRunAssign.addEventListener('change', e=>{ try{ const o=JSON.parse(e.target.value||''); if(o.title) eEta.value=o.title; }catch(_){ } });

async function renderRunsTable(){
  const tb=runsTable.querySelector('tbody'); tb.innerHTML='';
  runsCache.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.title||''}</td>
      <td>${r.region||''}</td>
      <td>${r.start_date||''} ~ ${r.end_date||''}</td>
      <td>${r.ship_start_date||''}</td>
      <td>${r.note||''}</td>
      <td>${r.is_active? '啟用':'停用'}</td>
      <td>${r.is_featured? '✔':''}</td>
      <td>${r.is_pool? '✔':''}</td>
      <td>
        <button class="btn ghost" onclick='editRun("${r.id}")'>編輯</button>
        <button class="btn ghost" onclick='deleteRun("${r.id}")'>刪除</button>
      </td>`;
    tb.appendChild(tr);
  });
}
window.editRun=async(id)=>{
  const r=runsCache.find(x=>x.id===id); if(!r) return;
  rTitle.value=r.title||''; rCode.value=r.code||''; rRegion.value=r.region||'';
  rStart.value=r.start_date||''; rEnd.value=r.end_date||''; rShip.value=r.ship_start_date||'';
  rNote.value=r.note||''; rActive.value=String(!!r.is_active); rFeatured.value=String(!!r.is_featured);
  rIsPool.value=String(!!r.is_pool);
  rTitle.dataset.editId=id;
};
window.deleteRun=async(id)=>{
  if(!confirm('確定刪除此連線？（會連同對應關聯移除）')) return;
  const { error }=await sb.from('runs').delete().eq('id',id);
  if(error){ alert('刪除失敗：'+error.message); return; }
  await loadRuns(); alert('已刪除');
};
btnRunCreate.onclick=async()=>{
  const payload={
    title:(rTitle.value||'').trim(),
    code:(rCode.value||'').trim()||null,
    region:(rRegion.value||'').trim()||null,
    start_date:rStart.value||null,
    end_date:rEnd.value||null,
    ship_start_date:rShip.value||null,
    note:(rNote.value||'').trim()||null,
    is_active:(rActive.value==='true'),
    is_featured:(rFeatured.value==='true'),
    is_pool:(rIsPool.value==='true'),
  };
  if(!payload.title){ alert('請輸入標題'); return; }
  const editId=rTitle.dataset.editId||null;
  if(editId){
    const { error }=await sb.from('runs').update(payload).eq('id',editId);
    if(error){ alert('更新失敗：'+error.message); return; }
    delete rTitle.dataset.editId;
  }else{
    const { error }=await sb.from('runs').insert(payload);
    if(error){ alert('新增失敗：'+error.message); return; }
  }
  btnRunReset.click(); await loadRuns(); alert('已儲存');
};
btnRunReset.onclick=()=>{ [rTitle,rCode,rRegion,rStart,rEnd,rShip,rNote].forEach(i=>i.value=''); rActive.value='true'; rFeatured.value='false'; rIsPool.value='false'; delete rTitle.dataset.editId; };

/* ==== Category datalist ==== */
async function fillCategoryDatalist(){
  const { data }=await sb.from('products').select('category').not('category','is',null);
  const set=new Set((data||[]).map(x=>x.category).filter(Boolean));
  categoryList.innerHTML=''; Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hant')).forEach(c=>categoryList.appendChild(new Option('',c)));
}

/* ==== Auto product_id ==== */
async function genNextPid(){
  const d=new Date(), prefix=`P${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-`;
  const { data } = await sb.from('products').select('product_id').ilike('product_id', `${prefix}%`).order('product_id',{ascending:false}).limit(1);
  let seq=1; if(data&&data[0]?.product_id){ const n=parseInt(String(data[0].product_id).split('-').pop().replace(/\D/g,''),10); if(!isNaN(n)) seq=n+1; }
  return prefix+String(seq).padStart(3,'0');
}
function parseTags(s){ const raw=(s||'').trim(); return raw? raw.split(',').map(x=>x.trim()).filter(Boolean):null; }

/* ==== Upload helpers ==== */
const addFilesState=[]; const editFilesState=[];
function renderPreviews(box, state){
  box.innerHTML=''; state.forEach((f,idx)=>{ const div=document.createElement('div'); div.className='preview';
    const img=document.createElement('img'); img.src=f.url; div.appendChild(img);
    const x=document.createElement('button'); x.textContent='刪除'; x.onclick=()=>{ state.splice(idx,1); renderPreviews(box,state); };
    div.appendChild(x); box.appendChild(div);
  });
}
imgFiles.addEventListener('change',e=>{
  Array.from(e.target.files||[]).forEach(file=> addFilesState.push({file, url:URL.createObjectURL(file), uploadedPath:null}));
  renderPreviews(imgPreviews, addFilesState);
});
eImgFiles.addEventListener('change',e=>{
  Array.from(e.target.files||[]).forEach(file=> editFilesState.push({file, url:URL.createObjectURL(file), uploadedPath:null}));
  renderPreviews(eImgPreviews, editFilesState);
});
async function uploadAll(state, baseFolder){
  const out=[];
  for(const item of state){
    if(item.uploadedPath){ out.push(item.uploadedPath); continue; }
    const name=`${Date.now()}_${Math.random().toString(36).slice(2,8)}_${item.file.name}`;
    const path=`${baseFolder}/${name}`.replace(/\/+/g,'/');
    const { error }=await sb.storage.from(BUCKET).upload(path, item.file, { upsert:false, cacheControl:'3600' });
    if(!error){ item.uploadedPath=path; out.push(path); }
  }
  return out;
}

/* ==== Create Product ==== */
btnCreateProduct.onclick=async()=>{
  let pid=(pPid.value||'').trim(); if(!pid) pid=await genNextPid();
  let runObj=null; try{ runObj=JSON.parse(pRunAssign.value||''); }catch(_){}
  const eta=(pEta.value||'').trim() || (runObj?.title||null);

  const date=new Date(), ym=`${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}`;
  const uploaded=await uploadAll(addFilesState, `uploads/${ym}`);
  const img_url=uploaded[0]||null, imagesText=uploaded.slice(1).join('\n');

  const payload={
    name:(pName.value||'').trim(), price:pPrice.value?Number(pPrice.value):null,
    category:(pCategory.value||'').trim()||null, product_id:pid, status:(pStatus.value||'').trim()||null,
    arrival_time:(pArrival.value||'')||null, eta_text:eta, note:(pNote.value||'').trim()||null,
    description:(pDesc.value||'').trim()||null,
    img_url, images:imagesText,
    cost_jpy:(pCostCurrency.value==='JPY'? Number(pCostForeign.value||0): null),
    cost_nt: pCostNt.value? Number(pCostNt.value): null,
    tags: parseTags(pTags.value)
  };
  if(!payload.name){ alert('請輸入商品名稱'); return; }
  const { data, error }=await sb.from('products').insert(payload).select(); if(error){ alert('新增失敗：'+error.message); return; }
  const product=data?.[0];
  if(runObj?.id && product?.id){ await sb.from('product_runs').upsert({product_id:product.id, run_id:runObj.id},{onConflict:'product_id,run_id'}); }
  addFilesState.length=0; renderPreviews(imgPreviews, addFilesState);
  ['pName','pPrice','pCategory','pPid','pStatus','pArrival','pEta','pNote','pDesc','pTags','pCostForeign','pCostNt'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
  alert('新增成功'); await fillCategoryDatalist(); await loadProducts();
};

/* ==== Table & Edit & Delete ==== */
function nt(price,cost){ if(price==null||cost==null) return '—'; return Math.round(Number(price)-Number(cost)); }
async function loadProducts(runFilterId=null){
  let q=sb.from('products').select('id,name,price,category,product_id,eta_text,cost_jpy,cost_nt,img_url,images').order('created_at',{ascending:false}).limit(50);
  if(runFilterId){
    const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',runFilterId);
    const ids=(pr||[]).map(x=>x.product_id); q = ids.length? q.in('id',ids) : q.in('id',['00000000-0000-0000-0000-000000000000']);
  }
  const { data, error }=await q; if(error){ console.error(error); return; }
  const tb=productsTable.querySelector('tbody'); tb.innerHTML='';
  (data||[]).forEach(p=>{
    const costNT=(p.cost_nt!=null)?Number(p.cost_nt):(p.cost_jpy!=null?Number(p.cost_jpy)*RATES.JPY:null);
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td>${p.name||''}</td><td>${p.price??''}</td><td>${p.category||''}</td>
      <td>${p.product_id||''}</td><td>${p.eta_text||''}</td>
      <td>${costNT!=null?Math.round(costNT):'—'}</td><td>${nt(p.price,costNT)}</td>
      <td style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn ghost" onclick="openEdit('${p.id}')">編輯</button>
        <button class="btn ghost" onclick="copyPublicImages('${(p.img_url||'')}', \`${(p.images||'').replace(/`/g,'\\`')}\`)">複製圖片連結</button>
        <button class="btn ghost" onclick="deleteProduct('${p.id}')">刪除</button>
      </td>`;
    tb.appendChild(tr);
  });
}
prodFilterRun.addEventListener('change',e=> loadProducts(e.target.value||null));
function copyPublicImages(main, others){
  const arr=[main, ...others.split(/\n+/).filter(Boolean)].filter(Boolean).map(publicUrlFromPath);
  navigator.clipboard.writeText(arr.join('\n')); alert('已複製圖片 URL（公開）');
}
window.deleteProduct=async(id)=>{
  if(!confirm('確定刪除此商品？（會連同對應關聯移除）')) return;
  const { error }=await sb.from('products').delete().eq('id',id);
  if(error){ alert('刪除失敗：'+error.message); return; }
  await loadProducts(prodFilterRun.value||null); alert('已刪除');
};

/* ==== Edit modal ==== */
const editModal=document.getElementById('editModal'); editModal.querySelector('.overlay').onclick=()=> editModal.style.display='none';
document.getElementById('btnEditCancel').onclick=()=> editModal.style.display='none';
let editing=null, keepOld=true, oldMain=null, oldImages=[];
async function openEdit(id){
  const { data }=await sb.from('products').select('*').eq('id',id).maybeSingle();
  if(!data){ alert('讀取失敗'); return; }
  editing=data;
  const { data:pr }=await sb.from('product_runs').select('run_id').eq('product_id',id).limit(1);
  const runId=pr?.[0]?.run_id||null;

  eName.value=data.name||''; ePrice.value=data.price??''; eCategory.value=data.category||''; ePid.value=data.product_id||'';
  eStatus.value=data.status||''; eArrival.value=data.arrival_time||''; eEta.value=data.eta_text||''; eNote.value=data.note||'';
  eDesc.value=data.description||''; eTags.value=(Array.isArray(data.tags)? data.tags.join(','): (data.tags||'')); eCostNt.value=data.cost_nt??'';
  if(data.cost_jpy!=null){ eCostCurrency.value='JPY'; eCostForeign.value=data.cost_jpy; }
  else { eCostCurrency.value='TWD'; eCostForeign.value=''; }

  eRunAssign.value='';
  if(runId){ const v=JSON.stringify({id:runId,title:(runsCache.find(r=>r.id===runId)?.title||'')}); Array.from(eRunAssign.options).forEach(o=>{ if(o.value===v) eRunAssign.value=v; }); }

  oldMain=data.img_url||null; oldImages=(data.images||'').split(/\n+/).filter(Boolean);
  eKeepOld.checked=true; keepOld=true; editFilesState.length=0; renderPreviews(eImgPreviews, editFilesState);

  editModal.style.display='block';
}
document.getElementById('eKeepOld').onchange=(e)=> keepOld=e.target.checked;

btnEditSave.onclick=async()=>{
  if(!editing) return;
  const d=new Date(), ym=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
  const uploaded=await uploadAll(editFilesState, `uploads/${ym}`);
  let main=oldMain, imgs=[...oldImages];
  if(!keepOld){ main=null; imgs=[]; }
  if(uploaded.length){
    if(!main) main=uploaded[0];
    imgs.push(...uploaded.slice(main?0:1));
  }

  let runObj=null; try{ runObj=JSON.parse(eRunAssign.value||''); }catch(_){}
  const eta=(eEta.value||'').trim() || (runObj?.title||null);

  const payload={
    name:eName.value||null, price:ePrice.value?Number(ePrice.value):null,
    category:eCategory.value||null, product_id:ePid.value||null, status:eStatus.value||null,
    arrival_time:eArrival.value||null, eta_text:eta, note:eNote.value||null,
    description:eDesc.value||null,
    img_url:main||null, images:imgs.join('\n'), cost_nt:eCostNt.value?Number(eCostNt.value):null,
    cost_jpy:(eCostCurrency.value==='JPY'? (eCostForeign.value?Number(eCostForeign.value):null) : null),
    tags: parseTags(eTags.value)
  };
  const { error }=await sb.from('products').update(payload).eq('id',editing.id);
  if(error){ alert('儲存失敗：'+error.message); return; }

  // 更新 run 對應
  await sb.from('product_runs').delete().match({product_id:editing.id});
  if(runObj?.id){ await sb.from('product_runs').upsert({product_id:editing.id, run_id:runObj.id},{onConflict:'product_id,run_id'}); }

  alert('已更新'); editModal.style.display='none'; await fillCategoryDatalist(); await loadProducts(prodFilterRun.value||null);
};

/* ==== Pool 派送 ==== */
let poolCheckedAll=false;
poolSelect.addEventListener('change', loadPoolProducts);
poolSelectAll.onclick=()=>{
  poolCheckedAll=!poolCheckedAll;
  document.querySelectorAll('.poolItemChk').forEach(c=> c.checked=poolCheckedAll);
};
async function loadPoolProducts(){
  const poolId=poolSelect.value||null;
  const box=document.getElementById('poolList'); box.innerHTML='';
  if(!poolId) return;
  const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',poolId);
  const ids=(pr||[]).map(x=>x.product_id);
  if(!ids.length){ box.innerHTML='<div class="muted">此 Pool 目前沒有商品</div>'; return; }
  const { data:ps }=await sb.from('products').select('id,name,price,category,img_url,images').in('id',ids).order('created_at',{ascending:false});
  (ps||[]).forEach(p=>{
    const div=document.createElement('div'); div.className='card';
    const thumb=p.img_url? publicUrlFromPath(p.img_url):'';
    div.innerHTML=`
      <label style="display:flex;gap:8px;align-items:flex-start">
        <input type="checkbox" class="poolItemChk" value="${p.id}">
        <div style="flex:1">
          <div style="display:flex;gap:8px;align-items:center">
            ${thumb? `<img src="${thumb}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid var(--border)">`:''}
            <div>
              <div><strong>${p.name||''}</strong></div>
              <div class="muted">${p.category||''}　NT$${p.price??''}</div>
            </div>
          </div>
        </div>
      </label>`;
    box.appendChild(div);
  });
}
poolCopy.onclick=async()=>{
  const poolId=poolSelect.value||''; const targetId=poolTarget.value||'';
  if(!poolId||!targetId){ alert('請選 Pool 與目標連線'); return; }
  const ids=[...document.querySelectorAll('.poolItemChk:checked')].map(c=>c.value);
  if(!ids.length){ alert('請先勾選要複製的商品'); return; }
  const rows=ids.map(pid=>({product_id:pid, run_id:targetId}));
  const { error }=await sb.from('product_runs').upsert(rows,{onConflict:'product_id,run_id'});
  if(error){ alert('複製失敗：'+error.message); return; }
  alert(`已複製 ${ids.length} 件到目標連線`);
};

/* ==== Bulk（複製） ==== */
let bulkPreviewCount=0;
bulkPreview.onclick=async()=>{
  const from=bulkFrom.value||''; const to=bulkTo.value||''; const scope=bulkScope.value;
  if(!from||!to){ alert('請選來源與目標'); return; }
  let ids=[];
  const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',from);
  ids=(pr||[]).map(x=>x.product_id);
  bulkPreviewCount=ids.length;
  bulkInfo.textContent=`預計複製 ${bulkPreviewCount} 件。`;
};
bulkDo.onclick=async()=>{
  const to=bulkTo.value||''; if(!bulkPreviewCount||!to){ alert('請先預覽'); return; }
  const from=bulkFrom.value||''; const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',from);
  const ids=(pr||[]).map(x=>x.product_id);
  const rows=ids.map(pid=>({product_id:pid, run_id:to}));
  const { error }=await sb.from('product_runs').upsert(rows,{onConflict:'product_id,run_id'});
  if(error){ alert('執行失敗：'+error.message); return; }
  alert(`已複製 ${ids.length} 件到目標連線`); bulkInfo.textContent='';
};

/* ==== Wishes ==== */
wishStatusFilter.addEventListener('change', loadWishes);
wishRunFilter.addEventListener('change', loadWishes);

async function loadWishes(){
  let q=sb.from('wishes')
    .select('id,created_at,run_id,category,product_name,product_url,content,image_path,status')
    .order('created_at',{ascending:false});
  const st=wishStatusFilter.value||''; if(st) q=q.eq('status', st);
  const rid=wishRunFilter.value||''; if(rid) q=q.eq('run_id', rid);
  const { data, error }=await q;
  const tb=wishesTable.querySelector('tbody'); tb.innerHTML='';
  if(error){ console.error(error); return; }
  (data||[]).forEach(w=>{
    const run = runsCache.find(r=>r.id===w.run_id);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="small muted">${new Date(w.created_at).toLocaleString('zh-TW')}</td>
      <td>${run? runLabel(run):''}</td>
      <td>${w.category||''}</td>
      <td>${w.product_name||''}</td>
      <td>${w.product_url? `<a href="${w.product_url}" target="_blank">連結</a>`:''}</td>
      <td>${w.content||''}</td>
      <td>${w.image_path? `<a href="${publicUrlFromPath(w.image_path)}" target="_blank">圖片</a>`:''}</td>
      <td>
        <select data-id="${w.id}" class="wish-status">
          ${['pending','approved','rejected'].map(s=>`<option ${w.status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td>
        <button class="btn ghost" onclick="openReply('${w.id}')">回覆</button>
        <button class="btn ghost" onclick="deleteWish('${w.id}')">刪除</button>
      </td>`;
    tb.appendChild(tr);
  });
  // 綁定狀態更新
  document.querySelectorAll('.wish-status').forEach(sel=>{
    sel.onchange=async(e)=>{
      const id=e.target.getAttribute('data-id'); const st=e.target.value;
      await sb.from('wishes').update({status:st}).eq('id',id);
    };
  });
}
window.deleteWish=async(id)=>{
  if(!confirm('刪除此許願單？')) return;
  const { error }=await sb.from('wishes').delete().eq('id',id);
  if(error){ alert('刪除失敗：'+error.message); return; }
  await loadWishes();
};
window.openReply=async(id)=>{
  const text=prompt('輸入回覆內容'); if(!text) return;
  await sb.from('wish_replies').insert({wish_id:id, reply_text:text});
  alert('已回覆');
};

/* ==== init ==== */
document.querySelectorAll('.tabbtn').forEach((b,i)=>{ if(i===0) b.click(); });
(async function init(){
  await loadRates(); await loadRuns(); await fillCategoryDatalist(); await loadProducts(); await loadWishes();
})();
</script>
</body>
</html>
