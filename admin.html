<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>後台｜連線與商品管理</title>
<style>
  :root{
    --bg:#f7f3ef; --paper:#fffdf9; --card:#ffffff; --ink:#2b2b2b; --muted:#7a7267;
    --brand:#8B5E34; --border:#eadfcd; --shadow:0 10px 28px rgba(139,94,52,.08); --r:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#f8f5f1 0%, var(--bg) 100%);color:var(--ink);
       font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial;}
  header{position:sticky;top:0;background:rgba(247,243,239,.8);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
  .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
  h1{margin:0;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,textarea,button{font:inherit}
  input,select,textarea{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fffdfa}
  button{padding:10px 14px;border:none;border-radius:10px;background:var(--brand);color:#fff;cursor:pointer}
  button.ghost{background:#f3ede4;color:#2b2b2b}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left}
  .muted{color:var(--muted)}
  .badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px}
  .actions{display:flex;gap:6px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <h1>後台｜連線與商品管理</h1>
    <div class="muted">Supabase</div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- 連線管理 -->
    <section class="card">
      <h2 style="margin:0 0 8px">連線管理</h2>
      <div class="row" style="margin-bottom:8px">
        <select id="region">
          <option value="JP">日本 JP</option>
          <option value="KR">韓國 KR</option>
          <option value="TW">台灣 TW</option>
          <option value="OTHER">其他</option>
        </select>
        <input id="title" placeholder="標題（例：日本 9/6–9/7）" style="flex:1" />
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="start" type="date" />
        <input id="end" type="date" />
        <input id="code" placeholder="代碼（可留空自動）" />
        <button id="btnCreateRun">新增連線</button>
      </div>

      <h3 style="margin:10px 0 6px">所有連線</h3>
      <table>
        <thead>
          <tr><th>標題</th><th>區域</th><th>日期</th><th>狀態</th><th>首頁</th><th>動作</th></tr>
        </thead>
        <tbody id="runsTbody"></tbody>
      </table>
    </section>

    <!-- 批次搬家 -->
    <section class="card">
      <h2 style="margin:0 0 8px">批次搬到另一個連線</h2>
      <div class="row" style="margin-bottom:8px">
        <input id="pSearch" placeholder="搜尋商品名稱/關鍵字…" style="flex:1" />
        <button class="ghost" id="btnSelectAll">全選</button>
        <button class="ghost" id="btnSelectNone">全不選</button>
        <button class="ghost" id="btnSelectInvert">反選</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <select id="targetRun"></select>
        <button id="btnMove">搬家（取代）</button>
        <button class="ghost" id="btnAdd">加入（合併）</button>
        <span class="muted" id="selCount">已選 0 項</span>
      </div>
      <div style="max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:10px">
        <table>
          <thead>
            <tr><th style="width:36px"></th><th>名稱</th><th>分類</th><th>價格</th><th class="muted">目前連線</th></tr>
          </thead>
          <tbody id="productsTbody"></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- 首頁公告 -->
  <section class="card" style="margin-top:16px">
    <h2 style="margin:0 0 8px">首頁公告</h2>
    <textarea id="homeNotice" rows="3" style="width:100%;"></textarea>
    <div class="row" style="margin-top:8px">
      <button id="btnSaveNotice">儲存公告</button>
      <span id="noticeSaved" class="muted"></span>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = 'https://llbpmqyjigovxixeohzr.supabase.co';
const supabaseKey = 'sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let runs = [];
let products = [];
let prodRunMap = new Map(); // product_id -> [run titles]
let selectedIds = new Set();

/* ===== Runs ===== */
async function loadRuns(){
  const { data, error } = await supabaseClient
    .from('runs')
    .select('id, code, title, region, start_date, end_date, is_active, is_featured')
    .order('start_date', { ascending:false });
  if(error){ console.error(error); return; }
  runs = data || [];
  renderRuns();
  fillTargetRun();
}
function renderRuns(){
  const tb = document.getElementById('runsTbody'); tb.innerHTML = '';
  runs.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${r.title}</strong><div class="muted">${r.code||''}</div></td>
      <td>${r.region}</td>
      <td>${r.start_date||''} ~ ${r.end_date||''}</td>
      <td>
        <label class="badge"><input type="checkbox" ${r.is_active?'checked':''} data-act="${r.id}"> 啟用</label>
      </td>
      <td>
        <label class="badge"><input type="checkbox" ${r.is_featured?'checked':''} data-ft="${r.id}"> 首頁</label>
      </td>
      <td class="actions">
        <button class="ghost" data-del="${r.id}">刪除</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  // 綁定切換
  tb.querySelectorAll('input[data-act]').forEach(ch=>{
    ch.onchange = async () => {
      const id = ch.getAttribute('data-act');
      await supabaseClient.from('runs').update({ is_active: ch.checked }).eq('id', id);
      await loadRuns(); // 重新整理列表 & 供右側下拉
    };
  });
  tb.querySelectorAll('input[data-ft]').forEach(ch=>{
    ch.onchange = async () => {
      const id = ch.getAttribute('data-ft');
      await supabaseClient.from('runs').update({ is_featured: ch.checked }).eq('id', id);
      await loadRuns();
    };
  });
  tb.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = async () => {
      if(!confirm('確定刪除此連線？（僅刪連線與關聯，不會刪商品）')) return;
      await supabaseClient.from('runs').delete().eq('id', btn.getAttribute('data-del'));
      await loadRuns();
      await refreshProductRunMap(); renderProducts();
    };
  });
}
function fillTargetRun(){
  const sel = document.getElementById('targetRun'); sel.innerHTML = '';
  runs.filter(r=>r.is_active).forEach(r=>{
    const opt = document.createElement('option');
    opt.value = r.id; opt.textContent = r.title || r.code || r.region;
    sel.appendChild(opt);
  });
}

document.getElementById('btnCreateRun').onclick = async ()=>{
  const region = document.getElementById('region').value;
  const title  = document.getElementById('title').value.trim();
  const start  = document.getElementById('start').value || null;
  const end    = document.getElementById('end').value || null;
  let code     = document.getElementById('code').value.trim();
  if(!title){ alert('請輸入標題'); return; }
  if(!code){
    const d = start || new Date().toISOString().slice(0,10).replace(/-/g,'');
    code = `${region}-${d}`;
  }
  const { error } = await supabaseClient.from('runs')
    .insert([{ region, title, start_date:start, end_date:end, code, is_active:true }]);
  if(error){ alert('新增失敗：'+error.message); return; }
  document.getElementById('title').value = '';
  document.getElementById('code').value = '';
  await loadRuns();
};

/* ===== Products & selections ===== */
async function loadProducts(){
  const { data, error } = await supabaseClient
    .from('products')
    .select('id, name, price, category')
    .order('created_at', { ascending:false });
  if(error){ console.error(error); return; }
  products = data || [];
  await refreshProductRunMap();
  renderProducts();
}
async function refreshProductRunMap(){
  prodRunMap = new Map();
  const ids = products.map(p=>p.id);
  if(ids.length === 0) return;
  const { data, error } = await supabaseClient
    .from('product_runs')
    .select('product_id, run_id');
  if(error){ console.error(error); return; }
  const mapRunTitle = new Map(runs.map(r=>[r.id, r.title || r.code || r.region]));
  (data||[]).forEach(pr=>{
    const arr = prodRunMap.get(pr.product_id) || [];
    arr.push(mapRunTitle.get(pr.run_id) || pr.run_id);
    prodRunMap.set(pr.product_id, arr);
  });
}
function renderProducts(){
  const q = (document.getElementById('pSearch').value||'').toLowerCase();
  const tb = document.getElementById('productsTbody'); tb.innerHTML='';
  const list = products.filter(p=>{
    return !q || `${p.name||''} ${p.category||''}`.toLowerCase().includes(q);
  });
  list.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" data-id="${p.id}" ${selectedIds.has(p.id)?'checked':''}></td>
      <td>${p.name||''}</td>
      <td>${p.category||''}</td>
      <td>${p.price||''}</td>
      <td class="muted">${(prodRunMap.get(p.id)||[]).join('、')}</td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
    ch.onchange = ()=>{ 
      const id = ch.getAttribute('data-id');
      if(ch.checked) selectedIds.add(id); else selectedIds.delete(id);
      updateSelCount();
    };
  });
  updateSelCount();
}
function updateSelCount(){
  document.getElementById('selCount').textContent = `已選 ${selectedIds.size} 項`;
}
document.getElementById('pSearch').oninput = ()=> renderProducts();
document.getElementById('btnSelectAll').onclick = ()=>{
  products.forEach(p=>selectedIds.add(p.id)); renderProducts();
};
document.getElementById('btnSelectNone').onclick = ()=>{ selectedIds.clear(); renderProducts(); };
document.getElementById('btnSelectInvert').onclick = ()=>{
  const now = new Set(selectedIds);
  products.forEach(p=>{ if(now.has(p.id)) selectedIds.delete(p.id); else selectedIds.add(p.id); });
  renderProducts();
};

/* ===== Bulk actions ===== */
async function bulkAdd(runId, ids){
  if(!ids.length) return;
  const rows = ids.map(pid=>({ product_id: pid, run_id: runId }));
  const { error } = await supabaseClient.from('product_runs')
    .upsert(rows, { onConflict: 'product_id,run_id' });
  if(error) throw error;
}
async function bulkMove(runId, ids){
  // 先刪全部既有關聯，再指派到 runId
  if(ids.length){
    const { error: delErr } = await supabaseClient.from('product_runs')
      .delete().in('product_id', ids);
    if(delErr) throw delErr;
    await bulkAdd(runId, ids);
  }
}
document.getElementById('btnAdd').onclick = async ()=>{
  const runId = document.getElementById('targetRun').value;
  const ids = Array.from(selectedIds);
  if(!runId){ alert('請選擇目標連線'); return; }
  if(ids.length===0){ alert('請先勾選商品'); return; }
  try{
    await bulkAdd(runId, ids);
    alert('已加入（合併）至目標連線');
    await refreshProductRunMap(); renderProducts();
  }catch(e){ alert('加入失敗：'+e.message); }
};
document.getElementById('btnMove').onclick = async ()=>{
  const runId = document.getElementById('targetRun').value;
  const ids = Array.from(selectedIds);
  if(!runId){ alert('請選擇目標連線'); return; }
  if(ids.length===0){ alert('請先勾選商品'); return; }
  if(!confirm(`將 ${ids.length} 項商品搬家到選定連線（取代原關聯）？`)) return;
  try{
    await bulkMove(runId, ids);
    alert('已搬家（取代）');
    await refreshProductRunMap(); renderProducts();
  }catch(e){ alert('搬家失敗：'+e.message); }
};

/* ===== Home notice ===== */
async function loadNotice(){
  const { data } = await supabaseClient.from('site_meta').select('value').eq('key','home_notice').maybeSingle();
  document.getElementById('homeNotice').value = data?.value || '';
}
document.getElementById('btnSaveNotice').onclick = async ()=>{
  const val = document.getElementById('homeNotice').value;
  const { error } = await supabaseClient.from('site_meta')
    .upsert({ key:'home_notice', value: val, updated_at: new Date().toISOString() });
  const msg = document.getElementById('noticeSaved');
  if(error){ msg.textContent = '儲存失敗：' + error.message; return; }
  msg.textContent = '已儲存';
  setTimeout(()=> msg.textContent='', 1200);
};

/* ===== Init ===== */
(async function init(){
  await loadRuns();
  await loadProducts();
  await loadNotice();
})();
</script>
</body>
</html>
