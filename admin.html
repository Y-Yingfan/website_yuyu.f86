<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>ç”¢å“ç®¡ç†å¾Œå°</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    form { margin-bottom: 20px; }
    form > div { margin-bottom: 8px; }
    label { display: inline-block; width: 120px; font-weight: bold; }
    input[type="text"], input[type="number"], textarea { width: 300px; }
    textarea { height: 60px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>ç”¢å“ç®¡ç†</h1>
  <!-- ç”¢å“è¼¸å…¥è¡¨å–® -->
  <form id="product-form">
    <!-- éš±è—æ¬„ä½ï¼šç”¢å“IDï¼ˆç”¨æ–¼ç·¨è¼¯æ¨¡å¼ï¼‰ -->
    <input type="hidden" name="id" id="prod-id" />
    <div>
      <label for="prod-name">åç¨±ï¼š</label>
      <input type="text" id="prod-name" name="name" required />
    </div>
    <div>
      <label for="prod-product_id">å•†å“ç·¨è™Ÿï¼š</label>
      <input type="text" id="prod-product_id" name="product_id" />
    </div>
    <div>
      <label for="prod-category">åˆ†é¡ï¼š</label>
      <input type="text" id="prod-category" name="category" />
    </div>
    <div>
      <label for="prod-price">åƒ¹æ ¼ï¼š</label>
      <input type="number" id="prod-price" name="price" step="any" />
    </div>
    <div>
      <label for="prod-cost_jpy">æˆæœ¬(æ—¥å¹£)ï¼š</label>
      <input type="number" id="prod-cost_jpy" name="cost_jpy" step="any" />
    </div>
    <div>
      <label for="prod-cost_nt">æˆæœ¬(å°å¹£)ï¼š</label>
      <input type="number" id="prod-cost_nt" name="cost_nt" step="any" />
    </div>
    <div>
      <label for="prod-status">ç‹€æ…‹ï¼š</label>
      <input type="text" id="prod-status" name="status" />
    </div>
    <div>
      <label for="prod-eta_text">é è¨ˆåˆ°è²¨(æ–‡å­—)ï¼š</label>
      <input type="text" id="prod-eta_text" name="eta_text" />
    </div>
    <div>
      <label for="prod-arrival_time">é è¨ˆåˆ°è²¨æ™‚é–“ï¼š</label>
      <input type="text" id="prod-arrival_time" name="arrival_time" />
    </div>
    <div>
      <label for="prod-img_url">ä¸»è¦åœ–ç‰‡URLï¼š</label>
      <input type="text" id="prod-img_url" name="img_url" />
    </div>
    <div>
      <label for="prod-images">å…¶å®ƒåœ–ç‰‡æ¸…å–®ï¼š</label><br/>
      <textarea id="prod-images" name="images" placeholder="æ¯è¡Œè¼¸å…¥ä¸€å€‹åœ–ç‰‡URL"></textarea>
    </div>
    <div>
      <label for="prod-tags">æ¨™ç±¤(tags)ï¼š</label>
      <input type="text" id="prod-tags" name="tags" placeholder="ä¾‹å¦‚: æ¨™ç±¤1, æ¨™ç±¤2, ..." />
    </div>
    <div>
      <label for="prod-note">å‚™è¨»ï¼š</label><br/>
      <textarea id="prod-note" name="note"></textarea>
    </div>
    <button type="submit" id="save-btn">ğŸ’¾ ä¿å­˜ç”¢å“</button>
    <button type="button" id="cancel-btn">æ¸…ç©ºè¡¨å–®</button>
  </form>

  <!-- ç¾æœ‰ç”¢å“åˆ—è¡¨ -->
  <table id="products-table">
    <thead>
      <tr>
        <th>åç¨±</th>
        <th>åˆ†é¡</th>
        <th>åƒ¹æ ¼</th>
        <th>ç‹€æ…‹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      <!-- å°‡ç”±è…³æœ¬å¡«å…¥è³‡æ–™ -->
    </tbody>
  </table>

  <script>
    // é¸å–è¡¨å–®åŠå„æ¬„ä½å…ƒç´ 
    const form = document.getElementById('product-form');
    const idField = document.getElementById('prod-id');
    const nameField = document.getElementById('prod-name');
    const productIdField = document.getElementById('prod-product_id');
    const categoryField = document.getElementById('prod-category');
    const priceField = document.getElementById('prod-price');
    const costJpyField = document.getElementById('prod-cost_jpy');
    const costNtField = document.getElementById('prod-cost_nt');
    const statusField = document.getElementById('prod-status');
    const etaField = document.getElementById('prod-eta_text');
    const arrivalField = document.getElementById('prod-arrival_time');
    const imgUrlField = document.getElementById('prod-img_url');
    const imagesField = document.getElementById('prod-images');
    const tagsField = document.getElementById('prod-tags');
    const noteField = document.getElementById('prod-note');
    const tableBody = document.querySelector('#products-table tbody');

    // é é¢è¼‰å…¥æ™‚å–å¾—ç¾æœ‰ç”¢å“åˆ—è¡¨ä¸¦é¡¯ç¤º
    async function loadProducts() {
      try {
        const res = await fetch('/products');
        if (!res.ok) throw new Error('Failed to load products');
        const products = await res.json();
        tableBody.innerHTML = '';
        products.forEach(product => {
          const tr = document.createElement('tr');
          tr.innerHTML = \`
            <td>\${product.name}</td>
            <td>\${product.category || ''}</td>
            <td>\${product.price != null ? product.price : ''}</td>
            <td>\${product.status || ''}</td>
            <td>
              <button data-id="\${product.id}" class="edit-btn">ç·¨è¼¯</button>
              <button data-id="\${product.id}" class="delete-btn">åˆªé™¤</button>
            </td>
          \`;
          tableBody.appendChild(tr);
        });
      } catch (err) {
        console.error('ç„¡æ³•è¼‰å…¥ç”¢å“åˆ—è¡¨ï¼š', err);
      }
    }

    // è¡¨å–®æäº¤äº‹ä»¶ï¼ˆæ–°å¢æˆ–æ›´æ–°ç”¢å“ï¼‰
    form.addEventListener('submit', async function(event) {
      event.preventDefault();
      const id = idField.value.trim();
      // æº–å‚™è¦é€å‡ºçš„ç”¢å“è³‡æ–™å°è±¡ï¼Œå¾è¡¨å–®æ¬„ä½è®€å–å€¼
      const productData = {
        name: nameField.value.trim(),
        product_id: productIdField.value.trim(),
        category: categoryField.value.trim(),
        price: priceField.value ? parseFloat(priceField.value) : null,
        cost_jpy: costJpyField.value ? parseFloat(costJpyField.value) : null,
        cost_nt: costNtField.value ? parseFloat(costNtField.value) : null,
        status: statusField.value.trim(),
        eta_text: etaField.value.trim(),
        arrival_time: arrivalField.value.trim(),
        img_url: imgUrlField.value.trim(),
        // å°‡å¤šè¡Œåœ–ç‰‡æ–‡æœ¬åˆ‡æˆé™£åˆ—ï¼›éæ¿¾æ‰ç©ºè¡Œ
        images: imagesField.value 
                 ? imagesField.value.split('\\n').map(line => line.trim()).filter(line => line) 
                 : [],
        // å°‡é€—è™Ÿåˆ†éš”çš„æ¨™ç±¤å­—ä¸²åˆ‡æˆé™£åˆ—ï¼›éæ¿¾ç©ºç™½
        tags: tagsField.value 
               ? tagsField.value.split(',').map(tag => tag.trim()).filter(tag => tag) 
               : [],
        note: noteField.value.trim()
      };
      // åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯æ›´æ–°
      let url = '/products';
      let method = 'POST';
      if (id) {
        // ç·¨è¼¯æ¨¡å¼ï¼Œå¸¶ä¸Šç”¢å“IDï¼Œä½¿ç”¨PUT
        url = \`/products/\${id}\`;
        method = 'PUT';
      }
      try {
        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData)
        });
        if (!res.ok) throw new Error('Save failed');
        // æ›´æ–°åˆ—è¡¨ä¸¦é‡ç½®è¡¨å–®
        await loadProducts();
        form.reset();
        idField.value = '';
      } catch (err) {
        console.error('ä¿å­˜ç”¢å“æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', err);
        alert('ç”¢å“ç„¡æ³•ä¿å­˜ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹ã€‚');
      }
    });

    // ä»£ç†ç›£è½åˆ—è¡¨ä¸­çš„æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼Œç”¨æ–¼ç·¨è¼¯æˆ–åˆªé™¤
    tableBody.addEventListener('click', function(event) {
      const target = event.target;
      if (target.classList.contains('edit-btn')) {
        // ç·¨è¼¯æŒ‰éˆ•ï¼šè¼‰å…¥è©²IDç”¢å“è³‡æ–™åˆ°è¡¨å–®
        const productId = target.getAttribute('data-id');
        fetch(\`/products/\${productId}\`)
          .then(res => res.json())
          .then(product => {
            // å°‡è¡¨å–®å¡«å…¥ç”¢å“ç¾æœ‰è³‡æ–™
            idField.value       = product.id || '';
            nameField.value     = product.name || '';
            productIdField.value= product.product_id || '';
            categoryField.value = product.category || '';
            priceField.value    = (product.price !== null && product.price !== undefined) ? product.price : '';
            costJpyField.value  = (product.cost_jpy !== null && product.cost_jpy !== undefined) ? product.cost_jpy : '';
            costNtField.value   = (product.cost_nt !== null && product.cost_nt !== undefined) ? product.cost_nt : '';
            statusField.value   = product.status || '';
            etaField.value      = product.eta_text || '';
            arrivalField.value  = product.arrival_time || '';
            imgUrlField.value   = product.img_url || '';
            // images æ¬„ä½å¯èƒ½ç‚ºå­—ä¸²ï¼ˆå¸¶æœ‰æ›è¡Œï¼‰æˆ–å·²è§£ææˆé™£åˆ—
            if (Array.isArray(product.images)) {
              imagesField.value = product.images.join('\\n');
            } else {
              imagesField.value = product.images || '';
            }
            // tags æ¬„ä½å¯èƒ½ç‚ºå·²è§£æçš„é™£åˆ—
            if (Array.isArray(product.tags)) {
              tagsField.value = product.tags.join(', ');
            } else {
              tagsField.value = product.tags || '';
            }
            noteField.value     = product.note || '';
            // æ²å‹•åˆ°è¡¨å–®ä½ç½®æ–¹ä¾¿ç·¨è¼¯
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
      } 
      else if (target.classList.contains('delete-btn')) {
        // åˆªé™¤æŒ‰éˆ•ï¼šè©¢å•ç¢ºèªå¾Œåˆªé™¤ç”¢å“
        const productId = target.getAttribute('data-id');
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™é …ç”¢å“å—ï¼Ÿ')) {
          fetch(\`/products/\${productId}\`, { method: 'DELETE' })
            .then(res => {
              if (!res.ok) {
                alert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹ã€‚');
              } else {
                loadProducts();
              }
            });
        }
      }
    });

    // æ¸…ç©ºè¡¨å–®æŒ‰éˆ•ï¼šé‡ç½®è¡¨å–®æ¬„ä½
    document.getElementById('cancel-btn').addEventListener('click', () => {
      form.reset();
      idField.value = '';
    });

    // åˆæ¬¡è¼‰å…¥é é¢æ™‚ï¼Œè¼‰å…¥ç”¢å“åˆ—è¡¨
    loadProducts();
  </script>
</body>
</html>
