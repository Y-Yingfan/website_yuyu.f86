<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>商品後台管理</title>
  <style>
    :root{--ink:#2f2f2f;--muted:#6b6a62;--line:#e6e2da;--bg:#f5f3ef;--panel:#fff;--accent:#c2a35d;--danger:#b42318}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    h1{margin:10px 0 16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.06);padding:14px;margin:10px 0}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:14px}
    input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border:none}
    .btn.danger{background:var(--danger);color:#fff;border:none}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .msg{margin-top:8px;font-size:14px}
    .ok{color:#157347}
    .err{color:#b42318}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>商品後台管理</h1>

    <!-- 連線狀態 -->
    <div id="connCard" class="card">
      <div id="connMsg" class="msg muted">正在檢查與 Supabase 的連線…</div>
    </div>

    <!-- 登入 / 註冊 -->
    <div id="authCard" class="card">
      <div class="toolbar">
        <strong>登入</strong>
        <button id="btnLogout" class="btn">登出</button>
      </div>
      <div class="row">
        <div>
          <label>電子信箱</label>
          <input id="email" placeholder="you@example.com" />
        </div>
        <div>
          <label>密碼（至少 8 碼）</label>
          <input id="password" type="password" placeholder="Password" />
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="btnLogin" class="btn primary">登入</button>
        <button id="btnSignup" class="btn">註冊（第一次使用）</button>
        <button id="btnResend" class="btn">重送驗證信</button>
      </div>
      <div class="msg muted" style="margin-top:8px">
        僅允許管理者 Email 登入：<b>lelouvre.yu@gmail.com</b>
      </div>
      <div id="authMsg" class="msg"></div>
      <details style="margin-top:10px">
        <summary>若「註冊沒反應」，怎麼辦？</summary>
        <ol>
          <li>同一信箱 60 秒內只能重送一次驗證信；請等 1 分鐘再按一次。</li>
          <li>到垃圾信匣找找，或按「重送驗證信」。</li>
          <li>確認 <b>Authentication → URL Configuration</b>：
            <ul>
              <li>Site URL：<code>https://y-yingfan.github.io/website_yuyu.f86/</code></li>
              <li>Redirect URLs 有：<code>https://y-yingfan.github.io/website_yuyu.f86/admin.html</code></li>
            </ul>
          </li>
        </ol>
      </details>
    </div>

    <!-- 管理區（登入後顯示） -->
    <div id="adminCard" class="card hide">
      <div class="toolbar">
        <strong>已登入</strong>
        <div class="muted" id="who"></div>
      </div>
      <div class="hr"></div>
      <div class="muted">（此頁主要解決 Email 驗證問題；登入成功後你就可以回到主後台頁面繼續上架。）</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ===== 你的設定（已填入你提供的值） =====
    const SUPABASE_URL  = 'https://llbpmqyjigovxixeohzr.supabase.co';
    const SUPABASE_KEY  = 'sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
    const ADMIN_EMAIL   = 'lelouvre.yu@gmail.com';
    const FRONTEND_REDIRECT = 'https://y-yingfan.github.io/website_yuyu.f86/admin.html'; // 驗證後導回
    const BUCKET = 'yuyu.f86';

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== UI refs =====
    const connMsg = document.getElementById('connMsg');
    const authMsg = document.getElementById('authMsg');
    const adminCard = document.getElementById('adminCard');
    const authCard  = document.getElementById('authCard');
    const who = document.getElementById('who');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const btnLogin = document.getElementById('btnLogin');
    const btnSignup = document.getElementById('btnSignup');
    const btnResend = document.getElementById('btnResend');
    const btnLogout = document.getElementById('btnLogout');

    // ===== 連線檢查（用 SDK + REST v2）=====
    (async function checkConn(){
      try{
        // 1) SDK 檢查：列空表（不影響資料）
        const { error: e1 } = await sb.from('products').select('id').limit(1);
        if(e1) throw e1;

        // 2) REST v2 檢查（帶 apikey）
        const ok = await fetch(`${SUPABASE_URL}/rest/v1/products?select=id&limit=1`, {
          headers: { apikey: SUPABASE_KEY, Authorization:`Bearer ${SUPABASE_KEY}` }
        });
        if(!ok.ok) throw new Error('REST v2 連線失敗');

        connMsg.textContent = '✅ 已連線 Supabase，開始載入介面。';
        connMsg.className = 'msg ok';
      }catch(err){
        connMsg.textContent = '❌ 無法連線 Supabase，請檢查 Project URL / Key。錯誤：' + (err?.message||err);
        connMsg.className = 'msg err';
      }
    })();

    // ===== 會話狀態 =====
    (async function boot(){
      const { data:{session} } = await sb.auth.getSession();
      renderAuth(session?.user||null);
    })();

    function renderAuth(user){
      if(user){
        who.textContent = user.email || '';
        adminCard.classList.remove('hide');
        authCard.classList.add('hide');
      }else{
        adminCard.classList.add('hide');
        authCard.classList.remove('hide');
      }
    }

    // ===== helpers =====
    function setAuthMsg(msg, ok=false){
      authMsg.textContent = msg||'';
      authMsg.className = 'msg ' + (ok ? 'ok' : 'err');
    }
    function mustAdminAddress(addr){
      return (addr||'').trim().toLowerCase() === ADMIN_EMAIL.toLowerCase();
    }

    // ===== actions =====
    btnLogin.onclick = async ()=>{
      setAuthMsg('');
      const addr = email.value.trim();
      const pass = password.value;
      if(!mustAdminAddress(addr)) return setAuthMsg('僅允許管理者 Email 登入', false);
      if(!addr || !pass) return setAuthMsg('請輸入 Email 與密碼', false);

      const { data, error } = await sb.auth.signInWithPassword({ email: addr, password: pass });
      if(error){
        const m = (''+error.message).toLowerCase();
        if(m.includes('email') && m.includes('not confirmed')) return setAuthMsg('帳號尚未驗證，請先到信箱點擊確認信。', false);
        return setAuthMsg('登入失敗：'+error.message, false);
      }
      renderAuth(data.user);
      setAuthMsg('登入成功', true);
    };

    btnSignup.onclick = async ()=>{
      setAuthMsg('');
      const addr = email.value.trim();
      const pass = password.value;
      if(!mustAdminAddress(addr)) return setAuthMsg('僅允許管理者 Email 註冊', false);
      if(!addr || !pass) return setAuthMsg('請輸入 Email 與密碼（至少 8 碼）', false);
      if(pass.length < 8) return setAuthMsg('密碼至少 8 碼', false);

      // 指定驗證後導回 admin.html（已加入 Redirect 白名單）
      const { data, error } = await sb.auth.signUp({
        email: addr, password: pass,
        options: { emailRedirectTo: FRONTEND_REDIRECT }
      });
      if(error){
        const m = (''+error.message).toLowerCase();
        if(m.includes('rate limit') || m.includes('security purposes')){
          return setAuthMsg('註冊過於頻繁，請等待約 60 秒後再按一次。', false);
        }
        return setAuthMsg('註冊失敗：'+error.message, false);
      }
      if(!data.session){
        setAuthMsg('已寄出驗證信，請到信箱完成驗證（收件匣 / 垃圾信匣）。', true);
      }else{
        // 專案若關閉 email 確認，會直接登入
        renderAuth(data.user);
        setAuthMsg('註冊並登入成功', true);
      }
    };

    // 重送驗證信（需等 60 秒）
    btnResend.onclick = async ()=>{
      setAuthMsg('');
      const addr = email.value.trim();
      if(!mustAdminAddress(addr)) return setAuthMsg('僅允許管理者 Email 重送驗證信', false);
      const { data, error } = await sb.auth.resend({
        type: 'signup',
        email: addr,
        options: { emailRedirectTo: FRONTEND_REDIRECT }
      });
      if(error){
        const m = (''+error.message).toLowerCase();
        if(m.includes('rate limit')) return setAuthMsg('重送過於頻繁，請等待約 60 秒再試。', false);
        return setAuthMsg('重送失敗：'+error.message, false);
      }
      setAuthMsg('已重送驗證信，請到信箱查看。', true);
    };

    btnLogout.onclick = async()=>{
      await sb.auth.signOut();
      renderAuth(null);
      setAuthMsg('已登出。', true);
    };
  </script>
</body>
</html>
