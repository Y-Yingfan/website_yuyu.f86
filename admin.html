<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>產品管理後台</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    form { margin-bottom: 20px; }
    form > div { margin-bottom: 8px; }
    label { display: inline-block; width: 120px; font-weight: bold; }
    input[type="text"], input[type="number"], textarea { width: 300px; }
    textarea { height: 60px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>產品管理</h1>
  <!-- 產品輸入表單 -->
  <form id="product-form">
    <!-- 隱藏欄位：產品ID（用於編輯模式） -->
    <input type="hidden" name="id" id="prod-id" />
    <div>
      <label for="prod-name">名稱：</label>
      <input type="text" id="prod-name" name="name" required />
    </div>
    <div>
      <label for="prod-product_id">商品編號：</label>
      <input type="text" id="prod-product_id" name="product_id" />
    </div>
    <div>
      <label for="prod-category">分類：</label>
      <input type="text" id="prod-category" name="category" />
    </div>
    <div>
      <label for="prod-price">價格：</label>
      <input type="number" id="prod-price" name="price" step="any" />
    </div>
    <div>
      <label for="prod-cost_jpy">成本(日幣)：</label>
      <input type="number" id="prod-cost_jpy" name="cost_jpy" step="any" />
    </div>
    <div>
      <label for="prod-cost_nt">成本(台幣)：</label>
      <input type="number" id="prod-cost_nt" name="cost_nt" step="any" />
    </div>
    <div>
      <label for="prod-status">狀態：</label>
      <input type="text" id="prod-status" name="status" />
    </div>
    <div>
      <label for="prod-eta_text">預計到貨(文字)：</label>
      <input type="text" id="prod-eta_text" name="eta_text" />
    </div>
    <div>
      <label for="prod-arrival_time">預計到貨時間：</label>
      <input type="text" id="prod-arrival_time" name="arrival_time" />
    </div>
    <div>
      <label for="prod-img_url">主要圖片URL：</label>
      <input type="text" id="prod-img_url" name="img_url" />
    </div>
    <div>
      <label for="prod-images">其它圖片清單：</label><br/>
      <textarea id="prod-images" name="images" placeholder="每行輸入一個圖片URL"></textarea>
    </div>
    <div>
      <label for="prod-tags">標籤(tags)：</label>
      <input type="text" id="prod-tags" name="tags" placeholder="例如: 標籤1, 標籤2, ..." />
    </div>
    <div>
      <label for="prod-note">備註：</label><br/>
      <textarea id="prod-note" name="note"></textarea>
    </div>
    <button type="submit" id="save-btn">💾 保存產品</button>
    <button type="button" id="cancel-btn">清空表單</button>
  </form>

  <!-- 現有產品列表 -->
  <table id="products-table">
    <thead>
      <tr>
        <th>名稱</th>
        <th>分類</th>
        <th>價格</th>
        <th>狀態</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <!-- 將由腳本填入資料 -->
    </tbody>
  </table>

  <script>
    // 選取表單及各欄位元素
    const form = document.getElementById('product-form');
    const idField = document.getElementById('prod-id');
    const nameField = document.getElementById('prod-name');
    const productIdField = document.getElementById('prod-product_id');
    const categoryField = document.getElementById('prod-category');
    const priceField = document.getElementById('prod-price');
    const costJpyField = document.getElementById('prod-cost_jpy');
    const costNtField = document.getElementById('prod-cost_nt');
    const statusField = document.getElementById('prod-status');
    const etaField = document.getElementById('prod-eta_text');
    const arrivalField = document.getElementById('prod-arrival_time');
    const imgUrlField = document.getElementById('prod-img_url');
    const imagesField = document.getElementById('prod-images');
    const tagsField = document.getElementById('prod-tags');
    const noteField = document.getElementById('prod-note');
    const tableBody = document.querySelector('#products-table tbody');

    // 頁面載入時取得現有產品列表並顯示
    async function loadProducts() {
      try {
        const res = await fetch('/products');
        if (!res.ok) throw new Error('Failed to load products');
        const products = await res.json();
        tableBody.innerHTML = '';
        products.forEach(product => {
          const tr = document.createElement('tr');
          tr.innerHTML = \`
            <td>\${product.name}</td>
            <td>\${product.category || ''}</td>
            <td>\${product.price != null ? product.price : ''}</td>
            <td>\${product.status || ''}</td>
            <td>
              <button data-id="\${product.id}" class="edit-btn">編輯</button>
              <button data-id="\${product.id}" class="delete-btn">刪除</button>
            </td>
          \`;
          tableBody.appendChild(tr);
        });
      } catch (err) {
        console.error('無法載入產品列表：', err);
      }
    }

    // 表單提交事件（新增或更新產品）
    form.addEventListener('submit', async function(event) {
      event.preventDefault();
      const id = idField.value.trim();
      // 準備要送出的產品資料對象，從表單欄位讀取值
      const productData = {
        name: nameField.value.trim(),
        product_id: productIdField.value.trim(),
        category: categoryField.value.trim(),
        price: priceField.value ? parseFloat(priceField.value) : null,
        cost_jpy: costJpyField.value ? parseFloat(costJpyField.value) : null,
        cost_nt: costNtField.value ? parseFloat(costNtField.value) : null,
        status: statusField.value.trim(),
        eta_text: etaField.value.trim(),
        arrival_time: arrivalField.value.trim(),
        img_url: imgUrlField.value.trim(),
        // 將多行圖片文本切成陣列；過濾掉空行
        images: imagesField.value 
                 ? imagesField.value.split('\\n').map(line => line.trim()).filter(line => line) 
                 : [],
        // 將逗號分隔的標籤字串切成陣列；過濾空白
        tags: tagsField.value 
               ? tagsField.value.split(',').map(tag => tag.trim()).filter(tag => tag) 
               : [],
        note: noteField.value.trim()
      };
      // 判斷是新增還是更新
      let url = '/products';
      let method = 'POST';
      if (id) {
        // 編輯模式，帶上產品ID，使用PUT
        url = \`/products/\${id}\`;
        method = 'PUT';
      }
      try {
        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(productData)
        });
        if (!res.ok) throw new Error('Save failed');
        // 更新列表並重置表單
        await loadProducts();
        form.reset();
        idField.value = '';
      } catch (err) {
        console.error('保存產品時發生錯誤：', err);
        alert('產品無法保存，請檢查伺服器狀態。');
      }
    });

    // 代理監聽列表中的按鈕點擊事件，用於編輯或刪除
    tableBody.addEventListener('click', function(event) {
      const target = event.target;
      if (target.classList.contains('edit-btn')) {
        // 編輯按鈕：載入該ID產品資料到表單
        const productId = target.getAttribute('data-id');
        fetch(\`/products/\${productId}\`)
          .then(res => res.json())
          .then(product => {
            // 將表單填入產品現有資料
            idField.value       = product.id || '';
            nameField.value     = product.name || '';
            productIdField.value= product.product_id || '';
            categoryField.value = product.category || '';
            priceField.value    = (product.price !== null && product.price !== undefined) ? product.price : '';
            costJpyField.value  = (product.cost_jpy !== null && product.cost_jpy !== undefined) ? product.cost_jpy : '';
            costNtField.value   = (product.cost_nt !== null && product.cost_nt !== undefined) ? product.cost_nt : '';
            statusField.value   = product.status || '';
            etaField.value      = product.eta_text || '';
            arrivalField.value  = product.arrival_time || '';
            imgUrlField.value   = product.img_url || '';
            // images 欄位可能為字串（帶有換行）或已解析成陣列
            if (Array.isArray(product.images)) {
              imagesField.value = product.images.join('\\n');
            } else {
              imagesField.value = product.images || '';
            }
            // tags 欄位可能為已解析的陣列
            if (Array.isArray(product.tags)) {
              tagsField.value = product.tags.join(', ');
            } else {
              tagsField.value = product.tags || '';
            }
            noteField.value     = product.note || '';
            // 捲動到表單位置方便編輯
            window.scrollTo({ top: 0, behavior: 'smooth' });
          });
      } 
      else if (target.classList.contains('delete-btn')) {
        // 刪除按鈕：詢問確認後刪除產品
        const productId = target.getAttribute('data-id');
        if (confirm('確定要刪除這項產品嗎？')) {
          fetch(\`/products/\${productId}\`, { method: 'DELETE' })
            .then(res => {
              if (!res.ok) {
                alert('刪除失敗，請檢查伺服器狀態。');
              } else {
                loadProducts();
              }
            });
        }
      }
    });

    // 清空表單按鈕：重置表單欄位
    document.getElementById('cancel-btn').addEventListener('click', () => {
      form.reset();
      idField.value = '';
    });

    // 初次載入頁面時，載入產品列表
    loadProducts();
  </script>
</body>
</html>
