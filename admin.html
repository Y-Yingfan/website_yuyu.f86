<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>商品後台管理</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2 {
      color: #333;
    }
    /* 表單樣式 */
    #product-form {
      max-width: 600px;
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ccc;
    }
    #product-form .form-row {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    #product-form .form-row label {
      width: 120px;
      font-weight: bold;
      margin-right: 10px;
    }
    #product-form .form-row input,
    #product-form .form-row select {
      flex: 1;
      padding: 5px;
      font-size: 1em;
    }
    #product-form .form-row input[type="number"] {
      width: 150px;
    }
    #product-form #tags-input {
      width: 100%;
    }
    /* 圖片預覽區 */
    #image-preview {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .preview-container {
      position: relative;
      margin: 5px;
      border: 1px solid #ccc;
      padding: 5px;
    }
    .preview-container.drag-over {
      border: 2px dashed #000;
    }
    .preview-container img {
      max-width: 100px;
      max-height: 100px;
      display: block;
    }
    .preview-container .remove-image {
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.7);
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
    /* 按鈕樣式 */
    .btn {
      display: inline-block;
      padding: 6px 12px;
      margin-right: 5px;
      font-size: 14px;
      cursor: pointer;
      background-color: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 4px;
      text-decoration: none;
      text-align: center;
    }
    .btn:hover {
      background-color: #45a049;
    }
    /* 表格樣式 */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #aaa;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
      cursor: pointer;
    }
    td.actions {
      text-align: center;
    }
    td.actions button {
      margin: 0 3px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    /* 登入表單樣式 */
    #login-section {
      max-width: 300px;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
    }
    #login-section label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    #login-section input {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
      font-size: 1em;
    }
    #login-section button {
      width: 100%;
      padding: 6px;
      font-size: 1em;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>商品後台管理</h1>
  <!-- 登入區塊 -->
  <div id="login-section">
    <h2>管理員登入</h2>
    <label for="login-email">Email:</label>
    <input type="email" id="login-email" placeholder="管理員 Email" required />
    <label for="login-password">Password:</label>
    <input type="password" id="login-password" placeholder="密碼" required />
    <button id="login-button" class="btn">登入</button>
  </div>
  <!-- 管理介面區塊（登入後顯示） -->
  <div id="admin-section" style="display:none;">
    <h2 id="form-title">新增商品</h2>
    <form id="product-form">
      <div class="form-row">
        <label for="name-input">商品名稱:</label>
        <input type="text" id="name-input" required />
      </div>
      <div class="form-row">
        <label for="code-input">商品編號:</label>
        <input type="text" id="code-input" required />
      </div>
      <div class="form-row">
        <label for="price-input">價格:</label>
        <input type="number" id="price-input" required />
      </div>
      <div class="form-row">
        <label for="category-select">分類:</label>
        <select id="category-select" required>
          <option value="" disabled selected>選擇分類</option>
          <option value="香氛">香氛</option>
          <option value="藥妝">藥妝</option>
          <option value="MUJI">MUJI</option>
          <option value="御守 & 淨化噴霧">御守 & 淨化噴霧</option>
          <option value="超商">超商</option>
        </select>
      </div>
      <div class="form-row">
        <label for="status-select">商品狀態:</label>
        <select id="status-select" required>
          <option value="現貨">現貨</option>
          <option value="預購">預購</option>
        </select>
      </div>
      <div class="form-row">
        <label for="arrival-input">到貨時間:</label>
        <input type="text" id="arrival-input" placeholder="例如: 2023-12 或 7-14天" />
      </div>
      <div class="form-row">
        <label for="tags-input">標籤:</label>
        <input type="text" id="tags-input" placeholder="以 | 分隔多個標籤" />
      </div>
      <div class="form-row">
        <label>商品圖片:</label>
        <div>
          <div id="image-preview"></div>
          <input type="file" id="file-input" accept="image/*" multiple style="display:none;" />
          <label for="file-input" class="btn">新增圖片</label>
        </div>
      </div>
      <button type="button" id="save-button" class="btn">儲存商品</button>
      <button type="button" id="cancel-edit-button" class="btn" style="display:none; background-color:#888;">取消編輯</button>
    </form>
    <h2>商品列表</h2>
    <div>
      <label for="search-input">搜尋商品:</label>
      <input type="text" id="search-input" placeholder="輸入名稱或標籤關鍵字" />
    </div>
    <table>
      <thead>
        <tr>
          <th>縮圖</th>
          <th>商品名稱</th>
          <th>商品編號</th>
          <th>價格</th>
          <th>分類</th>
          <th>狀態</th>
          <th>到貨時間</th>
          <th>標籤</th>
          <th id="th-created">上架時間 ▲</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="product-list">
      </tbody>
    </table>
    <button id="logout-button" class="btn" style="margin-top:15px; background-color:#555;">登出</button>
  </div>
  <!-- 引入 Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // 初始化 Supabase
    const SUPABASE_URL = "https://yuyu.f86.supabase.co";
    const SUPABASE_KEY = "sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const ADMIN_EMAIL = "lelouvre.yu@gmail.com";
    // DOM 元素取得
    const loginSection = document.getElementById("login-section");
    const adminSection = document.getElementById("admin-section");
    const emailInput = document.getElementById("login-email");
    const passwordInput = document.getElementById("login-password");
    const loginButton = document.getElementById("login-button");
    const logoutButton = document.getElementById("logout-button");
    // 表單欄位
    const formTitle = document.getElementById("form-title");
    const nameInput = document.getElementById("name-input");
    const codeInput = document.getElementById("code-input");
    const priceInput = document.getElementById("price-input");
    const categorySelect = document.getElementById("category-select");
    const statusSelect = document.getElementById("status-select");
    const arrivalInput = document.getElementById("arrival-input");
    const tagsInput = document.getElementById("tags-input");
    const fileInput = document.getElementById("file-input");
    const imagePreview = document.getElementById("image-preview");
    const saveButton = document.getElementById("save-button");
    const cancelEditButton = document.getElementById("cancel-edit-button");
    // 列表及搜尋
    const searchInput = document.getElementById("search-input");
    const productListTbody = document.getElementById("product-list");
    const thCreated = document.getElementById("th-created");
    // 狀態變數
    let currentUser = null;
    let editingProductId = null; // 當前編輯中的商品ID（null表示新增模式）
    let imagesArray = []; // 當前表單的圖片列表（含檔案或URL）
    let allProducts = []; // 從資料庫載入的所有商品列表
    let sortAsc = false;  // 上架時間排序（false=最新在前）
    
    // 驗證登入狀態
    async function checkAuth() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session && session.user) {
        currentUser = session.user;
      } else {
        currentUser = null;
      }
      // 若登入但非授權管理員帳號，登出並顯示登入頁
      if (currentUser && currentUser.email !== ADMIN_EMAIL) {
        await supabaseClient.auth.signOut();
        currentUser = null;
        alert("非管理者無權限");
        showLoginSection();
      } else if (currentUser && currentUser.email === ADMIN_EMAIL) {
        showAdminSection();
        loadProducts();
      } else {
        showLoginSection();
      }
    }
    function showLoginSection() {
      adminSection.style.display = "none";
      loginSection.style.display = "block";
    }
    function showAdminSection() {
      loginSection.style.display = "none";
      adminSection.style.display = "block";
    }
    
    // 登入按鈕事件
    loginButton.addEventListener("click", async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      if (!email || !password) {
        alert("請輸入Email和密碼");
        return;
      }
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        alert("登入失敗：" + error.message);
      } else {
        // Login succeeded, re-check auth state and proceed
        checkAuth();
      }
    });
    // 登出按鈕事件
    logoutButton.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      currentUser = null;
      showLoginSection();
      // 清空商品列表顯示
      productListTbody.innerHTML = "";
    });
    
    // 儲存（新增/更新）商品事件
    saveButton.addEventListener("click", async () => {
      // 簡單驗證必填欄位
      const name = nameInput.value.trim();
      const code = codeInput.value.trim();
      const priceVal = priceInput.value;
      const category = categorySelect.value;
      const status = statusSelect.value;
      if (!name || !code || !priceVal || !category || !status) {
        alert("請填寫所有必填欄位");
        return;
      }
      const price = parseInt(priceVal);
      if (isNaN(price)) {
        alert("價格欄位必須為數字");
        return;
      }
      // 準備資料
      let imagePaths = [];
      for (let i = 0; i < imagesArray.length; i++) {
        const imgObj = imagesArray[i];
        if (imgObj.new) {
          // 上傳新圖片檔案
          const file = imgObj.file;
          const ext = file.name.split('.').pop();
          const fileName = `${code}-${Date.now()}-${Math.random().toString(36).substr(2,6)}.${ext}`;
          const filePath = `${code}/${fileName}`;
          const { error: uploadError } = await supabaseClient.storage.from("yuyu.f86").upload(filePath, file, { upsert: false });
          if (uploadError) {
            console.error("Image upload failed:", uploadError);
            alert("圖片上傳失敗: " + uploadError.message);
            return;
          }
          imagePaths.push(filePath);
        } else {
          // 已存在的圖片
          imagePaths.push(imgObj.path);
        }
      }
      const productData = {
        name: name,
        product_id: code,
        price: price,
        category: category,
        status: status,
        arrival_time: arrivalInput.value.trim(),
        tags: tagsInput.value.trim(),
        images: imagePaths
      };
      if (editingProductId) {
        // 更新商品
        const { error } = await supabaseClient.from("products").update(productData).eq("id", editingProductId);
        if (error) {
          console.error("Update failed:", error);
          alert("更新失敗: " + error.message);
        } else {
          alert("商品更新成功");
          resetForm();
          loadProducts();
        }
      } else {
        // 新增商品
        const { error } = await supabaseClient.from("products").insert(productData);
        if (error) {
          console.error("Insert failed:", error);
          alert("新增失敗: " + error.message);
        } else {
          alert("商品新增成功");
          resetForm();
          loadProducts();
        }
      }
    });
    
    // 取消編輯事件
    cancelEditButton.addEventListener("click", () => {
      resetForm();
    });
    
    // 圖片檔案選擇事件
    fileInput.addEventListener("change", () => {
      const files = fileInput.files;
      if (files && files.length > 0) {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const url = URL.createObjectURL(file);
          imagesArray.push({ file: file, url: url, path: null, new: true });
        }
        renderImagePreviews();
      }
      // 重置 input，使相同檔案可再次選取
      fileInput.value = "";
    });
    
    // 顯示圖片預覽並設定拖曳排序事件
    function renderImagePreviews() {
      imagePreview.innerHTML = "";
      imagesArray.forEach((imgObj, index) => {
        const container = document.createElement("div");
        container.className = "preview-container";
        container.draggable = true;
        container.dataset.index = index;
        // 圖片元素
        const imgEl = document.createElement("img");
        imgEl.src = imgObj.url || "";
        imgEl.alt = "image";
        container.appendChild(imgEl);
        // 移除圖片按鈕
        const removeBtn = document.createElement("button");
        removeBtn.innerHTML = "&times;";
        removeBtn.className = "remove-image";
        removeBtn.dataset.index = index;
        container.appendChild(removeBtn);
        // 拖曳事件綁定
        container.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", index);
        });
        container.addEventListener("dragenter", (e) => {
          e.preventDefault();
          container.classList.add("drag-over");
        });
        container.addEventListener("dragover", (e) => {
          e.preventDefault();
        });
        container.addEventListener("dragleave", () => {
          container.classList.remove("drag-over");
        });
        container.addEventListener("drop", (e) => {
          e.preventDefault();
          e.stopPropagation();
          container.classList.remove("drag-over");
          const sourceIndex = parseInt(e.dataTransfer.getData("text/plain"));
          const targetIndex = index;
          if (!isNaN(sourceIndex) && sourceIndex !== targetIndex) {
            const item = imagesArray[sourceIndex];
            imagesArray.splice(sourceIndex, 1);
            imagesArray.splice(targetIndex, 0, item);
            renderImagePreviews();
          }
        });
        imagePreview.appendChild(container);
      });
    }
    // 刪除圖片（使用事件委派）
    imagePreview.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-image")) {
        const idx = parseInt(e.target.dataset.index);
        if (!isNaN(idx)) {
          // 釋放物件URL記憶體
          if (imagesArray[idx].new && imagesArray[idx].url) {
            URL.revokeObjectURL(imagesArray[idx].url);
          }
          imagesArray.splice(idx, 1);
          renderImagePreviews();
        }
      }
    });
    // 在預覽區空白處放開拖曳（放至最後）
    imagePreview.addEventListener("dragover", (e) => {
      e.preventDefault();
    });
    imagePreview.addEventListener("drop", (e) => {
      e.preventDefault();
      const sourceIndex = parseInt(e.dataTransfer.getData("text/plain"));
      if (!isNaN(sourceIndex)) {
        const item = imagesArray[sourceIndex];
        imagesArray.splice(sourceIndex, 1);
        imagesArray.push(item);
        renderImagePreviews();
      }
    });
    
    // 渲染商品列表
    function renderProductList() {
      const searchText = searchInput.value.trim().toLowerCase();
      let filtered = [];
      if (searchText) {
        filtered = allProducts.filter(prod => {
          const nameMatch = prod.name && prod.name.toLowerCase().includes(searchText);
          const tagMatch = prod.tags && prod.tags.toLowerCase().includes(searchText);
          const codeMatch = prod.product_id && prod.product_id.toLowerCase().includes(searchText);
          return nameMatch || tagMatch || codeMatch;
        });
      } else {
        filtered = allProducts.slice();
      }
      // 根據上架時間排序
      if (sortAsc) {
        filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      } else {
        filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      }
      // 產生表格列
      productListTbody.innerHTML = "";
      filtered.forEach((prod, index) => {
        const tr = document.createElement("tr");
        // 縮圖
        const thumbTd = document.createElement("td");
        if (prod.images && prod.images.length > 0) {
          const imgPath = prod.images[0];
          let publicUrl = "";
          if (imgPath) {
            const { data } = supabaseClient.storage.from("yuyu.f86").getPublicUrl(imgPath);
            publicUrl = data.publicUrl;
          }
          if (publicUrl) {
            const thumbImg = document.createElement("img");
            thumbImg.src = publicUrl;
            thumbImg.alt = "thumb";
            thumbImg.style.maxWidth = "50px";
            thumbImg.style.maxHeight = "50px";
            thumbTd.appendChild(thumbImg);
          }
        }
        tr.appendChild(thumbTd);
        // 名稱
        const nameTd = document.createElement("td");
        nameTd.textContent = prod.name || "";
        tr.appendChild(nameTd);
        // 編號
        const codeTd = document.createElement("td");
        codeTd.textContent = prod.product_id || "";
        tr.appendChild(codeTd);
        // 價格
        const priceTd = document.createElement("td");
        priceTd.textContent = (prod.price != null) ? prod.price : "";
        tr.appendChild(priceTd);
        // 分類
        const catTd = document.createElement("td");
        catTd.textContent = prod.category || "";
        tr.appendChild(catTd);
        // 狀態
        const statusTd = document.createElement("td");
        statusTd.textContent = prod.status || "";
        tr.appendChild(statusTd);
        // 到貨時間
        const arrTd = document.createElement("td");
        arrTd.textContent = prod.arrival_time || "";
        tr.appendChild(arrTd);
        // 標籤
        const tagsTd = document.createElement("td");
        tagsTd.textContent = prod.tags || "";
        tr.appendChild(tagsTd);
        // 上架時間
        const createdTd = document.createElement("td");
        if (prod.created_at) {
          try {
            createdTd.textContent = new Date(prod.created_at).toLocaleString("zh-TW", { hour12: false });
          } catch {
            createdTd.textContent = prod.created_at;
          }
        } else {
          createdTd.textContent = "";
        }
        tr.appendChild(createdTd);
        // 操作按鈕
        const actionsTd = document.createElement("td");
        actionsTd.className = "actions";
        const editBtn = document.createElement("button");
        editBtn.textContent = "編輯";
        editBtn.className = "edit-btn";
        editBtn.dataset.index = index;
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "複製";
        copyBtn.className = "copy-btn";
        copyBtn.dataset.index = index;
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "刪除";
        deleteBtn.className = "delete-btn";
        deleteBtn.dataset.index = index;
        actionsTd.appendChild(editBtn);
        actionsTd.appendChild(copyBtn);
        actionsTd.appendChild(deleteBtn);
        tr.appendChild(actionsTd);
        productListTbody.appendChild(tr);
      });
    }
    
    // 透過事件委派監聽編輯/複製/刪除按鈕
    productListTbody.addEventListener("click", (e) => {
      const target = e.target;
      if (target.classList.contains("edit-btn")) {
        const idx = parseInt(target.dataset.index);
        if (!isNaN(idx)) {
          const prod = getFilteredList()[idx];
          startEditProduct(prod);
        }
      } else if (target.classList.contains("copy-btn")) {
        const idx = parseInt(target.dataset.index);
        if (!isNaN(idx)) {
          const prod = getFilteredList()[idx];
          copyProduct(prod);
        }
      } else if (target.classList.contains("delete-btn")) {
        const idx = parseInt(target.dataset.index);
        if (!isNaN(idx)) {
          const prod = getFilteredList()[idx];
          deleteProduct(prod);
        }
      }
    });
    // 取得目前篩選和排序後的列表（用於對應按鈕索引）
    function getFilteredList() {
      const searchText = searchInput.value.trim().toLowerCase();
      let list = allProducts.slice();
      if (searchText) {
        list = list.filter(prod => {
          const nameMatch = prod.name && prod.name.toLowerCase().includes(searchText);
          const tagMatch = prod.tags && prod.tags.toLowerCase().includes(searchText);
          const codeMatch = prod.product_id && prod.product_id.toLowerCase().includes(searchText);
          return nameMatch || tagMatch || codeMatch;
        });
      }
      if (sortAsc) {
        list.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      } else {
        list.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      }
      return list;
    }
    // 開始編輯商品
    function startEditProduct(prod) {
      editingProductId = prod.id;
      formTitle.textContent = "編輯商品";
      saveButton.textContent = "更新商品";
      cancelEditButton.style.display = "inline-block";
      // 填入欄位值
      nameInput.value = prod.name || "";
      codeInput.value = prod.product_id || "";
      priceInput.value = prod.price != null ? prod.price : "";
      categorySelect.value = prod.category || "";
      statusSelect.value = prod.status || "";
      arrivalInput.value = prod.arrival_time || "";
      tagsInput.value = prod.tags || "";
      // 載入圖片清單
      imagesArray = [];
      if (prod.images && prod.images.length > 0) {
        for (const path of prod.images) {
          let url = "";
          if (path) {
            const { data } = supabaseClient.storage.from("yuyu.f86").getPublicUrl(path);
            url = data.publicUrl;
          }
          imagesArray.push({ file: null, url: url, path: path, new: false });
        }
      }
      renderImagePreviews();
    }
    // 複製商品
    function copyProduct(prod) {
      editingProductId = null;
      formTitle.textContent = "複製商品 (新增)";
      saveButton.textContent = "儲存商品";
      cancelEditButton.style.display = "inline-block";
      // 預填欄位值
      nameInput.value = prod.name || "";
      codeInput.value = prod.product_id || "";
      priceInput.value = prod.price != null ? prod.price : "";
      categorySelect.value = prod.category || "";
      statusSelect.value = prod.status || "";
      arrivalInput.value = prod.arrival_time || "";
      tagsInput.value = prod.tags || "";
      // 複製圖片（參照相同檔案路徑）
      imagesArray = [];
      if (prod.images && prod.images.length > 0) {
        for (const path of prod.images) {
          let url = "";
          if (path) {
            const { data } = supabaseClient.storage.from("yuyu.f86").getPublicUrl(path);
            url = data.publicUrl;
          }
          imagesArray.push({ file: null, url: url, path: path, new: false });
        }
      }
      renderImagePreviews();
      // 聚焦商品編號欄位提醒修改
      codeInput.focus();
      codeInput.select();
    }
    // 刪除商品
    async function deleteProduct(prod) {
      if (!confirm(`確定要刪除商品「${prod.name}」嗎？`)) {
        return;
      }
      const { error } = await supabaseClient.from("products").delete().eq("id", prod.id);
      if (error) {
        console.error("Delete failed:", error);
        alert("刪除失敗: " + error.message);
      } else {
        alert("商品已刪除");
        loadProducts();
      }
    }
    
    // 搜尋輸入事件（即時篩選）
    searchInput.addEventListener("input", () => {
      renderProductList();
    });
    // 點擊「上架時間」表頭切換排序
    thCreated.addEventListener("click", () => {
      sortAsc = !sortAsc;
      if (sortAsc) {
        thCreated.textContent = "上架時間 ▼";
      } else {
        thCreated.textContent = "上架時間 ▲";
      }
      renderProductList();
    });
    
    // 從資料庫載入商品列表
    async function loadProducts() {
      const { data, error } = await supabaseClient.from("products")
        .select("id, name, product_id, price, category, status, arrival_time, tags, images, created_at")
        .order("created_at", { ascending: false });
      if (error) {
        console.error("Failed to load products:", error);
        alert("載入商品資料失敗: " + error.message);
        return;
      }
      allProducts = data || [];
      renderProductList();
    }
    
    // 網頁載入時檢查登入狀態
    checkAuth();
  </script>
</body>
</html>
