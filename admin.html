<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>商品後台管理（連線診斷版）</title>
<style>
  :root{--bg:#f6f4ef;--panel:#fff;--ink:#2f2f2f;--muted:#6b6a62;--line:#e7e2d9;--accent:#c2a35d;--ok:#14532d;--warn:#7c2d12;--err:#881337}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif}
  .wrap{max-width:1000px;margin:20px auto;padding:0 14px}
  h1{margin:6px 0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;box-shadow:0 10px 28px rgba(0,0,0,.06);margin-bottom:14px}
  .status{padding:10px 12px;border-radius:10px;margin:10px 0;font-size:14px;white-space:pre-wrap}
  .ok{background:#eefcf3;border:1px solid #bbf7d0;color:var(--ok)}
  .warn{background:#fff7ed;border:1px solid #fed7aa;color:var(--warn)}
  .err{background:#fff1f2;border:1px solid #fecdd3;color:var(--err)}
  label{display:block;margin:8px 0 6px;color:var(--muted)}
  input{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border:none}
  .muted{color:var(--muted)}
  .flex{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
</style>
</head>
<body>
<div class="wrap">
  <h1>商品後台管理</h1>

  <!-- 連線診斷 -->
  <div id="diagA" class="status warn">A) 檢查 /auth/v1/health …</div>
  <div id="diagB" class="status warn">B) 檢查 supabase-js 查表 …</div>
  <div id="diagC" class="status warn">C) 檢查 REST（帶 apikey + Authorization）…</div>

  <div class="card">
    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="你要登入/註冊的 Email" />
      </div>
      <div>
        <label>密碼（至少 8 碼）</label>
        <input id="password" type="password" placeholder="Password" />
      </div>
    </div>
    <div class="flex" style="margin-top:10px">
      <button id="btnLogin"  class="btn primary">登入</button>
      <button id="btnSignup" class="btn">註冊（第一次使用）</button>
      <span class="muted">僅允許管理者 Email：<b id="adminHint"></b></span>
      <button id="btnLogout" class="btn right">登出</button>
    </div>
    <div id="authMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div class="muted">連線正常後這裡再載入商品管理（先把連線搞定）。</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =================== 這段已改成你提供的值 =================== */
const SUPABASE_URL = 'https://llbpmqyjigovxixeohzr.supabase.co';
const SUPABASE_KEY =  'sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB'; // ← 貼 llbpm… 專案的 anon（Legacy）或 sb_publishable_ key（同專案）
const ADMIN_EMAIL  = 'lelouvre.yu@gmail.com';
const BUCKET       = 'yuyu.f86';
/* ========================================================== */

document.getElementById('adminHint').textContent = ADMIN_EMAIL;

// 建 supabase-js client（會自動夾帶 apikey 與 Authorization）
const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

// ====== 連線診斷 ======
async function diagAuthHealth(){
  const box = document.getElementById('diagA');
  try{
    const r = await fetch(`${SUPABASE_URL}/auth/v1/health`, { mode:'cors' });
    const t = await r.text().catch(()=> '');
    if(r.ok){
      box.className = 'status ok';
      box.textContent = `A) /auth/v1/health ✔ 200\n${t||'(OK)'}`;
    }else{
      box.className = 'status err';
      box.textContent = `A) /auth/v1/health ❌ ${r.status}\n回應：${t||'(無內容)'}\n→ 這一步不需要 key。這裡 401/403/404 多半是 URL 打錯或網路被擋（Origin 未被允許）。`;
    }
  }catch(e){
    box.className = 'status err';
    box.textContent = `A) /auth/v1/health ❌ 例外\n${e?.message||e}`;
  }
}

async function diagSelectViaClient(){
  const box = document.getElementById('diagB');
  try{
    const { data, error, status } = await sb.from('products').select('id').limit(1);
    if(error){
      box.className = 'status err';
      box.textContent = `B) supabase-js 查表 ❌（status 可能=${status}）\n${error.message}`;
    }else{
      box.className = 'status ok';
      box.textContent = `B) supabase-js 查表 ✔\n取到 ${data?.length||0} 筆`;
    }
  }catch(e){
    box.className = 'status err';
    box.textContent = `B) supabase-js 查表 ❌ 例外\n${e?.message||e}`;
  }
}

async function diagRestFetch(){
  const box = document.getElementById('diagC');
  try{
    const r = await fetch(`${SUPABASE_URL}/rest/v1/products?select=id&limit=1`,{
      mode:'cors',
      headers:{
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    });
    const t = await r.text().catch(()=> '');
    if(r.status===200){
      box.className = 'status ok';
      box.textContent = `C) REST ✔ 200（帶 apikey + Authorization）\n${t||'(OK)'}`;
    }else{
      box.className = 'status err';
      box.textContent = `C) REST ❌ ${r.status}\n${t}\n→ 這裡 401 幾乎都是「key 不是這個專案的」，或 key 前後有看不到的空白/換行；請重新複製 llbpm… 專案的 anon（Legacy）或 sb_publishable_ key 貼上。`;
    }
  }catch(e){
    box.className = 'status err';
    box.textContent = `C) REST ❌ 例外\n${e?.message||e}`;
  }
}

diagAuthHealth().then(diagSelectViaClient).then(diagRestFetch);

// ====== 登入/註冊/登出（僅測通即可） ======
const q = s=>document.querySelector(s);
q('#btnLogin').onclick = async()=>{
  q('#authMsg').textContent='';
  const email=(q('#email').value||'').trim();
  const pass = q('#password').value||'';
  if(email.toLowerCase()!==ADMIN_EMAIL.toLowerCase()){ q('#authMsg').textContent='僅允許指定 Email 登入'; return; }
  if(!email||!pass){ q('#authMsg').textContent='請輸入 Email 與密碼'; return; }
  const { error } = await sb.auth.signInWithPassword({ email, password: pass });
  q('#authMsg').textContent = error? `登入失敗：${error.message}`:'登入成功';
};
q('#btnSignup').onclick = async()=>{
  q('#authMsg').textContent='';
  const email=(q('#email').value||'').trim();
  const pass = q('#password').value||'';
  if(email.toLowerCase()!==ADMIN_EMAIL.toLowerCase()){ q('#authMsg').textContent='僅允許指定 Email 註冊'; return; }
  if(!email||!pass){ q('#authMsg').textContent='請輸入 Email 與密碼'; return; }
  if(pass.length<8){ q('#authMsg').textContent='密碼至少 8 碼'; return; }
  const { data, error } = await sb.auth.signUp({ email, password: pass });
  q('#authMsg').textContent = error? `註冊失敗：${error.message}` : (data.session?'註冊成功並已登入':'註冊成功，請到信箱驗證後登入');
};
q('#btnLogout').onclick = async()=>{ await sb.auth.signOut(); q('#authMsg').textContent='已登出'; };
</script>
</body>
</html>

