<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>後台｜連線與商品管理</title>
<style>
:root{--bg:#f7f3ef;--paper:#fffdf9;--card:#fff;--ink:#2b2b2b;--muted:#7a7267;--brand:#8B5E34;--border:#eadfcd;--shadow:0 10px 24px rgba(139,94,52,.08);--radius:14px;--maxw:1080px}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#f8f5f1 0%,var(--bg) 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial}
.wrap{max-width:var(--maxw);margin:20px auto;padding:0 16px}
h1{margin:6px 0 14px}
.badge{display:inline-block;border:1px solid var(--border);padding:3px 8px;border-radius:999px;font-size:12px;background:#fff}
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tabbtn{border:1px solid var(--border);background:#fffdf9;border-radius:999px;padding:8px 14px;cursor:pointer}
.tabbtn.active{background:var(--brand);color:#fff;border-color:transparent}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:860px){.row{grid-template-columns:1fr}}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fffdfa}
textarea{min-height:72px}
.btn{border:none;background:var(--brand);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid var(--border);color:#2b2b2b}
.list{width:100%;border-collapse:collapse}
.list th,.list td{border-top:1px solid var(--border);padding:8px;vertical-align:top}
.list th{background:#fffaf2;text-align:left;font-weight:700}
.small{font-size:12px;color:var(--muted)}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px}
.hidden{display:none}
.warn{color:#b0382f;font-weight:600}
.ok{color:#2f7d32;font-weight:600}
</style>
</head>
<body>
<div class="wrap">
  <h1>後台｜連線與商品管理 <span class="badge">Supabase</span></h1>

  <div class="tabs">
    <button class="tabbtn active" data-tab="products">Products</button>
    <button class="tabbtn" data-tab="runs">Runs</button>
    <button class="tabbtn" data-tab="pool">Pool 派送</button>
    <button class="tabbtn" data-tab="bulk">Bulk Move</button>
    <button class="tabbtn" data-tab="wishes">Wishes</button>
    <button class="tabbtn" data-tab="settings">Settings</button>
  </div>

  <!-- PRODUCTS -->
  <section id="tab-products">
    <div class="panel">
      <h3 style="margin:0 0 10px">新增商品</h3>
      <div class="row">
        <div><label>名稱</label><input id="pName"/></div>
        <div><label>售價（NT$）</label><input id="pPrice" type="number" step="1" min="0"/></div>
        <div><label>分類</label><input id="pCategory" list="categoryList"/><datalist id="categoryList"></datalist></div>
        <div><label>商品編號</label><input id="pPid" placeholder="留空→自動 PYYYYMMDD-XXX"/></div>
        <div><label>狀態</label><input id="pStatus" list="statusList"/><datalist id="statusList"><option value="現貨"></option><option value="預購"></option><option value="售罄"></option></datalist></div>
        <div><label>開始寄送日（同步前台到貨提示）</label><input id="pArrival" type="date"/></div>
        <div><label>指派到連線（含 Pool）</label><select id="pRunAssign"><option value="">— 選擇連線 —</option></select></div>
        <div><label>eta_text（若上面沒選可手填）</label><input id="pEta" placeholder="例：9/26 東京"/></div>
        <div style="grid-column:1 / -1"><label>備註 / 補充</label><input id="pNote"/></div>
        <div><label>成本幣別</label><select id="pCostCurrency"><option value="TWD">TWD</option><option value="JPY">JPY</option><option value="KRW">KRW</option><option value="USD">USD</option></select></div>
        <div><label>成本（原幣）</label><input id="pCostForeign" type="number" step="0.01" min="0"/></div>
        <div><label>台幣成本</label><input id="pCostNt" type="number" step="1" min="0"/></div>
        <div><label>標籤（逗號分隔）</label><input id="pTags" placeholder="3coins,and us,腮紅"/></div>
      </div>
      <div class="small" id="rateTip" style="margin:6px 0 10px"></div>
      <div><button class="btn" id="btnCreateProduct">新增商品</button> <span class="small">（送出將自動建立 <code class="mono">product_runs</code> 對應）</span></div>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0 0 10px">已新增（最新 50，可編輯/刪除）</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <label class="small">檢視</label>
          <select id="prodFilterRun" style="min-width:220px"><option value="">全部商品</option></select>
        </div>
      </div>
      <table class="list" id="productsTable">
        <thead><tr>
          <th>名稱</th><th style="width:90px">售價</th><th style="width:130px">分類</th>
          <th style="width:150px">編號</th><th style="width:220px">連線 / eta_text</th>
          <th style="width:160px">成本(TWD)</th><th style="width:120px">利潤</th>
          <th style="width:240px">操作</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div id="prodErr" class="small warn hidden"></div>
    </div>
  </section>

  <!-- RUNS -->
  <section id="tab-runs" class="hidden">
    <div class="panel">
      <h3 style="margin:0 0 8px">新增 / 編輯 連線</h3>
      <div class="row">
        <div><label>標題 title</label><input id="rTitle" placeholder="例：9/26 東京 或 JP 共用池"/></div>
        <div><label>代碼 code（選填）</label><input id="rCode"/></div>
        <div><label>區域 region</label><input id="rRegion" placeholder="JP / KR / etc."/></div>
        <div><label>開始 start_date</label><input id="rStart" type="date"/></div>
        <div><label>結束 end_date</label><input id="rEnd" type="date"/></div>
        <div><label>寄送開始 ship_start_date</label><input id="rShip" type="date"/></div>
        <div><label>備註 note</label><input id="rNote"/></div>
        <div><label>是否啟用 is_active</label><select id="rActive"><option>true</option><option>false</option></select></div>
        <div><label>首頁 featured</label><select id="rFeatured"><option>false</option><option>true</option></select></div>
        <div><label>是否 Pool（共用池）</label><select id="rIsPool"><option value="false">否</option><option value="true">是</option></select></div>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn" id="btnRunCreate">儲存（新增/更新）</button>
        <button class="btn ghost" id="btnRunReset">清空</button>
        <div id="runsErr" class="small warn"></div>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px">所有連線</h3>
      <table class="list" id="runsTable">
        <thead><tr>
          <th>標題</th><th>區域</th><th>日期</th><th>寄送</th><th>備註</th><th>狀態</th><th>首頁</th><th>Pool</th><th>操作</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div id="runsListErr" class="small warn hidden"></div>
    </div>
  </section>

  <!-- POOL -->
  <section id="tab-pool" class="hidden">
    <div class="panel">
      <h3 style="margin:0 0 10px">從共用池「複製」商品到某次連線</h3>
      <div class="row">
        <div><label>選擇 Pool（is_pool=true）</label><select id="poolSelect"><option value="">— 選擇 Pool —</option></select></div>
        <div><label>目標連線</label><select id="poolTarget"><option value="">— 選擇目標連線 —</option></select></div>
      </div>
      <div class="small">說明：此處為<strong>複製對應</strong>（product_runs），Pool 仍保留。</div>
    </div>
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">Pool 內商品</h3>
        <div>
          <button class="btn ghost" id="poolSelectAll">全選/全不選</button>
          <button class="btn" id="poolCopy">複製到目標連線</button>
        </div>
      </div>
      <div id="poolList" class="small">請先選擇 Pool。</div>
      <div id="poolErr" class="small warn hidden"></div>
    </div>
  </section>

  <!-- BULK -->
  <section id="tab-bulk" class="hidden">
    <div class="panel">
      <h3 style="margin:0 0 10px">批次複製商品到另一個連線</h3>
      <div class="row">
        <div><label>來源連線</label><select id="bulkFrom"><option value="">— 選擇來源 —</option></select></div>
        <div><label>目標連線</label><select id="bulkTo"><option value="">— 選擇目標 —</option></select></div>
        <div><label>範圍</label><select id="bulkScope"><option value="linked">只包含已關聯（product_runs）</option><option value="all">全部（同 linked）</option></select></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="bulkPreview">預覽數量</button>
        <button class="btn" id="bulkDo">執行複製</button>
        <div id="bulkInfo" class="small"></div>
      </div>
      <div id="bulkErr" class="small warn hidden"></div>
    </div>
  </section>

  <!-- WISHES -->
  <section id="tab-wishes" class="hidden">
    <div class="panel">
      <h3 style="margin:0 0 10px">Wishes 管理</h3>
      <div class="small">這裡會列出顧客許願單，供你檢視、回覆、更新狀態。</div>
      <table class="list" id="wishesTable">
        <thead><tr>
          <th>時間</th><th>連線</th><th>分類</th><th>品名</th><th>網址</th><th>內容</th><th>圖片</th><th>狀態</th><th>操作</th>
        </tr></thead>
        <tbody></tbody>
      </table>
      <div id="wishesErr" class="small warn hidden"></div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="tab-settings" class="hidden">
    <div class="panel">
      <h3 style="margin:0 0 10px">匯率設定</h3>
      <div class="row">
        <div><label>JPY → TWD</label><input id="rateJPY" type="number" step="0.0001"/></div>
        <div><label>KRW → TWD</label><input id="rateKRW" type="number" step="0.00001"/></div>
        <div><label>USD → TWD</label><input id="rateUSD" type="number" step="0.0001"/></div>
      </div>
      <div class="small" id="rateTip2" style="margin-top:8px"></div>
      <div style="margin-top:10px"><button class="btn" id="btnSaveRates">儲存匯率</button> <span class="small">（儲存到 <code class="mono">site_meta</code>）</span></div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 10px">首頁「最近連線公告」</h3>
      <div><label>home_notice</label><textarea id="homeNotice" rows="3" placeholder="例：最近連線：9/6~9 日本北海道"></textarea></div>
      <div style="margin-top:10px"><button class="btn" id="btnSaveNotice">儲存公告</button> <span class="small">（寫入 <code class="mono">site_meta.home_notice</code>）</span></div>
      <div id="noticeMsg" class="small"></div>
    </div>
  </section>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* === 基本設定（保持你的專案值） === */
const supabaseUrl='https://llbpmqyjigovxixeohzr.supabase.co';
const supabaseKey='sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
const BUCKET='yuyu.f86';
const sb=supabase.createClient(supabaseUrl,supabaseKey);

/* === 共用工具 === */
const $ = (sel,scope=document)=>scope.querySelector(sel);
const $$ = (sel,scope=document)=>Array.from(scope.querySelectorAll(sel));

function publicUrlFromPath(path){
  if(!path) return '';
  const { data }=sb.storage.from(BUCKET).getPublicUrl(path);
  return data?.publicUrl||'';
}

/* === Tabs：先綁切換，確保一定能換頁 === */
const sections = {
  products: $('#tab-products'),
  runs: $('#tab-runs'),
  pool: $('#tab-pool'),
  bulk: $('#tab-bulk'),
  wishes: $('#tab-wishes'),
  settings: $('#tab-settings'),
};
$$('.tabbtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const key=btn.dataset.tab;
    Object.values(sections).forEach(s=>s.classList.add('hidden'));
    sections[key]?.classList.remove('hidden');
    // lazy load per tab
    if(key==='products') { loadRates().then(()=>{loadRuns().then(()=>{fillCategoryDatalist();loadProducts();});}); }
    if(key==='runs') { loadRuns().then(renderRunsTable).catch(console.warn); }
    if(key==='pool') { loadRuns().then(fillPoolSelectors).catch(console.warn); }
    if(key==='bulk') { loadRuns().then(fillBulkSelectors).catch(console.warn); }
    if(key==='wishes') { loadWishes().catch(console.warn); }
    if(key==='settings') { loadRates().then(loadHomeNotice).catch(console.warn); }
  });
});

/* === Rates === */
let RATES={JPY:0.22, KRW:0.024, USD:32.0};
async function loadRates(){
  try{
    const { data }=await sb.from('site_meta').select('key,value').in('key',['rate_JPY','rate_KRW','rate_USD']);
    (data||[]).forEach(kv=>{
      if(kv.key==='rate_JPY') RATES.JPY = Number(kv.value)||RATES.JPY;
      if(kv.key==='rate_KRW') RATES.KRW = Number(kv.value)||RATES.KRW;
      if(kv.key==='rate_USD') RATES.USD = Number(kv.value)||RATES.USD;
    });
    $('#rateJPY').value=RATES.JPY; $('#rateKRW').value=RATES.KRW; $('#rateUSD').value=RATES.USD;
    $('#rateTip').textContent=`JPY=${RATES.JPY}，KRW=${RATES.KRW}，USD=${RATES.USD}`;
    $('#rateTip2').textContent=`目前： JPY=${RATES.JPY}，KRW=${RATES.KRW}，USD=${RATES.USD}`;
  }catch(e){ console.warn(e); }
}
$('#btnSaveRates')?.addEventListener('click', async()=>{
  try{
    const rows=[
      {key:'rate_JPY', value:String($('#rateJPY').value||RATES.JPY)},
      {key:'rate_KRW', value:String($('#rateKRW').value||RATES.KRW)},
      {key:'rate_USD', value:String($('#rateUSD').value||RATES.USD)},
    ];
    for(const r of rows) await sb.from('site_meta').upsert(r,{onConflict:'key'});
    await loadRates(); alert('已儲存匯率');
  }catch(e){ alert('儲存失敗：'+e.message); }
});

/* === Settings：首頁公告 === */
async function loadHomeNotice(){
  try{
    const { data }=await sb.from('site_meta').select('value').eq('key','home_notice').maybeSingle();
    $('#homeNotice').value=data?.value||'';
  }catch(e){ console.warn(e); }
}
$('#btnSaveNotice')?.addEventListener('click', async()=>{
  try{
    await sb.from('site_meta').upsert({key:'home_notice', value: $('#homeNotice').value||''},{onConflict:'key'});
    $('#noticeMsg').textContent='已儲存'; setTimeout(()=>$('#noticeMsg').textContent='',1500);
  }catch(e){ alert('儲存失敗：'+e.message); }
});

/* === Runs === */
let runsCache=[], poolRuns=[], normalRuns=[];
function runLabel(r){ return r.title||r.code||r.region||('Run#'+r.id); }

async function loadRuns(){
  try{
    const { data, error }=await sb.from('runs').select('*').order('created_at',{ascending:false});
    if(error) throw error;
    runsCache=data||[];
    poolRuns=runsCache.filter(r=>r.is_pool);
    normalRuns=runsCache.filter(r=>!r.is_pool);
    // products 頁面下拉 + 過濾
    const sel1=$('#pRunAssign'), sel2=$('#prodFilterRun'), sel3=$('#eRunAssign'); // eRunAssign 可能在你的舊檔有
    [sel1,sel2,sel3].forEach(sel=>{
      if(!sel) return;
      if(sel===sel2){ sel.innerHTML='<option value="">全部商品</option>'; }
      else { sel.innerHTML='<option value="">— 選擇連線 —</option>'; }
      runsCache.forEach(r=>{
        const v = (sel===sel2)? r.id : JSON.stringify({id:r.id,title:r.title||''});
        sel.appendChild(new Option(runLabel(r), v));
      });
    });
    // pool tab
    fillPoolSelectors();
    // bulk tab
    fillBulkSelectors();
  }catch(e){ console.warn(e); $('#runsListErr').classList.remove('hidden'); $('#runsListErr').textContent='讀取 runs 失敗：'+e.message; }
}

async function renderRunsTable(){
  try{
    const tb=$('#runsTable tbody'); tb.innerHTML='';
    runsCache.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.title||''}</td>
        <td>${r.region||''}</td>
        <td>${r.start_date||''} ~ ${r.end_date||''}</td>
        <td>${r.ship_start_date||''}</td>
        <td>${r.note||''}</td>
        <td>${r.is_active? '啟用':'停用'}</td>
        <td>${r.is_featured? '✔':''}</td>
        <td>${r.is_pool? '✔':''}</td>
        <td>
          <button class="btn ghost" data-act="edit" data-id="${r.id}">編輯</button>
          <button class="btn ghost" data-act="del" data-id="${r.id}">刪除</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.warn(e); }
}

$('#runsTable')?.addEventListener('click', async(e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id;
  if(btn.dataset.act==='edit'){
    const r=runsCache.find(x=>x.id===id); if(!r) return;
    $('#rTitle').value=r.title||''; $('#rCode').value=r.code||''; $('#rRegion').value=r.region||'';
    $('#rStart').value=r.start_date||''; $('#rEnd').value=r.end_date||''; $('#rShip').value=r.ship_start_date||'';
    $('#rNote').value=r.note||''; $('#rActive').value=String(!!r.is_active); $('#rFeatured').value=String(!!r.is_featured);
    $('#rIsPool').value=String(!!r.is_pool); $('#rTitle').dataset.editId=id;
    alert('已帶入到上方編輯欄');
  }
  if(btn.dataset.act==='del'){
    if(!confirm('確定刪除此連線？（含對應關聯）')) return;
    try{
      const { error }=await sb.from('runs').delete().eq('id',id);
      if(error) throw error;
      await loadRuns(); await renderRunsTable(); alert('已刪除');
    }catch(err){ alert('刪除失敗：'+err.message); }
  }
});

$('#btnRunCreate')?.addEventListener('click', async()=>{
  const payload={
    title:($('#rTitle').value||'').trim(),
    code:($('#rCode').value||'').trim()||null,
    region:($('#rRegion').value||'').trim()||null,
    start_date:$('#rStart').value||null,
    end_date:$('#rEnd').value||null,
    ship_start_date:$('#rShip').value||null,
    note:($('#rNote').value||'').trim()||null,
    is_active:($('#rActive').value==='true'),
    is_featured:($('#rFeatured').value==='true'),
    is_pool:($('#rIsPool').value==='true'),
  };
  if(!payload.title){ alert('請輸入標題'); return; }
  const editId=$('#rTitle').dataset.editId||null;
  try{
    if(editId){
      const { error }=await sb.from('runs').update(payload).eq('id',editId);
      if(error) throw error;
      delete $('#rTitle').dataset.editId;
    }else{
      const { error }=await sb.from('runs').insert(payload);
      if(error) throw error;
    }
    $('#btnRunReset').click();
    await loadRuns(); await renderRunsTable(); alert('已儲存');
  }catch(e){ $('#runsErr').textContent='儲存失敗：'+e.message; }
});
$('#btnRunReset')?.addEventListener('click', ()=>{ ['rTitle','rCode','rRegion','rStart','rEnd','rShip','rNote'].forEach(id=>$('#'+id).value=''); $('#rActive').value='true'; $('#rFeatured').value='false'; $('#rIsPool').value='false'; delete $('#rTitle').dataset.editId; });

/* === Products === */
function priceNT(n){ return n==null? '—' : Math.round(Number(n)); }
function profit(p,c){ if(p==null||c==null) return '—'; return Math.round(Number(p)-Number(c)); }

async function fillCategoryDatalist(){
  try{
    const { data }=await sb.from('products').select('category').not('category','is',null);
    const set=new Set((data||[]).map(x=>x.category).filter(Boolean));
    const dl=$('#categoryList'); dl.innerHTML='';
    Array.from(set).sort((a,b)=>a.localeCompare(b,'zh-Hant')).forEach(c=> dl.appendChild(new Option('',c)));
  }catch(e){ console.warn(e); }
}

async function genNextPid(){
  const d=new Date(), prefix=`P${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-`;
  const { data } = await sb.from('products').select('product_id').ilike('product_id', `${prefix}%`).order('product_id',{ascending:false}).limit(1);
  let seq=1; if(data&&data[0]?.product_id){ const n=parseInt(String(data[0].product_id).split('-').pop().replace(/\D/g,''),10); if(!isNaN(n)) seq=n+1; }
  return prefix+String(seq).padStart(3,'0');
}

function parseTags(s){ const raw=(s||'').trim(); return raw? raw.split(',').map(x=>x.trim()).filter(Boolean):null; }

$('#btnCreateProduct')?.addEventListener('click', async()=>{
  try{
    let pid=($('#pPid').value||'').trim(); if(!pid) pid=await genNextPid();
    let runObj=null; try{ runObj=JSON.parse($('#pRunAssign').value||''); }catch(_){}
    const payload={
      name:($('#pName').value||'').trim(),
      price:$('#pPrice').value?Number($('#pPrice').value):null,
      category:($('#pCategory').value||'').trim()||null, product_id:pid,
      status:($('#pStatus').value||'').trim()||null,
      arrival_time:$('#pArrival').value||null,
      eta_text: ($('#pEta').value||'').trim() || (runObj?.title||null),
      note:($('#pNote').value||'').trim()||null,
      cost_jpy: ($('#pCostCurrency').value==='JPY'? Number($('#pCostForeign').value||0): null),
      cost_nt: $('#pCostNt').value? Number($('#pCostNt').value): null,
      tags: parseTags($('#pTags').value)
    };
    if(!payload.name){ alert('請輸入商品名稱'); return; }
    const { data, error }=await sb.from('products').insert(payload).select(); if(error) throw error;
    const product=data?.[0];
    if(runObj?.id && product?.id){
      await sb.from('product_runs').upsert({product_id:product.id, run_id:runObj.id},{onConflict:'product_id,run_id'});
    }
    ['pName','pPrice','pCategory','pPid','pStatus','pArrival','pEta','pNote','pTags','pCostForeign','pCostNt'].forEach(id=>$('#'+id).value='');
    alert('新增成功'); await fillCategoryDatalist(); await loadProducts();
  }catch(e){ $('#prodErr').classList.remove('hidden'); $('#prodErr').textContent='新增失敗：'+e.message; }
});

$('#prodFilterRun')?.addEventListener('change', e=> loadProducts(e.target.value||null));

async function loadProducts(runFilterId=null){
  try{
    let q=sb.from('products').select('id,name,price,category,product_id,eta_text,cost_jpy,cost_nt').order('created_at',{ascending:false}).limit(50);
    if(runFilterId){
      const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',runFilterId);
      const ids=(pr||[]).map(x=>x.product_id);
      q = ids.length? q.in('id',ids) : q.in('id',['00000000-0000-0000-0000-000000000000']);
    }
    const { data, error }=await q; if(error) throw error;
    const tb=$('#productsTable tbody'); tb.innerHTML='';
    (data||[]).forEach(p=>{
      const costNT=(p.cost_nt!=null)?Number(p.cost_nt):(p.cost_jpy!=null?Number(p.cost_jpy)*RATES.JPY:null);
      const tr=document.createElement('tr'); tr.innerHTML=`
        <td>${p.name||''}</td><td>${p.price??''}</td><td>${p.category||''}</td>
        <td>${p.product_id||''}</td><td>${p.eta_text||''}</td>
        <td>${costNT!=null?priceNT(costNT):'—'}</td><td>${profit(p.price,costNT)}</td>
        <td>
          <button class="btn ghost" data-act="edit" data-id="${p.id}">編輯</button>
          <button class="btn ghost" data-act="del" data-id="${p.id}">刪除</button>
        </td>`;
      tb.appendChild(tr);
    });
  }catch(e){ $('#prodErr').classList.remove('hidden'); $('#prodErr').textContent='讀取失敗：'+e.message; }
}

$('#productsTable')?.addEventListener('click', async(e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id;
  if(btn.dataset.act==='del'){
    if(!confirm('確定刪除此商品？（含對應關聯）')) return;
    try{
      const { error }=await sb.from('products').delete().eq('id',id);
      if(error) throw error;
      await loadProducts($('#prodFilterRun').value||null); alert('已刪除');
    }catch(err){ alert('刪除失敗：'+err.message); }
  }
});

/* === Pool === */
function fillPoolSelectors(){
  try{
    const poolSel=$('#poolSelect'); const targetSel=$('#poolTarget');
    if(poolSel){ poolSel.innerHTML='<option value="">— 選擇 Pool —</option>'; poolRuns.forEach(r=> poolSel.appendChild(new Option(runLabel(r), r.id))); }
    if(targetSel){ targetSel.innerHTML='<option value="">— 選擇目標連線 —</option>'; normalRuns.forEach(r=> targetSel.appendChild(new Option(runLabel(r), r.id))); }
  }catch(e){ console.warn(e); }
}
let poolCheckedAll=false;
$('#poolSelectAll')?.addEventListener('click',()=>{ poolCheckedAll=!poolCheckedAll; $$('.poolItemChk').forEach(c=> c.checked=poolCheckedAll); });

$('#poolSelect')?.addEventListener('change', loadPoolProducts);

async function loadPoolProducts(){
  const poolId=$('#poolSelect').value||null;
  const box=$('#poolList'); if(!poolId){ box.textContent='請先選擇 Pool。'; return; }
  try{
    const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',poolId);
    const ids=(pr||[]).map(x=>x.product_id);
    if(!ids.length){ box.textContent='此 Pool 目前沒有商品'; return; }
    const { data:ps }=await sb.from('products').select('id,name,price,category').in('id',ids).order('created_at',{ascending:false});
    box.innerHTML='';
    (ps||[]).forEach(p=>{
      const div=document.createElement('div'); div.style.cssText='border:1px solid var(--border);border-radius:10px;padding:8px;margin:6px 0;background:#fff';
      div.innerHTML=`<label style="display:flex;gap:8px;align-items:center">
        <input type="checkbox" class="poolItemChk" value="${p.id}"> <strong>${p.name||''}</strong>
        <span class="small">（${p.category||''}，NT$${p.price??''}）</span>
      </label>`;
      box.appendChild(div);
    });
  }catch(e){ $('#poolErr').classList.remove('hidden'); $('#poolErr').textContent='讀取 Pool 失敗：'+e.message; }
}

$('#poolCopy')?.addEventListener('click', async()=>{
  const poolId=$('#poolSelect').value||''; const targetId=$('#poolTarget').value||'';
  if(!poolId||!targetId){ alert('請選 Pool 與目標連線'); return; }
  const ids=[...document.querySelectorAll('.poolItemChk:checked')].map(c=>c.value);
  if(!ids.length){ alert('請先勾選要複製的商品'); return; }
  try{
    const rows=ids.map(pid=>({product_id:pid, run_id:targetId}));
    const { error }=await sb.from('product_runs').upsert(rows,{onConflict:'product_id,run_id'});
    if(error) throw error;
    alert(`已複製 ${ids.length} 件到目標連線`);
  }catch(e){ alert('複製失敗：'+e.message); }
});

/* === Bulk === */
function fillBulkSelectors(){
  try{
    const from=$('#bulkFrom'), to=$('#bulkTo');
    [from,to].forEach(sel=>{ sel.innerHTML='<option value="">— 選擇 —</option>'; runsCache.forEach(r=> sel.appendChild(new Option(runLabel(r), r.id))); });
  }catch(e){ console.warn(e); }
}
let bulkPreviewCount=0;
$('#bulkPreview')?.addEventListener('click', async()=>{
  try{
    const from=$('#bulkFrom').value||''; const scope=$('#bulkScope').value;
    if(!from){ alert('請選來源'); return; }
    const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',from);
    const ids=(pr||[]).map(x=>x.product_id);
    bulkPreviewCount=ids.length;
    $('#bulkInfo').textContent=`預計複製 ${bulkPreviewCount} 件。`;
  }catch(e){ $('#bulkErr').classList.remove('hidden'); $('#bulkErr').textContent='預覽失敗：'+e.message; }
});
$('#bulkDo')?.addEventListener('click', async()=>{
  try{
    const from=$('#bulkFrom').value||''; const to=$('#bulkTo').value||'';
    if(!bulkPreviewCount||!to){ alert('請先預覽且選目標'); return; }
    const { data:pr }=await sb.from('product_runs').select('product_id').eq('run_id',from);
    const ids=(pr||[]).map(x=>x.product_id);
    const rows=ids.map(pid=>({product_id:pid, run_id:to}));
    const { error }=await sb.from('product_runs').upsert(rows,{onConflict:'product_id,run_id'});
    if(error) throw error;
    alert(`已複製 ${ids.length} 件到目標連線`); $('#bulkInfo').textContent='';
  }catch(e){ $('#bulkErr').classList.remove('hidden'); $('#bulkErr').textContent='執行失敗：'+e.message; }
});

/* === Wishes（若尚未建表也不會讓整頁掛） === */
async function loadWishes(){
  const tb=$('#wishesTable tbody'); tb.innerHTML='';
  try{
    // 這裡先嘗試讀取（若沒有這張表，會進 catch）
    const { data, error }=await sb.from('wishes')
      .select('id,created_at,run_id,category,title,url,content,image_path,status')
      .order('created_at',{ascending:false});
    if(error) throw error;
    const runsById = Object.fromEntries((runsCache||[]).map(r=>[r.id, r]));
    (data||[]).forEach(w=>{
      const tr=document.createElement('tr');
      const run = runsById[w.run_id];
      tr.innerHTML=`
        <td class="small">${w.created_at?.slice(0,16).replace('T',' ')||''}</td>
        <td>${run? runLabel(run): '—'}</td>
        <td>${w.category||''}</td>
        <td>${w.title||''}</td>
        <td>${w.url? `<a href="${w.url}" target="_blank">連結</a>`:''}</td>
        <td class="small">${w.content||''}</td>
        <td>${w.image_path? `<a href="${publicUrlFromPath(w.image_path)}" target="_blank">圖片</a>`:''}</td>
        <td>${w.status||'pending'}</td>
        <td><button class="btn ghost" data-act="w-del" data-id="${w.id}">刪除</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){
    $('#wishesErr').classList.remove('hidden');
    $('#wishesErr').innerHTML='讀取 wishes 失敗（若尚未建立此表可忽略）：<br><span class="mono">'+e.message+'</span>';
  }
}
$('#wishesTable')?.addEventListener('click', async(e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  if(btn.dataset.act==='w-del'){
    if(!confirm('確定刪除這筆許願單？')) return;
    try{
      const { error }=await sb.from('wishes').delete().eq('id',btn.dataset.id);
      if(error) throw error;
      await loadWishes(); alert('已刪除');
    }catch(err){ alert('刪除失敗：'+err.message); }
  }
});

/* === 首次進入：預設打開 Products 分頁，並初始化需要的資料 === */
(async function init(){
  try{
    await loadRates();
    await loadRuns();
    await fillCategoryDatalist();
    await loadProducts();
  }catch(e){
    console.warn('初始化時發生錯誤，不影響分頁切換；具體錯誤：', e);
  }
})();
</script>
</body>
</html>
