<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>商品後台管理</title>
  <style>
    :root{
      --bg:#f5f3ef;--panel:#ffffff;--ink:#2f2f2f;--muted:#6b6a62;--line:#e6e2da;--accent:#c2a35d;--danger:#b42318
    }
    *{box-sizing:border-box}
    body{margin:20px;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",sans-serif}
    h1,h2{margin:0 0 12px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:14px}
    input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .btn{display:inline-block;padding:8px 14px;border-radius:999px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border:none}
    .btn.danger{background:var(--danger);color:#fff;border:none}
    .toolbar{display:flex;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    /* 預覽區 */
    #image-preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .preview{position:relative;border:1px solid var(--line);border-radius:10px;padding:6px}
    .preview.drag-over{outline:2px dashed #333}
    .preview img{width:110px;height:110px;object-fit:cover;display:block;border-radius:6px}
    .preview .rm{position:absolute;top:2px;right:6px;border:none;background:#fff;padding:0 6px;border-radius:999px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid var(--line);padding:8px;text-align:left}
    th{background:#f9f7f2;cursor:pointer}
    td.actions{white-space:nowrap}
  </style>
</head>
<body>
  <h1>商品後台管理</h1>

  <!-- 登入 -->
  <div class="card" id="loginCard">
    <h2>管理員登入</h2>
    <label>Email</label>
    <input id="loginEmail" type="email" placeholder="your@email"/>
    <label>密碼</label>
    <input id="loginPass" type="password" placeholder="至少 8 碼"/>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="btnLogin" class="btn primary">登入</button>
      <button id="btnSignup" class="btn">註冊（第一次使用）</button>
    </div>
    <p class="muted" style="margin-top:8px">僅允許管理者帳號登入與操作。</p>
  </div>

  <!-- 後台 -->
  <div class="card" id="adminCard" style="display:none">
    <div class="toolbar">
      <h2 id="formTitle">新增商品</h2>
      <div>
        <span id="who" class="muted" style="margin-right:8px"></span>
        <button id="btnLogout" class="btn">登出</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>商品名稱</label>
          <input id="name"/>
        </div>
        <div>
          <label>商品編號（SKU）</label>
          <input id="pid" placeholder="例：A001"/>
        </div>
      </div>

      <div class="row">
        <div>
          <label>價格（整數）</label>
          <input id="price" type="number" min="0"/>
        </div>
        <div>
          <label>分類</label>
          <select id="category">
            <option>香氛</option><option>藥妝</option><option>MUJI</option>
            <option>御守 & 淨化噴霧</option><option>超商</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>狀態</label>
          <select id="status">
            <option>現貨</option><option>預購</option>
          </select>
        </div>
        <div>
          <label>到貨（例：2–4 天 / 約 10–14 天）</label>
          <input id="arrival"/>
        </div>
      </div>

      <label>標籤（用 | 分隔，如：熱賣|送禮）</label>
      <input id="tags"/>

      <label>商品圖片（可多張，拖曳排序；第一張=封面）</label>
      <div id="image-preview"></div>
      <input id="file" type="file" accept="image/*" multiple style="display:none"/>
      <div style="margin-top:8px">
        <label for="file" class="btn">新增圖片</label>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="btnSave" class="btn primary">儲存商品</button>
        <button id="btnCancel" class="btn" style="display:none">取消編輯</button>
        <button id="btnDelete" class="btn danger" style="display:none">刪除</button>
      </div>
    </div>

    <div class="card">
      <div class="toolbar">
        <strong>商品清單</strong>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="kw" placeholder="搜尋 名稱/編號/標籤" style="width:240px"/>
          <button id="btnReload" class="btn">重新整理</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>縮圖</th><th>名稱</th><th>編號</th><th>價格</th>
            <th>分類</th><th>狀態</th><th>到貨</th><th>標籤</th>
            <th id="thCreated">上架時間 ▲</th><th>操作</th>
          </tr>
        </thead>
        <tbody id="grid"></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // ===== Supabase 設定 =====
  const SUPABASE_URL = "https://yuyu.f86.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB";
  const ADMIN_EMAIL = "lelouvre.yu@gmail.com";
  const BUCKET = "yuyu.f86";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ===== DOM =====
  const loginCard = document.getElementById('loginCard');
  const adminCard = document.getElementById('adminCard');
  const who = document.getElementById('who');

  const loginEmail = document.getElementById('loginEmail');
  const loginPass = document.getElementById('loginPass');
  const btnLogin = document.getElementById('btnLogin');
  const btnSignup = document.getElementById('btnSignup');
  const btnLogout = document.getElementById('btnLogout');

  const formTitle = document.getElementById('formTitle');
  const nameEl = document.getElementById('name');
  const pidEl = document.getElementById('pid');
  const priceEl = document.getElementById('price');
  const catEl = document.getElementById('category');
  const statusEl = document.getElementById('status');
  const arrivalEl = document.getElementById('arrival');
  const tagsEl = document.getElementById('tags');

  const fileEl = document.getElementById('file');
  const preview = document.getElementById('image-preview');

  const btnSave = document.getElementById('btnSave');
  const btnCancel = document.getElementById('btnCancel');
  const btnDelete = document.getElementById('btnDelete');

  const kwEl = document.getElementById('kw');
  const btnReload = document.getElementById('btnReload');
  const thCreated = document.getElementById('thCreated');
  const grid = document.getElementById('grid');

  // ===== 狀態 =====
  let editingId = null;           // 正在編輯的 row.id（null=新增）
  let images = [];                // [{new:boolean,file?,path?,url}]
  let oldImagePaths = [];         // 編輯前的舊路徑（用來比對刪除）
  let allRows = [];               // 資料列
  let sortAsc = false;            // 上架時間排序

  // ===== Auth =====
  async function refreshAuth(){
    const { data:{ user } } = await sb.auth.getUser();
    if(user && user.email === ADMIN_EMAIL){
      who.textContent = user.email;
      loginCard.style.display = 'none';
      adminCard.style.display = '';
      loadRows();
    }else{
      who.textContent = '';
      adminCard.style.display = 'none';
      loginCard.style.display = '';
    }
  }
  btnLogin.onclick = async()=>{
    const { error } = await sb.auth.signInWithPassword({ email:loginEmail.value, password:loginPass.value });
    if(error) return alert(error.message);
    refreshAuth();
  };
  btnSignup.onclick = async()=>{
    const { error } = await sb.auth.signUp({ email:loginEmail.value, password:loginPass.value });
    if(error) return alert(error.message);
    alert('註冊成功，請到信箱驗證後再登入');
  };
  btnLogout.onclick = async()=>{ await sb.auth.signOut(); refreshAuth(); };

  // ===== 表單 =====
  function resetForm(){
    editingId = null;
    formTitle.textContent = '新增商品';
    btnSave.textContent = '儲存商品';
    btnCancel.style.display = 'none';
    btnDelete.style.display = 'none';

    nameEl.value = '';
    pidEl.value = '';
    priceEl.value = '';
    catEl.value = '香氛';
    statusEl.value = '現貨';
    arrivalEl.value = '';
    tagsEl.value = '';

    images = [];
    oldImagePaths = [];
    renderPreviews();
  }
  btnCancel.onclick = resetForm;

  // 圖片預覽
  function renderPreviews(){
    preview.innerHTML = '';
    images.forEach((img, idx)=>{
      const box = document.createElement('div');
      box.className = 'preview';
      box.draggable = true;
      box.dataset.idx = idx;

      const im = document.createElement('img');
      im.src = img.url || '';
      box.appendChild(im);

      const rm = document.createElement('button');
      rm.className = 'rm';
      rm.textContent = '×';
      rm.onclick = ()=>{
        if(img.new && img.url) URL.revokeObjectURL(img.url);
        images.splice(idx,1);
        renderPreviews();
      };
      box.appendChild(rm);

      box.addEventListener('dragstart', e=>{
        e.dataTransfer.setData('text/plain', idx);
      });
      box.addEventListener('dragover', e=>{ e.preventDefault(); box.classList.add('drag-over'); });
      box.addEventListener('dragleave', ()=> box.classList.remove('drag-over'));
      box.addEventListener('drop', e=>{
        e.preventDefault();
        box.classList.remove('drag-over');
        const from = parseInt(e.dataTransfer.getData('text/plain'));
        if(isNaN(from) || from===idx) return;
        const item = images.splice(from,1)[0];
        images.splice(idx,0,item);
        renderPreviews();
      });

      preview.appendChild(box);
    });
  }
  fileEl.onchange = ()=>{
    const files = Array.from(fileEl.files||[]);
    for(const f of files){
      const url = URL.createObjectURL(f);
      images.push({ new:true, file:f, url });
    }
    fileEl.value = '';
    renderPreviews();
  };

  // ===== CRUD =====
  function pubUrl(path){
    const { data } = sb.storage.from(BUCKET).getPublicUrl(path);
    return data.publicUrl;
  }

  async function uploadNewImages(pid){
    const paths = [];
    for(const img of images){
      if(img.new){
        const ext = (img.file.name.split('.').pop()||'jpg').toLowerCase();
        const name = `${pid}-${Date.now()}-${Math.random().toString(36).slice(2,7)}.${ext}`;
        const path = `${pid}/${name}`;
        const { error } = await sb.storage.from(BUCKET).upload(path, img.file, { upsert:false });
        if(error) throw error;
        paths.push(path);
      }else{
        paths.push(img.path); // 保留舊圖
      }
    }
    return paths;
  }

  async function deleteRemovedImages(newPaths){
    // 刪掉編輯前有、但現在已移除的圖片
    const removed = oldImagePaths.filter(p=>!newPaths.includes(p));
    if(removed.length){
      await sb.storage.from(BUCKET).remove(removed.map(p=>({ path:p })));
    }
  }

  btnSave.onclick = async()=>{
    // 檢查
    const name = nameEl.value.trim();
    const pid = (pidEl.value||'').trim();
    const price = Number(priceEl.value||0);
    if(!name || !pid || isNaN(price)) return alert('請填「名稱 / 編號 / 價格」');
    // 上傳新圖並組路徑
    let newPaths;
    try{
      newPaths = await uploadNewImages(pid);
    }catch(err){
      console.error(err);
      return alert('圖片上傳失敗：'+(err?.message||err));
    }
    // 封面 img_url（第一張）+ eta 相容
    const coverUrl = newPaths[0] ? pubUrl(newPaths[0]) : null;
    const etaText = (arrivalEl.value||'').trim();

    const row = {
      name,
      product_id: pid,
      price,
      category: catEl.value,
      status: statusEl.value,
      arrival_time: etaText,
      eta: etaText,             // 舊前台相容
      tags: (tagsEl.value||'').trim(),
      images: newPaths,
      img_url: coverUrl         // 舊前台封面
    };

    if(editingId){
      const { error } = await sb.from('products').update(row).eq('id', editingId);
      if(error) return alert(error.message);
      await deleteRemovedImages(newPaths);
      alert('已更新');
    }else{
      const { error } = await sb.from('products').insert(row);
      if(error) return alert(error.message);
      alert('已新增');
    }
    resetForm();
    loadRows();
  };

  btnDelete.onclick = async()=>{
    if(!editingId) return;
    if(!confirm('確定要刪除此商品？')) return;
    // 同步刪除所有圖片
    if(oldImagePaths.length){
      await sb.storage.from(BUCKET).remove(oldImagePaths.map(p=>({path:p})));
    }
    const { error } = await sb.from('products').delete().eq('id', editingId);
    if(error) return alert(error.message);
    alert('已刪除');
    resetForm();
    loadRows();
  };

  // 列表
  let sortCacheAsc = false;
  function filteredSortedRows(){
    const k = (kwEl.value||'').toLowerCase();
    let list = allRows.filter(r=>{
      const hay = `${r.name||''} ${r.product_id||''} ${r.tags||''}`.toLowerCase();
      return !k || hay.includes(k);
    });
    if(sortAsc){
      list.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
    }else{
      list.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
    }
    sortCacheAsc = sortAsc;
    return list;
  }

  function renderRows(){
    const rows = filteredSortedRows();
    grid.innerHTML = rows.map(r=>{
      const firstPath = (r.images&&r.images[0]) || null;
      const thumb = firstPath ? `<img src="${pubUrl(firstPath)}" style="width:46px;height:46px;object-fit:cover;border-radius:6px"/>` : '';
      const created = r.created_at ? new Date(r.created_at).toLocaleString('zh-TW',{hour12:false}) : '';
      return `<tr data-id="${r.id}">
        <td>${thumb}</td>
        <td>${r.name||''}</td>
        <td>${r.product_id||''}</td>
        <td>${Number(r.price||0).toLocaleString('zh-TW')}</td>
        <td>${r.category||''}</td>
        <td>${r.status||''}</td>
        <td>${r.arrival_time||''}</td>
        <td>${r.tags||''}</td>
        <td>${created}</td>
        <td class="actions">
          <button class="btn" data-act="edit">編輯</button>
          <button class="btn" data-act="copy">複製</button>
          <button class="btn danger" data-act="del">刪除</button>
        </td>
      </tr>`;
    }).join('');
    // 綁定操作
    grid.querySelectorAll('tr').forEach(tr=>{
      const id = tr.getAttribute('data-id');
      tr.querySelectorAll('[data-act]').forEach(btn=>{
        btn.onclick = ()=>{
          const act = btn.getAttribute('data-act');
          const row = allRows.find(x=>x.id===id);
          if(!row) return;
          if(act==='edit') startEdit(row);
          else if(act==='copy') doCopy(row);
          else if(act==='del') { editingId=row.id; btnDelete.click(); }
        }
      });
    });
  }

  async function loadRows(){
    const { data, error } = await sb.from('products')
      .select('id,name,product_id,price,category,status,arrival_time,eta,tags,images,img_url,created_at')
      .order('created_at',{ascending:false});
    if(error){ alert(error.message); return; }
    allRows = data||[];
    renderRows();
  }

  function startEdit(r){
    editingId = r.id;
    formTitle.textContent = '編輯商品';
    btnSave.textContent = '更新商品';
    btnCancel.style.display = '';
    btnDelete.style.display = '';

    nameEl.value = r.name||'';
    pidEl.value = r.product_id||'';
    priceEl.value = r.price||'';
    catEl.value = r.category||'香氛';
    statusEl.value = r.status||'現貨';
    const eta = r.arrival_time || r.eta || '';
    arrivalEl.value = eta;
    tagsEl.value = r.tags||'';

    images = [];
    oldImagePaths = Array.isArray(r.images) ? r.images.slice() : [];
    if(oldImagePaths.length){
      for(const p of oldImagePaths){
        images.push({ new:false, path:p, url:pubUrl(p) });
      }
    }else if(r.img_url){
      // 只有舊欄位封面圖時，轉成 images
      images.push({ new:false, path:null, url:r.img_url });
    }
    renderPreviews();
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  function doCopy(r){
    editingId = null;
    formTitle.textContent = '複製商品（新增）';
    btnSave.textContent = '儲存商品';
    btnCancel.style.display = '';

    nameEl.value = r.name||'';
    pidEl.value = r.product_id||'';
    priceEl.value = r.price||'';
    catEl.value = r.category||'香氛';
    statusEl.value = r.status||'現貨';
    const eta = r.arrival_time || r.eta || '';
    arrivalEl.value = eta;
    tagsEl.value = r.tags||'';

    images = [];
    oldImagePaths = []; // 複製時不視為舊圖
    if(Array.isArray(r.images) && r.images.length){
      for(const p of r.images){
        images.push({ new:false, path:p, url:pubUrl(p) });
      }
    }else if(r.img_url){
      images.push({ new:false, path:null, url:r.img_url });
    }
    renderPreviews();
    pidEl.focus(); pidEl.select();
    window.scrollTo({ top:0, behavior:'smooth' });
  }

  // 事件
  kwEl.oninput = renderRows;
  btnReload.onclick = loadRows;
  thCreated.onclick = ()=>{
    sortAsc = !sortAsc;
    thCreated.textContent = sortAsc ? '上架時間 ▼' : '上架時間 ▲';
    renderRows();
  };

  // 啟動
  refreshAuth();
  </script>
</body>
</html>
