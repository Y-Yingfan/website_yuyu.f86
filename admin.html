<!-- 直接覆蓋你的 admin.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>後台｜連線與商品管理</title>
<style>
:root{--bg:#f7f3ef;--paper:#fffdf9;--card:#fff;--ink:#2b2b2b;--muted:#7a7267;--brand:#8B5E34;--border:#eadfcd;--shadow:0 10px 24px rgba(139,94,52,.08);--radius:14px;--maxw:1080px}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#f8f5f1 0%,var(--bg) 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC","Microsoft JhengHei",Arial}
.wrap{max-width:var(--maxw);margin:20px auto;padding:0 16px}
h1{margin:6px 0 14px}.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tabbtn{border:1px solid var(--border);background:#fffdf9;border-radius:999px;padding:8px 14px;cursor:pointer}
.tabbtn.active{background:var(--brand);color:#fff;border-color:transparent}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:14px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media (max-width:860px){.row{grid-template-columns:1fr}}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fffdfa}
textarea{min-height:72px}.btn{border:none;background:var(--brand);color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid var(--border);color:#2b2b2b}
.list{width:100%;border-collapse:collapse}.list th,.list td{border-top:1px solid var(--border);padding:8px;vertical-align:top}
.list th{background:#fffaf2;text-align:left;font-weight:700}
.muted{color:var(--muted)}.small{font-size:12px}
.uploader{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fff}
.previews{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.preview{position:relative;width:100px;height:100px;background:#f3efe9;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.preview img{max-width:100%;max-height:100%;object-fit:contain}
.preview button{position:absolute;top:4px;right:4px;border:none;background:#000a;color:#fff;border-radius:6px;padding:2px 6px;cursor:pointer;font-size:12px}
.badge{display:inline-block;border:1px solid var(--border);padding:3px 8px;border-radius:999px;font-size:12px;background:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
.card{border:1px solid var(--border);border-radius:10px;background:#fff;padding:10px}
.card .muted{font-size:12px}
/* Modal */
.modal{display:none;position:fixed;inset:0;z-index:1000}
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.45)}
.sheet{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(980px,92vw);max-height:90vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px}
.sheet h3{margin:0 0 8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>後台｜連線與商品管理 <span class="badge">Supabase</span></h1>

  <div class="tabs">
    <button class="tabbtn active" data-tab="products">Products</button>
    <button class="tabbtn" data-tab="runs">Runs</button>
    <button class="tabbtn" data-tab="pool">Pool 派送</button>
    <button class="tabbtn" data-tab="bulk">Bulk Move</button>
    <button class="tabbtn" data-tab="wishes">Wishes</button>
    <button class="tabbtn" data-tab="settings">Settings</button>
  </div>

  <!-- 你原本的 Products / Runs / Pool / Bulk / Settings 保留（此處省略，沿用你現有檔案內容） -->

  <!-- ===== Wishes：新分頁 ===== -->
  <section id="tab-wishes" style="display:none">
    <div class="panel">
      <h3 style="margin:0 0 8px">許願單管理</h3>
      <div class="row">
        <div>
          <label>狀態過濾</label>
          <select id="wishStatus">
            <option value="">全部</option>
            <option>new</option>
            <option>reviewed</option>
            <option>approved</option>
            <option>closed</option>
          </select>
        </div>
        <div>
          <label>連線過濾</label>
          <select id="wishRun"><option value="">全部連線</option></select>
        </div>
      </div>
    </div>

    <div class="panel">
      <table class="list" id="wishesTable">
        <thead>
          <tr>
            <th style="width:110px">時間</th>
            <th>連線</th>
            <th>分類</th>
            <th>商品</th>
            <th>網址</th>
            <th>內容</th>
            <th>圖片</th>
            <th style="width:120px">狀態</th>
            <th style="width:220px">回覆 / 操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl='https://llbpmqyjigovxixeohzr.supabase.co';
const supabaseKey='sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB';
const BUCKET='yuyu.f86';
const sb=supabase.createClient(supabaseUrl,supabaseKey);

// Tabs 切換
document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('section[id^="tab-"]').forEach(s=>s.style.display='none');
    document.getElementById('tab-'+btn.dataset.tab).style.display='block';
  };
});

// 讀 runs（供過濾）
let runsCache=[];
async function loadRunsForWishes(){
  const { data }=await sb.from('runs')
    .select('id,title,code,region,start_date,end_date,is_pool')
    .order('start_date',{ascending:false});
  runsCache=data||[];
  const wRun=document.getElementById('wishRun');
  wRun.innerHTML='<option value="">全部連線</option>';
  runsCache.forEach(r=>{
    const opt=document.createElement('option');
    const title=[r.title||r.code||r.region,[r.start_date||'',r.end_date||''].filter(Boolean).join(' ~ ')].filter(Boolean).join('｜');
    opt.value=r.id; opt.textContent=title;
    wRun.appendChild(opt);
  });
}

function wishImg(path){
  if(!path) return '';
  const { data }=sb.storage.from(BUCKET).getPublicUrl(path);
  const url=data?.publicUrl||'';
  return url? `<a href="${url}" target="_blank">檢視</a>`:'';
}

async function loadWishes(){
  let q=sb.from('wishes').select('*').order('created_at',{ascending:false});
  const st=document.getElementById('wishStatus').value||'';
  const r=document.getElementById('wishRun').value||'';
  if(st) q=q.eq('status',st);
  if(r) q=q.eq('run_id',r);
  const { data, error }=await q;
  if(error){ alert('讀取失敗：'+error.message); return; }
  const tb=document.querySelector('#wishesTable tbody');
  tb.innerHTML='';
  (data||[]).forEach(w=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${new Date(w.created_at).toLocaleString('zh-TW',{hour12:false})}</td>
      <td>${w.run_title_cache||''}</td>
      <td>${w.category||''}</td>
      <td>${w.name||''}</td>
      <td>${w.url? `<a href="${w.url}" target="_blank">連結</a>`:''}</td>
      <td>${w.content||''}</td>
      <td>${wishImg(w.image_path)}</td>
      <td>
        <select data-id="${w.id}" class="wishStatusRow">
          ${['new','reviewed','approved','closed'].map(s=>`<option ${w.status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td>
        <textarea class="wishReplyRow" data-id="${w.id}" placeholder="回覆內容" style="margin-bottom:6px">${w.admin_reply||''}</textarea>
        <div style="display:flex;gap:6px">
          <button class="btn ghost" onclick="saveWish('${w.id}')">儲存</button>
          <button class="btn ghost" onclick="delWish('${w.id}')">刪除</button>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  });
}

window.saveWish=async(id)=>{
  const st= document.querySelector(`select.wishStatusRow[data-id="${id}"]`)?.value||null;
  const reply= document.querySelector(`textarea.wishReplyRow[data-id="${id}"]`)?.value||null;
  const payload={ status:st, admin_reply:reply, reply_at: (reply? new Date().toISOString(): null) };
  const { error }=await sb.from('wishes').update(payload).eq('id',id);
  if(error){ alert('儲存失敗：'+error.message); return; }
  alert('已儲存'); await loadWishes();
};

window.delWish=async(id)=>{
  if(!confirm('確定要刪除這筆許願？')) return;
  const { error }=await sb.from('wishes').delete().eq('id',id);
  if(error){ alert('刪除失敗：'+error.message); return; }
  alert('已刪除'); await loadWishes();
};

document.getElementById('wishStatus').addEventListener('change',loadWishes);
document.getElementById('wishRun').addEventListener('change',loadWishes);

// 啟動（切到 Wishes 再載）
document.querySelector('button[data-tab="wishes"]').addEventListener('click', async ()=>{
  await loadRunsForWishes(); await loadWishes();
});
</script>
</body>
</html>
