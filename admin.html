<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>商品後台管理</title>
  <style>
    body { background: #f5f5f5; font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "Microsoft JhengHei", sans-serif; color: #333; margin: 0; padding: 20px; }
    h1 { text-align: center; }

    /* Login */
    #login-section { display: none; max-width: 420px; background: #fff; padding: 20px; margin: 80px auto; border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,.08) }
    #login-section h2 { margin-top: 0; text-align: center; }
    label { display:block; margin:.6em 0 .25em; font-weight:600 }
    input,select,textarea{ width:100%; padding:.55em .7em; border:1px solid #dcdcdc; border-radius:10px; box-sizing:border-box }
    .note{ font-size:.9em; color:#666 }
    .error{ color:#b42318; margin-top:.25em }
    .success{ color:#2c7a47; margin-top:.25em }
    button{ padding:.6em 1em; border:none; border-radius:999px; cursor:pointer }
    #login-btn{ background:#2f6fed; color:#fff; margin-right:.6em }
    #signup-btn{ background:#fff; color:#2f6fed; border:1px solid #dcdcdc }

    /* Admin */
    #admin-section{ display:none }
    .header{ display:flex; justify-content:space-between; align-items:center; margin:16px 0 }
    #logout-btn{ background:#eee }
    .toolbar{ display:flex; justify-content:space-between; align-items:center; margin:12px 0 }
    .toolbar .left{ display:flex; gap:8px; align-items:center }
    #search-input{ width:240px }

    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 10px 24px rgba(0,0,0,.06) }
    th,td{ padding:10px 12px; border-bottom:1px solid #eee; text-align:left }
    th{ background:#fafafa; font-weight:700 }
    tr:nth-child(even){ background:#fcfcfc }
    td.price-cell{ text-align:right }
    .action-btn{ background:#eee; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; margin-right:6px }
    .delete-btn{ background:#b42318; color:#fff }

    /* Modal */
    #product-form-modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:100; align-items:center; justify-content:center }
    #product-form-modal .form-container{ width:min(680px,92%); max-height:90%; overflow:auto; background:#fff; border-radius:14px; box-shadow:0 20px 40px rgba(0,0,0,.18); padding:18px }
    #product-form-modal h2{ text-align:center; margin:6px 0 10px }
    .images-preview{ display:flex; flex-wrap:wrap; gap:10px; margin:.5em 0 1em }
    .img-item{ position:relative }
    .img-item img{ width:110px; height:110px; object-fit:cover; border:1px solid #ddd; border-radius:10px }
    .remove-btn{ position:absolute; top:-6px; right:-6px; width:22px; height:22px; border-radius:50%; background:#111; color:#fff; border:none; cursor:pointer }
    .form-actions{ text-align:center; margin-top:10px }
    .form-actions button{ margin:0 8px }
  </style>
</head>
<body>
  <h1>商品後台管理</h1>

  <!-- Login -->
  <div id="login-section">
    <h2>管理員登入</h2>
    <label for="login-email">Email</label>
    <input type="email" id="login-email" placeholder="電子郵件地址" />
    <label for="login-password">密碼 <small style="font-weight:400;color:#777">至少 8 碼</small></label>
    <input type="password" id="login-password" />
    <div id="login-message" class="success"></div>
    <div id="login-error" class="error"></div>
    <div style="margin-top:8px">
      <button id="login-btn">登入</button>
      <button id="signup-btn">註冊（第一次使用）</button>
    </div>
    <p class="note">僅允許管理者帳號登入與操作。</p>
  </div>

  <!-- Admin -->
  <div id="admin-section">
    <div class="header">
      <h2>商品管理</h2>
      <button id="logout-btn">登出</button>
    </div>
    <div class="toolbar">
      <div class="left">
        <input id="search-input" placeholder="搜尋名稱、標籤、編號" />
        <select id="sort-select">
          <option value="desc">上架時間：最新優先</option>
          <option value="asc">上架時間：最舊優先</option>
        </select>
      </div>
      <button id="add-btn" class="action-btn">新增商品</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>名稱</th><th>編號</th><th>價格</th><th>分類</th><th>狀態</th><th>標籤</th><th>操作</th>
        </tr>
      </thead>
      <tbody id="products-tbody"></tbody>
    </table>
  </div>

  <!-- Modal Form -->
  <div id="product-form-modal">
    <div class="form-container">
      <form id="product-form">
        <h2 id="form-title">新增商品</h2>
        <div id="form-error" class="error"></div>

        <label>商品名稱</label>
        <input id="name" required />
        <label>商品編號</label>
        <input id="product_id" required />
        <label>價格</label>
        <input id="price" type="number" required />
        <label>分類</label>
        <input id="category" />
        <label>狀態</label>
        <input id="status" />
        <label>到貨時間</label>
        <input id="arrival_time" />
        <label>到貨說明（資料表欄位：eta）</label>
        <input id="eta_text" />
        <label>標籤 <small style="font-weight:400;color:#777">以「|」分隔：熱賣|送禮</small></label>
        <input id="tags" />

        <label>商品圖片 <small style="font-weight:400;color:#777">可上傳多張，拖曳排序</small></label>
        <input id="image-input" type="file" accept="image/*" multiple />
        <div id="images-preview-list" class="images-preview"></div>

        <div class="form-actions">
          <button id="save-btn" type="submit">儲存</button>
          <button id="cancel-btn" type="button">取消</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
  <script>
    // ==== Supabase Config (已替你放入目前專案的 URL/Key) ====
    const SUPABASE_URL = 'https://yuyu.f86.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_fLryqSfqfQW5c8SD6umiJA_2YfoAthB'; // 建議改成環境變數
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // 僅允許此 Email 註冊/登入
    const allowedEmail = 'lelouvre.yu@gmail.com';

    // ==== Elements ====
    const loginSection = document.getElementById('login-section');
    const adminSection = document.getElementById('admin-section');
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginMsg = document.getElementById('login-message');
    const loginErr = document.getElementById('login-error');

    const searchInput = document.getElementById('search-input');
    const sortSelect = document.getElementById('sort-select');
    const addBtn = document.getElementById('add-btn');
    const tbody = document.getElementById('products-tbody');

    const modal = document.getElementById('product-form-modal');
    const form = document.getElementById('product-form');
    const formTitle = document.getElementById('form-title');
    const formErr = document.getElementById('form-error');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const imageInput = document.getElementById('image-input');
    const preview = document.getElementById('images-preview-list');

    let products = [];
    let formMode = 'add'; // add | edit | copy
    let editingId = null;
    let images = []; // {file?, path?, url}
    let imagesToRemove = [];

    // 初始：如果沒有 session → 顯示登入
    sb.auth.getSession().then(({ data:{ session } }) => {
      if (session) showAdmin(); else showLogin();
    });

    function showLogin(){ loginSection.style.display='block'; adminSection.style.display='none'; loginEmail.focus(); }
    function showAdmin(){ loginSection.style.display='none'; adminSection.style.display='block'; loadProducts(); }

    // ===== Auth =====
    loginBtn.onclick = async () => {
      loginErr.textContent = ''; loginMsg.textContent='';
      const email = (loginEmail.value||'').trim();
      const pw = loginPassword.value;
      if (!email || !pw) return loginErr.textContent='請輸入 Email 與密碼';
      if (email.toLowerCase() !== allowedEmail.toLowerCase()) return loginErr.textContent='僅允許指定 Email 登入';
      loginBtn.disabled = signupBtn.disabled = true;
      try {
        const { data, error } = await sb.auth.signInWithPassword({ email, password: pw });
        if (error) throw error;
        showAdmin();
      } catch(e){
        loginErr.textContent = '登入失敗：' + (e?.message||e);
      } finally{ loginBtn.disabled = signupBtn.disabled = false; }
    };

    signupBtn.onclick = async () => {
      loginErr.textContent=''; loginMsg.textContent='';
      const email = (loginEmail.value||'').trim();
      const pw = loginPassword.value;
      if (!email || !pw) return loginErr.textContent='請輸入 Email 與密碼';
      if (email.toLowerCase() !== allowedEmail.toLowerCase()) return loginErr.textContent='僅允許指定 Email 註冊';
      if (pw.length < 8) return loginErr.textContent='密碼至少 8 碼';
      signupBtn.disabled = loginBtn.disabled = true;
      try{
        // 設定 redirect，避免 GitHub Pages 造成 Failed to fetch
        const redirectTo = location.origin + location.pathname; // 目前頁面
        const { data, error } = await sb.auth.signUp({ email, password: pw, options:{ emailRedirectTo: redirectTo }});
        if (error) throw error;
        if (!data.session){
          loginMsg.textContent = '註冊成功！請到 Email 點擊驗證連結後再登入。';
        } else {
          showAdmin();
        }
      }catch(e){
        loginErr.textContent = '註冊失敗：' + (e?.message||e);
      }finally{ signupBtn.disabled = loginBtn.disabled = false; }
    };

    logoutBtn.onclick = async ()=>{ await sb.auth.signOut(); showLogin(); };

    // ===== Products =====
    async function loadProducts(){
      const { data, error } = await sb.from('products').select('*').order('created_at', { ascending:false });
      if (error){ console.error(error); return; }
      products = data || [];
      renderList();
    }

    function renderList(){
      const q = (searchInput.value||'').toLowerCase().trim();
      const s = sortSelect.value;
      let list = products.filter(p=>{
        const name = (p.name||'').toLowerCase();
        const pid = (p.product_id||'').toLowerCase();
        const tags = (p.tags||'').toLowerCase(); // 後台改為字串欄位，用 | 分隔
        return !q || name.includes(q) || pid.includes(q) || tags.includes(q);
      });
      list.sort((a,b)=>{
        const A = new Date(a.created_at).getTime();
        const B = new Date(b.created_at).getTime();
        return s==='asc'? A-B : B-A;
      });
      tbody.innerHTML = list.map(p=>{
        const tags = (p.tags||'');
        return `<tr>
          <td>${escape(p.name)}</td>
          <td>${escape(p.product_id)}</td>
          <td class="price-cell">${p.price??''}</td>
          <td>${escape(p.category||'')}</td>
          <td>${escape(p.status||'')}</td>
          <td>${escape(tags)}</td>
          <td>
            <button class="action-btn edit" data-id="${p.id}">編輯</button>
            <button class="action-btn copy" data-id="${p.id}">複製</button>
            <button class="action-btn delete-btn del" data-id="${p.id}">刪除</button>
          </td>
        </tr>`;
      }).join('');
    }

    function escape(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    searchInput.oninput = renderList; sortSelect.onchange = renderList;

    // 新增 / 編輯 / 複製
    addBtn.onclick = ()=>openForm('add');
    tbody.addEventListener('click', e=>{
      const id = e.target.getAttribute('data-id');
      if (!id) return;
      const p = products.find(x=>x.id===id);
      if (e.target.classList.contains('edit')) openForm('edit', p);
      if (e.target.classList.contains('copy')) openForm('copy', p);
      if (e.target.classList.contains('del')) removeProduct(p);
    });

    function openForm(mode, p){
      formMode = mode; editingId = null; formErr.textContent=''; images=[]; imagesToRemove=[]; imageInput.value=''; preview.innerHTML='';
      if (mode==='add'){ formTitle.textContent='新增商品'; form.reset(); }
      if ((mode==='edit' || mode==='copy') && p){
        formTitle.textContent = mode==='edit' ? '編輯商品' : '新增商品（複製）';
        document.getElementById('name').value = p.name||'';
        document.getElementById('product_id').value = mode==='copy' ? ((p.product_id||'')+ '-new') : (p.product_id||'');
        document.getElementById('price').value = p.price ?? '';
        document.getElementById('category').value = p.category||'';
        document.getElementById('status').value = p.status||'';
        document.getElementById('arrival_time').value = p.arrival_time||'';
        document.getElementById('eta_text').value = p.eta||''; // 後台寫入欄位：eta
        document.getElementById('tags').value = p.tags||'';
        // 載入已存在圖片
        (p.images||[]).forEach(path=>{
          const { data } = sb.storage.from('yuyu.f86').getPublicUrl(path);
          images.push({ file:null, path, url:data.publicUrl });
        });
        editingId = mode==='edit' ? p.id : null;
        renderPreviews();
      }
      modal.style.display='flex';
    }

    function closeForm(){ modal.style.display='none'; formErr.textContent=''; images.forEach(i=>{ if(i.file && i.url) URL.revokeObjectURL(i.url); }); images=[]; imagesToRemove=[]; editingId=null; formMode='add'; form.reset(); }
    cancelBtn.onclick = closeForm;

    function renderPreviews(){
      preview.innerHTML='';
      images.forEach((it,idx)=>{
        const wrap=document.createElement('div'); wrap.className='img-item';
        const img=document.createElement('img'); img.src=it.url; wrap.appendChild(img);
        const btn=document.createElement('button'); btn.className='remove-btn'; btn.type='button'; btn.textContent='×';
        btn.onclick=()=>{ const rem=images.splice(idx,1)[0]; if(formMode==='edit' && rem && !rem.file && rem.path) imagesToRemove.push(rem.path); renderPreviews(); };
        wrap.appendChild(btn); preview.appendChild(wrap);
      });
      Sortable.create(preview,{ animation:150, onEnd:e=>{ const x=images.splice(e.oldIndex,1)[0]; images.splice(e.newIndex,0,x); renderPreviews(); }});
    }

    imageInput.onchange = ()=>{
      Array.from(imageInput.files||[]).forEach(file=>{ const url=URL.createObjectURL(file); images.push({ file, url }); });
      imageInput.value=''; renderPreviews();
    };

    form.onsubmit = async (ev)=>{
      ev.preventDefault(); formErr.textContent=''; saveBtn.disabled=true; cancelBtn.disabled=true; saveBtn.textContent='儲存中...';
      try{
        const row = collectRow();
        // 上傳新圖片
        const uploaded=[];
        for (const it of images){
          if (!it.file) continue;
          const ext = (it.file.name.split('.').pop()||'jpg').toLowerCase();
          const fp = `${row.product_id}/${Date.now()}_${Math.random().toString(36).slice(2,7)}.${ext}`;
          const { error } = await sb.storage.from('yuyu.f86').upload(fp, it.file, { upsert:false });
          if (error){ if(uploaded.length) await sb.storage.from('yuyu.f86').remove(uploaded); throw error; }
          it.path = fp; uploaded.push(fp);
        }
        const paths = images.map(i=>i.path).filter(Boolean);
        // 第一張做封面 URL
        let img_url = null; if (paths[0]){ const { data } = sb.storage.from('yuyu.f86').getPublicUrl(paths[0]); img_url = data.publicUrl; }
        row.images = paths; row.img_url = img_url; // 同前台欄位

        let error;
        if (formMode==='add' || formMode==='copy'){
          ({ error } = await sb.from('products').insert(row));
        } else if (formMode==='edit' && editingId){
          ({ error } = await sb.from('products').update(row).eq('id', editingId));
          // 刪除移除的舊圖
          if (imagesToRemove.length) await sb.storage.from('yuyu.f86').remove(imagesToRemove);
        }
        if (error) throw error;
        await loadProducts(); closeForm();
      }catch(e){ formErr.textContent='儲存失敗：' + (e?.message||e); }
      finally{ saveBtn.disabled=false; cancelBtn.disabled=false; saveBtn.textContent='儲存'; }
    };

    function collectRow(){
      const name = document.getElementById('name').value.trim();
      const product_id = document.getElementById('product_id').value.trim();
      const price = document.getElementById('price').value;
      const category = document.getElementById('category').value.trim()||null;
      const status = document.getElementById('status').value.trim()||null;
      const arrival_time = document.getElementById('arrival_time').value.trim()||null;
      const eta = document.getElementById('eta_text').value.trim()||null; // ← 資料表欄位為 eta
      const tags = (document.getElementById('tags').value||'').split('|').map(s=>s.trim()).filter(Boolean).join('|'); // 後台統一存字串
      if (!name || !product_id || price==='') throw new Error('請填寫必填欄位');
      return { name, product_id, price: Number(price), category, status, arrival_time, eta, tags };
    }

    async function removeProduct(p){
      if (!p) return; if (!confirm(`確定刪除「${p.name}」？`)) return;
      const { error } = await sb.from('products').delete().eq('id', p.id);
      if (error) return alert('刪除失敗：'+error.message);
      // 刪除圖片
      const paths = (p.images||[]); if (paths.length) await sb.storage.from('yuyu.f86').remove(paths);
      await loadProducts();
    }
  </script>
</body>
</html>
